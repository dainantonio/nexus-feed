<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="NEXUS INTEL - Advanced Market Intelligence Terminal. Real-time simulated trading, AI analysis, and level 2 market data.">
    <meta name="author" content="Nexus Systems">
    
    <!-- Open Graph / Social Sharing -->
    <meta property="og:title" content="NEXUS INTEL | Market Terminal">
    <meta property="og:description" content="AI-Driven Market Intelligence. Trade stocks, crypto, and analyze data in a high-fidelity cyberpunk environment.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://images.unsplash.com/photo-1642543492481-44e81e3914a7?q=80&w=1200&auto=format&fit=crop">
    
    <!-- Mobile Web App -->
    <meta name="theme-color" content="#050507">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Dynamic Favicon (Matches Logo: Aperture Icon on Neon Gradient) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%2300ff9d'/><stop offset='1' stop-color='%2300f0ff'/></linearGradient></defs><rect width='24' height='24' rx='6' fill='url(%23g)'/><g transform='scale(0.75) translate(4,4)' stroke='%23000' stroke-width='2.5' fill='none' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='10'/><line x1='14.31' y1='8' x2='20.05' y2='17.94'/><line x1='9.69' y1='8' x2='21.17' y2='8'/><line x1='7.38' y1='12' x2='13.12' y2='2.06'/><line x1='9.69' y1='16' x2='3.95' y2='6.06'/><line x1='14.31' y1='16' x2='2.83' y2='16'/><line x1='16.62' y1='12' x2='10.88' y2='21.94'/></g></svg>">

    <title>NEXUS INTEL | v9.4 GOLD</title>
    
    <!-- External Dependencies -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        /* ===== CORE VARIABLES (Default: Cyberpunk) ===== */
        :root {
            /* Base Colors */
            --bg-dark: #050507;
            --bg-panel: rgba(14, 14, 18, 0.95);
            --bg-card: rgba(21, 21, 27, 0.85);
            --border-color: rgba(42, 42, 53, 0.6);
            
            /* Accents */
            --neon-green: #00ff9d;
            --neon-blue: #00f0ff;
            --neon-red: #ff2a6d;
            --neon-purple: #bc13fe;
            --neon-amber: #ffb800;
            --neon-cyan: #00f7ff;
            
            /* Text */
            --text-main: rgba(255, 255, 255, 0.95);
            --text-muted: rgba(136, 136, 153, 0.8);
            
            /* Fonts */
            --font-main: 'Inter', system-ui, -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
            
            /* FX */
            --glass-bg: rgba(30, 30, 40, 0.25);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.36);
            --scanline-opacity: 0.03;
            --glow-strength: 0 0 20px;
        }

        /* ===== THEMES ===== */
        
        /* Solarpunk (Light/Gold/Green) */
        body.theme-solarpunk {
            --bg-dark: #f0f4f8;
            --bg-panel: rgba(255, 255, 255, 0.95);
            --bg-card: rgba(255, 255, 255, 0.85);
            --border-color: rgba(0, 0, 0, 0.1);
            
            --neon-green: #059669;
            --neon-blue: #0284c7;
            --neon-red: #dc2626;
            --neon-purple: #7c3aed;
            --neon-amber: #d97706;
            --neon-cyan: #0891b2;
            
            --text-main: #111827;
            --text-muted: #6b7280;
            
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(0, 0, 0, 0.05);
            --glass-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --scanline-opacity: 0.0;
        }

        /* Corporate (Dark/Blue/Clean) */
        body.theme-corporate {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --bg-card: #334155;
            --border-color: #475569;
            
            --neon-green: #34d399;
            --neon-blue: #38bdf8;
            --neon-red: #f87171;
            --neon-purple: #a78bfa;
            --neon-amber: #fbbf24;
            --neon-cyan: #22d3ee;
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.05);
            --scanline-opacity: 0.0;
        }

        /* ===== RESET & BASE ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background 0.3s, color 0.3s;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 255, 157, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 240, 255, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 50% 50%, rgba(188, 19, 254, 0.02) 0%, transparent 30%);
        }
        
        /* Shake Animation */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-active { animation: shake 0.5s; animation-iteration-count: 1; }
        
        .flash-alert {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 42, 109, 0.15);
            z-index: 9998; pointer-events: none;
            display: none;
            box-shadow: inset 0 0 100px var(--neon-red);
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap');

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.02); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--neon-green), var(--neon-blue)); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, var(--neon-amber), var(--neon-purple)); }

        .mono { font-family: var(--font-mono); letter-spacing: -0.02em; }
        .text-green { color: var(--neon-green); }
        .text-red { color: var(--neon-red); }
        .text-blue { color: var(--neon-blue); }
        .text-purple { color: var(--neon-purple); }
        .text-amber { color: var(--neon-amber); }
        .text-cyan { color: var(--neon-cyan); }
        .text-muted { color: var(--text-muted); }
        
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }
        
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }

        .app-grid {
            display: grid;
            grid-template-columns: 280px 1fr 340px;
            grid-template-rows: 1fr;
            height: calc(100vh - 105px);
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.zen-mode .app-grid { grid-template-columns: 0 1fr 0; }
        body.zen-mode .sidebar { display: none; }
        body.zen-mode .feed-container { padding: 2rem 15%; }
        @media (max-width: 1200px) { .app-grid { grid-template-columns: 240px 1fr 0; } .sidebar-right { display: none; } }
        @media (max-width: 768px) { .app-grid { grid-template-columns: 0 1fr 0; height: calc(100vh - 140px); } }

        .header {
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            display: flex; align-items: center; justify-content: space-between;
            backdrop-filter: blur(20px) saturate(200%);
            -webkit-backdrop-filter: blur(20px) saturate(200%);
            z-index: 50; position: relative; overflow: hidden;
            height: 60px; min-height: 60px;
        }
        .header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, var(--neon-green), var(--neon-blue), var(--neon-purple), transparent);
            animation: scan 4s linear infinite;
        }
        @keyframes scan { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        .logo { display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 1.25rem; letter-spacing: -0.05em; min-width: 200px; cursor: pointer; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--neon-green), var(--neon-blue)); color: #000; display: flex; align-items: center; justify-content: center; border-radius: 8px; box-shadow: 0 0 20px var(--neon-green); transition: all 0.3s; }
        .logo-icon:hover { transform: rotate(15deg); box-shadow: 0 0 30px var(--neon-green); }

        .search-bar { background: rgba(255,255,255,0.07); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 16px; display: flex; align-items: center; gap: 10px; width: 300px; transition: all 0.3s; flex-shrink: 0; }
        .search-bar:focus-within { border-color: var(--neon-green); box-shadow: 0 0 20px var(--neon-green); }
        .search-bar input { background: transparent; border: none; color: var(--text-main); font-family: var(--font-mono); outline: none; width: 100%; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 0.05em; }

        .header-controls { display: flex; gap: 12px; align-items: center; flex-wrap: nowrap; min-width: 300px; justify-content: flex-end; }
        .icon-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); width: 36px; height: 36px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; position: relative; overflow: hidden; flex-shrink: 0; }
        .icon-btn:hover, .icon-btn.active { border-color: var(--neon-green); color: var(--neon-green); box-shadow: 0 0 15px var(--neon-green); transform: translateY(-2px); }

        .audio-visualizer { display: flex; align-items: center; gap: 3px; height: 20px; margin-right: 10px; flex-shrink: 0; }
        .visualizer-bar { width: 3px; background: linear-gradient(to top, var(--neon-green), var(--neon-cyan)); border-radius: 2px; transition: height 0.1s ease; animation: visualizerPulse 1.5s ease-in-out infinite; animation-delay: calc(var(--i) * 0.1s); }
        @keyframes visualizerPulse { 0%, 100% { height: 5px; opacity: 0.5; } 50% { height: 15px; opacity: 1; } }

        .ticker-container { background: var(--bg-panel); border-bottom: 1px solid var(--border-color); height: 45px; min-height: 45px; overflow: hidden; display: flex; align-items: center; position: relative; backdrop-filter: blur(10px); }
        .ticker-track { display: flex; animation: scroll 80s linear infinite; white-space: nowrap; padding-left: 100%; }
        .ticker-item { padding: 0 1.5rem; font-size: 0.85rem; display: flex; align-items: center; gap: 10px; border-right: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; font-family: var(--font-mono); flex-shrink: 0; }
        .ticker-item:hover { background: rgba(255,255,255,0.05); }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .sidebar { background: var(--bg-panel); border-right: 1px solid var(--border-color); padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.5rem; backdrop-filter: blur(10px); height: 100%; }
        .sidebar-right { border-right: none; border-left: 1px solid var(--border-color); }
        .section-title { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 1rem; display: flex; align-items: center; gap: 10px; font-weight: 700; font-family: var(--font-mono); padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }

        .chart-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem; position: relative; box-shadow: var(--glass-shadow); display: flex; flex-direction: column; backdrop-filter: blur(10px); overflow: hidden; }
        .chart-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1rem; padding-bottom: 1rem; padding-right: 36px; border-bottom: 1px solid var(--border-color); position: relative; }
        .chart-controls { display: flex; gap: 8px; margin-top: 5px; flex-wrap: wrap; }
        .chart-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: var(--text-muted); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-family: var(--font-mono); transition: all 0.2s; display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
        .chart-btn:hover, .chart-btn.active { background: rgba(0,255,157,0.1); color: var(--neon-green); border-color: var(--neon-green); box-shadow: 0 0 15px rgba(0, 255, 157, 0.2); }
        .chart-expand-btn { position: absolute; top: 0; right: 0; background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); border-radius: 4px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .chart-expand-btn:hover { color: var(--text-main); border-color: var(--neon-green); background: rgba(255,255,255,0.05); }
        
        #mainChart { min-height: 220px; flex-grow: 1; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-family: var(--font-mono); font-size: 0.8rem; }
        #rsiChart { min-height: 100px; height: 100px; margin-top: 10px; border-top: 1px solid var(--border-color); }

        .symbol-title { font-size: 1.5rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.03em; }
        .current-price { font-size: 1.5rem; font-weight: 800; color: var(--neon-green); font-family: var(--font-mono); letter-spacing: -0.02em; }

        .feed-container { padding: 1.5rem; overflow-y: auto; background: var(--bg-dark); display: flex; flex-direction: column; height: 100%; }
        .brief-panel { background: rgba(255, 184, 0, 0.07); border: 1px solid rgba(255, 184, 0, 0.15); border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); backdrop-filter: blur(10px); }
        .brief-panel-header { padding: 14px 18px; background: rgba(255, 184, 0, 0.1); border-bottom: 1px solid rgba(255, 184, 0, 0.1); display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-family: var(--font-mono); font-size: 0.85rem; color: var(--neon-amber); font-weight: 700; letter-spacing: 0.05em; transition: all 0.3s; }
        .brief-panel-header:hover { background: rgba(255, 184, 0, 0.15); }
        .brief-panel-content { padding: 18px; display: flex; flex-direction: column; gap: 14px; max-height: 500px; transition: max-height 0.4s ease, padding 0.4s ease, opacity 0.4s ease; opacity: 1; }
        .brief-panel.collapsed .brief-panel-content { max-height: 0; padding-top: 0; padding-bottom: 0; opacity: 0; overflow: hidden; }
        .brief-panel.collapsed .brief-panel-header { border-bottom: none; }

        .tldr-item { display: flex; gap: 14px; padding: 14px; border-radius: 8px; background: rgba(0, 0, 0, 0.2); transition: all 0.3s; cursor: pointer; border: 1px solid transparent; }
        .tldr-item:hover { border-color: rgba(255, 184, 0, 0.3); background: rgba(255, 184, 0, 0.05); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 184, 0, 0.1); }
        .tldr-rank { font-size: 1.2rem; font-weight: 800; color: rgba(255,255,255,0.2); font-family: var(--font-mono); min-width: 40px; flex-shrink: 0; }
        .tldr-text h4 { font-size: 0.95rem; margin-bottom: 6px; color: var(--text-main); font-weight: 600; line-height: 1.4; word-break: break-word; }
        .tldr-meta { font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono); display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

        .synth-btn { background: rgba(255,184,0,0.15); border: 1px solid var(--neon-amber); color: var(--neon-amber); font-size: 0.75rem; font-family: var(--font-mono); padding: 6px 14px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; font-weight: 600; letter-spacing: 0.05em; flex-shrink: 0; white-space: nowrap; }
        .synth-btn:hover { background: var(--neon-amber); color: #000; box-shadow: 0 0 20px rgba(255, 184, 0, 0.4); transform: translateY(-2px); }

        .feed-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 1rem; }
        .feed-tabs { display: flex; gap: 16px; overflow-x: auto; align-items: center; padding: 20px 4px; margin-bottom: 0.5rem; scrollbar-width: none; }
        .feed-tabs::-webkit-scrollbar { display: none; }
        .feed-tab { background: rgba(255,255,255,0.05); border: 1px solid transparent; padding: 8px 16px; border-radius: 8px; color: var(--text-muted); font-size: 0.8rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.3s; font-family: var(--font-mono); letter-spacing: 0.05em; flex-shrink: 0; }
        .feed-tab:hover { color: var(--text-main); background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .feed-tab.active { background: rgba(0,255,157,0.1); color: var(--neon-green); border-color: var(--neon-green); box-shadow: 0 0 15px rgba(0, 255, 157, 0.2); }

        .refresh-btn { margin-left: auto; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: var(--text-muted); width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; flex-shrink: 0; }
        .refresh-btn:hover { color: var(--neon-green); border-color: var(--neon-green); box-shadow: 0 0 15px rgba(0, 255, 157, 0.3); transform: rotate(180deg); }

        .view-toggle { display: flex; gap: 8px; margin-left: 10px; border-left: 1px solid var(--border-color); padding-left: 10px; flex-shrink: 0; }

        #newsFeed { width: 100%; box-sizing: border-box; display: block; }
        #newsFeed.grid-view { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        #newsFeed.grid-view .news-card { height: 100%; margin-bottom: 0; }

        .news-card { background: var(--bg-card); border: 1px solid var(--border-color); border-left-width: 5px; border-radius: 16px; padding: 1.75rem; margin-bottom: 1.5rem; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; backdrop-filter: blur(15px) saturate(180%); box-shadow: var(--glass-shadow); }
        .news-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); }
        .news-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 30px var(--neon-green); border-color: var(--border-color); }
        .news-card.bullish { border-left-color: var(--neon-green); background: linear-gradient(145deg, rgba(0, 255, 157, 0.05) 0%, rgba(30, 30, 35, 0.85) 100%); }
        .news-card.bearish { border-left-color: var(--neon-red); background: linear-gradient(145deg, rgba(255, 42, 109, 0.05) 0%, rgba(30, 30, 35, 0.85) 100%); }
        .news-card.neutral { border-left-color: var(--border-color); background: linear-gradient(145deg, rgba(255, 255, 255, 0.02) 0%, rgba(30, 30, 35, 0.85) 100%); }
        .news-headline { font-size: 1.15rem; font-weight: 700; line-height: 1.5; margin-bottom: 1rem; color: var(--text-main); cursor: pointer; letter-spacing: -0.01em; word-break: break-word; }
        .news-headline:hover { color: var(--neon-green); text-shadow: 0 0 10px rgba(0, 255, 157, 0.3); }
        .news-summary { font-size: 0.95rem; color: var(--text-muted); line-height: 1.7; margin-bottom: 1.25rem; font-weight: 400; word-break: break-word; }

        .ai-summary-box { background: linear-gradient(90deg, rgba(188, 19, 254, 0.05), rgba(0, 240, 255, 0.05)); border-left: 3px solid var(--neon-purple); padding: 1.25rem; margin-top: 1.25rem; font-size: 0.9rem; color: var(--text-muted); display: none; border-radius: 8px; animation: fadeIn 0.4s ease; font-family: var(--font-mono); line-height: 1.6; }
        .ai-summary-box.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }

        .analyze-btn { background: transparent; border: 1px solid var(--neon-purple); color: var(--neon-purple); padding: 8px 16px; font-size: 0.75rem; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-family: var(--font-mono); font-weight: 600; letter-spacing: 0.05em; transition: all 0.3s; flex-shrink: 0; }
        .analyze-btn:hover { background: var(--neon-purple); color: #000; box-shadow: 0 0 20px rgba(188, 19, 254, 0.4); transform: translateY(-2px); }

        .voice-play-btn { background: rgba(0, 240, 255, 0.1); border: 1px solid var(--neon-cyan); color: var(--neon-cyan); padding: 8px 16px; font-size: 0.75rem; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-family: var(--font-mono); font-weight: 600; letter-spacing: 0.05em; transition: all 0.3s; margin-left: 8px; flex-shrink: 0; }
        .voice-play-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 20px rgba(0, 240, 255, 0.4); transform: translateY(-2px); }
        .voice-play-btn.playing { background: var(--neon-red); border-color: var(--neon-red); color: #000; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(255, 42, 109, 0.7); } 50% { box-shadow: 0 0 0 10px rgba(255, 42, 109, 0); } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.4s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal { background: var(--bg-card); border: 1px solid var(--border-color); width: 520px; max-width: 90vw; padding: 2rem; border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.5), 0 0 50px rgba(0,255,157,0.1); max-height: 85vh; overflow-y: auto; backdrop-filter: blur(20px); }
        .modal-section-title { font-size: 0.75rem; color: var(--neon-green); text-transform: uppercase; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; font-family: var(--font-mono); letter-spacing: 0.1em; font-weight: 700; }

        .form-group { margin-bottom: 1.25rem; }
        .form-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; display: block; font-family: var(--font-mono); }
        .form-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); padding: 12px; color: var(--text-main); border-radius: 8px; font-family: var(--font-mono); font-size: 0.9rem; transition: all 0.3s; }
        .form-input:focus { border-color: var(--neon-green); box-shadow: 0 0 20px rgba(0, 255, 157, 0.2); outline: none; }

        .toggle-container { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .toggle-label { font-size: 0.9rem; color: var(--text-muted); font-family: var(--font-mono); flex-grow: 1; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 24px; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--neon-green); }
        input:checked + .toggle-slider:before { transform: translateX(26px); }

        .chat-container { display: flex; flex-direction: column; height: 400px; }
        .chat-history { flex-grow: 1; overflow-y: auto; padding: 1rem; border: 1px solid var(--border-color); margin-bottom: 1rem; background: rgba(0,0,0,0.3); border-radius: 12px; }
        .chat-message { margin-bottom: 1rem; font-size: 0.9rem; line-height: 1.5; display: flex; flex-direction: column; }
        .chat-message.user { align-items: flex-end; }
        .chat-message.ai { align-items: flex-start; color: var(--neon-green); }
        .chat-bubble { padding: 12px 16px; border-radius: 12px; max-width: 85%; backdrop-filter: blur(10px); }
        .chat-message.user .chat-bubble { background: rgba(0,240,255,0.15); border: 1px solid rgba(0,240,255,0.3); color: #fff; }
        .chat-message.ai .chat-bubble { background: rgba(0,255,157,0.1); border: 1px solid rgba(0,255,157,0.2); font-family: var(--font-mono); color: var(--text-main); }
        .chat-input-area { display: flex; gap: 12px; }

        .scanline { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.3) 51%); background-size: 100% 6px; pointer-events: none; z-index: 999; opacity: var(--scanline-opacity); animation: scanlineMove 20s linear infinite; }
        @keyframes scanlineMove { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }

        .profile-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; backdrop-filter: blur(10px); overflow: hidden; }
        .profile-logo { width: 48px; height: 48px; border-radius: 10px; background: #fff; object-fit: contain; padding: 4px; border: 1px solid var(--border-color); flex-shrink: 0; }
        .profile-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
        .p-stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-family: var(--font-mono); letter-spacing: 0.05em; }
        .p-stat-val { font-size: 0.85rem; font-weight: 600; font-family: var(--font-mono); color: var(--neon-green); }

        .portfolio-widget { background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem; margin-bottom: 2rem; border-left: 3px solid var(--neon-blue); }
        .portfolio-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .portfolio-title { font-size: 0.8rem; font-weight: 700; color: var(--neon-blue); letter-spacing: 0.1em; font-family: var(--font-mono); }
        .portfolio-balance { font-size: 1.4rem; font-weight: 800; color: #fff; letter-spacing: -0.02em; }
        .portfolio-pnl { font-size: 0.9rem; font-family: var(--font-mono); font-weight: 600; }
        .portfolio-pnl.positive { color: var(--neon-green); }
        .portfolio-pnl.negative { color: var(--neon-red); }
        .holding-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem; }
        .holding-item:last-child { border-bottom: none; }
        
        .xp-bar-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 10px; overflow: hidden; position: relative; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--neon-purple), var(--neon-blue)); width: 0%; transition: width 0.5s ease; box-shadow: 0 0 10px var(--neon-blue); }
        .rank-badge { font-size: 0.65rem; color: var(--text-muted); font-family: var(--font-mono); text-transform: uppercase; margin-top: 4px; display: flex; justify-content: space-between; }

        .trade-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; margin-bottom: 1.5rem; }
        .trade-btn { border: none; padding: 14px; border-radius: 8px; font-weight: 800; cursor: pointer; font-family: var(--font-mono); font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; color: #000; }
        .btn-buy { background: var(--neon-green); box-shadow: 0 0 15px rgba(0, 255, 157, 0.3); }
        .btn-buy:hover { transform: translateY(-2px); box-shadow: 0 0 25px rgba(0, 255, 157, 0.5); }
        .btn-buy:active { transform: translateY(1px); }
        .btn-sell { background: var(--neon-red); box-shadow: 0 0 15px rgba(255, 42, 109, 0.3); }
        .btn-sell:hover { transform: translateY(-2px); box-shadow: 0 0 25px rgba(255, 42, 109, 0.5); }
        .btn-sell:active { transform: translateY(1px); }
        
        .bot-control { margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; background: rgba(188, 19, 254, 0.1); padding: 10px; border: 1px solid var(--neon-purple); border-radius: 8px; }
        .bot-status { font-family: var(--font-mono); font-size: 0.8rem; color: var(--neon-purple); font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .bot-active-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; transition: all 0.3s; }
        .bot-active-dot.active { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 6000; display: flex; flex-direction: column; gap: 12px; }
        .toast { background: var(--bg-card); border: 1px solid var(--neon-green); padding: 1rem 1.5rem; border-radius: 8px; color: var(--text-main); font-family: var(--font-mono); font-size: 0.85rem; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; backdrop-filter: blur(10px); max-width: 350px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .voice-controls { position: fixed; bottom: 24px; left: 24px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-start; gap: 12px; }
        .voice-btn { width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, var(--neon-blue), var(--neon-cyan)); border: none; color: #000; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 30px var(--neon-blue), 0 0 60px rgba(0, 240, 255, 0.3); transition: all 0.3s; font-size: 1.5rem; position: relative; overflow: hidden; }
        .voice-btn::after { content: ''; position: absolute; top: -10px; left: -10px; right: -10px; bottom: -10px; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent); z-index: -1; animation: rotate 3s linear infinite; }
        @keyframes rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .voice-btn.listening { background: linear-gradient(135deg, var(--neon-red), #ff6b9d); box-shadow: 0 0 40px var(--neon-red), 0 0 80px rgba(255, 42, 109, 0.4); animation: pulseScale 1.5s infinite; }
        @keyframes pulseScale { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .voice-command-display { position: relative; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(20px); border: 1px solid var(--neon-blue); padding: 1rem 1.25rem; border-radius: 12px; max-width: 320px; min-width: 240px; opacity: 0; transform: translateY(10px); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 30px rgba(0, 240, 255, 0.2); }
        .voice-command-display.show { opacity: 1; transform: translateY(0); }
        .voice-command-text { font-family: var(--font-mono); font-size: 0.9rem; margin-bottom: 6px; color: var(--neon-cyan); font-weight: 600; }
        .voice-command-hint { font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono); }

        .voice-command-list { position: fixed; top: 105px; right: 24px; background: var(--bg-panel); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: 16px; max-width: 320px; max-height: 480px; overflow-y: auto; backdrop-filter: blur(20px); opacity: 0; pointer-events: none; transition: opacity 0.4s; z-index: 1000; box-shadow: var(--glass-shadow); }
        .voice-command-list.show { opacity: 1; pointer-events: all; }
        .voice-command-list h4 { color: var(--neon-green); margin-bottom: 1rem; font-size: 0.9rem; font-family: var(--font-mono); display: flex; align-items: center; gap: 8px; }
        .voice-command-item { margin-bottom: 8px; font-size: 0.8rem; padding: 8px 10px; border-radius: 6px; background: rgba(255,255,255,0.05); border-left: 3px solid var(--neon-blue); font-family: var(--font-mono); transition: all 0.3s; }
        .voice-command-item:hover { background: rgba(255,255,255,0.1); transform: translateX(4px); }
        .voice-hotkey { position: absolute; top: 12px; right: 12px; font-size: 0.7rem; color: var(--text-muted); background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-family: var(--font-mono); }

        #bootScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--neon-green); font-family: var(--font-mono); transition: opacity 0.5s; pointer-events: none; }
        .boot-log { font-size: 0.8rem; opacity: 0.7; margin-bottom: 5px; }
        .boot-loader { width: 200px; height: 2px; background: #222; margin-top: 20px; position: relative; overflow: hidden; }
        .boot-loader::after { content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 50%; background: var(--neon-green); animation: bootLoad 1.5s ease-in-out infinite; }
        @keyframes bootLoad { 0% { left: -50%; } 100% { left: 100%; } }

        .executive-briefing-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); color: var(--text-muted); font-family: var(--font-mono); font-weight: 600; padding: 8px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.75rem; letter-spacing: 0.05em; transition: all 0.3s; flex-shrink: 0; white-space: nowrap; }
        .executive-briefing-btn:hover { background: rgba(255, 255, 255, 0.1); border-color: var(--neon-purple); color: var(--neon-purple); transform: translateY(-1px); }
        .executive-briefing-btn.playing { background: rgba(255, 42, 109, 0.1); border-color: var(--neon-red); color: var(--neon-red); animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0%, 100% { border-color: var(--neon-red); box-shadow: 0 0 10px rgba(255, 42, 109, 0.2); } 50% { border-color: rgba(255, 42, 109, 0.5); box-shadow: 0 0 20px rgba(255, 42, 109, 0.4); } }

        /* ===== ORDER BOOK & WHALE WATCHER ===== */
        .order-book-container { margin-top: 1.5rem; border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; background: rgba(0,0,0,0.3); }
        .ob-header { background: rgba(255,255,255,0.05); padding: 8px 12px; font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-muted); display: flex; justify-content: space-between; font-weight: 700; border-bottom: 1px solid var(--border-color); }
        .ob-row { display: flex; justify-content: space-between; padding: 4px 12px; font-family: var(--font-mono); font-size: 0.7rem; position: relative; height: 20px; align-items: center; }
        .ob-row.ask { color: var(--neon-red); }
        .ob-row.bid { color: var(--neon-green); }
        .ob-bar { position: absolute; top: 2px; bottom: 2px; opacity: 0.2; transition: width 0.2s; z-index: 0; }
        .ob-bar.ask { right: 0; background: var(--neon-red); }
        .ob-bar.bid { left: 0; background: var(--neon-green); }
        .ob-price, .ob-size { z-index: 1; }
        
        .whale-alert-box { 
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%); 
            background: rgba(0, 0, 0, 0.9); border: 1px solid var(--neon-amber); 
            padding: 10px 20px; border-radius: 8px; color: var(--neon-amber); 
            font-family: var(--font-mono); font-weight: 700; font-size: 0.8rem;
            display: flex; align-items: center; gap: 10px; z-index: 1000;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
            box-shadow: 0 0 20px rgba(255, 184, 0, 0.2);
        }
        .whale-alert-box.active { opacity: 1; animation: pulse-alert 2s infinite; }
        @keyframes pulse-alert { 0% { box-shadow: 0 0 10px rgba(255,184,0,0.2); } 50% { box-shadow: 0 0 25px rgba(255,184,0,0.6); } }

        /* RESPONSIVE */
        @media (max-width: 1024px) { .header-controls { min-width: auto; } .search-bar { width: 200px; } .executive-briefing-btn { padding: 6px 10px; font-size: 0.7rem; } }
        @media (max-width: 768px) { .header { flex-wrap: wrap; height: auto; min-height: auto; padding: 1rem; gap: 1rem; } .logo { min-width: auto; } .search-bar { width: 100%; order: 3; } .header-controls { min-width: auto; width: 100%; justify-content: space-between; } .executive-briefing-btn { display: none; } .ticker-container { height: 35px; min-height: 35px; } .feed-tabs { padding-bottom: 8px; } .voice-controls { bottom: 10px; left: 10px; } .voice-btn { width: 50px; height: 50px; font-size: 1.2rem; } }
        @media (max-width: 480px) { .modal { padding: 1.5rem; } .email-controls { flex-direction: column; } .email-controls button { width: 100%; } }
    </style>
</head>
<body class="theme-cyberpunk">

    <!-- BOOT SCREEN -->
    <div id="bootScreen">
        <div class="logo" style="margin-bottom: 2rem;">
            <div class="logo-icon"><i data-lucide="aperture"></i></div>
            <div style="font-size: 2rem; margin-left: 1rem;">NEXUS <span class="text-green">INTEL</span></div>
        </div>
        <div id="bootLog" style="display: flex; flex-direction: column; align-items: center;"></div>
        <div class="boot-loader"></div>
    </div>
    
    <!-- TOUR OVERLAY -->
    <div class="tour-overlay" id="tourOverlay">
        <div class="highlight-box" id="tourHighlight"></div>
        <div class="tour-card" id="tourCard">
            <div class="tour-title" id="tourTitle">WELCOME</div>
            <div class="tour-text" id="tourText">Let's get you set up with the NEXUS INTEL system.</div>
            <div style="display:flex; justify-content:space-between;">
                <button class="tour-btn" style="background:transparent; color:var(--text-muted); border:1px solid var(--border-color);" onclick="app.endTour()">SKIP</button>
                <button class="tour-btn" onclick="app.nextTourStep()">NEXT</button>
            </div>
        </div>
    </div>
    
    <!-- FLASH ALERT OVERLAY -->
    <div class="flash-alert" id="flashAlert"></div>
    
    <!-- WHALE ALERT -->
    <div class="whale-alert-box" id="whaleAlert">
        <i data-lucide="alert-circle"></i>
        <span>WHALE DETECTED: LARGE VOLUME SPIKE</span>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="flex justify-between items-center" style="margin-bottom: 24px;">
                <h3 class="mono text-green">SYSTEM CONFIGURATION v9.4</h3>
                <button class="icon-btn" onclick="app.toggleSettings()"><i data-lucide="x"></i></button>
            </div>
            
            <div class="modal-section-title">VISUAL THEME</div>
            <div class="form-group">
                 <select id="themeSelector" class="form-input" onchange="app.setTheme(this.value)">
                     <option value="theme-cyberpunk">CYBERPUNK (Default)</option>
                     <option value="theme-solarpunk">SOLARPUNK (Light/Gold)</option>
                     <option value="theme-corporate">CORPORATE (Clean/Dark)</option>
                 </select>
            </div>
            
            <div class="modal-section-title">DATA KEYS</div>
            <div class="form-group">
                <label class="form-label">FINNHUB API KEY (Primary Data)</label>
                <input type="password" id="finnhubKey" class="form-input" value="d5e7311r01qjckl29au0d5e7311r01qjckl29aug">
            </div>
            <div class="form-group">
                <label class="form-label">GEMINI API KEY (AI Intelligence)</label>
                <input type="password" id="geminiKey" class="form-input" placeholder="Enter Google Gemini API Key...">
            </div>

            <div class="modal-section-title" style="margin-top: 24px;">AUDIO & ALERTS</div>
            
            <div class="toggle-container">
                <span class="toggle-label">SYSTEM SOUNDS & ALARMS</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="soundEffectsToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="toggle-container">
                <span class="toggle-label">VOICE ANNOUNCEMENTS</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="voiceAlertsToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="modal-section-title" style="margin-top: 24px;">DAILY NEWSLETTER</div>
            <div class="form-group">
                <label class="form-label">EMAIL RECIPIENT (6PM Daily Digest)</label>
                <input type="email" id="newsletterEmail" class="form-input" placeholder="analyst@nexus-intel.com">
            </div>
            <div class="toggle-container">
                <span class="toggle-label">AUTO-GENERATE DAILY DIGEST</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoNewsletterToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

             <div class="modal-section-title" style="margin-top: 24px;">DEBUG & MAINTENANCE</div>
             <button onclick="app.clearCache()" style="width: 100%; padding: 12px; background: rgba(255, 42, 109, 0.2); border: 1px solid var(--neon-red); color: var(--neon-red); font-family: var(--font-mono); cursor: pointer; margin-bottom: 12px; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s;">
                 <i data-lucide="trash-2" width="16"></i> PURGE CACHE & RELOAD
             </button>
            <button onclick="app.saveSettings()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, var(--neon-green), var(--neon-blue)); border: none; font-weight: 700; color: #000; cursor: pointer; border-radius: 8px; margin-top: 12px; font-family: var(--font-mono); font-size: 0.9rem; letter-spacing: 0.05em; transition: all 0.3s;">
                SAVE CONFIGURATION
            </button>
        </div>
    </div>
    
    <!-- TRANSACTION HISTORY MODAL -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal">
            <div class="flex justify-between items-center" style="margin-bottom: 24px;">
                <h3 class="mono text-blue"><i data-lucide="history"></i> TRADE LEDGER</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="icon-btn" onclick="portfolio.downloadHistory()" title="Download CSV"><i data-lucide="download"></i></button>
                    <button class="icon-btn" onclick="document.getElementById('historyModal').classList.remove('open')"><i data-lucide="x"></i></button>
                </div>
            </div>
            <div id="transactionList" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Logs injected here -->
            </div>
        </div>
    </div>

    <!-- ORACLE MODAL -->
    <div class="modal-overlay" id="oracleModal">
        <div class="modal">
            <div class="flex justify-between items-center" style="margin-bottom: 24px;">
                <h3 class="mono text-green"><i data-lucide="bot"></i> NEXUS ORACLE</h3>
                <button class="icon-btn" onclick="app.toggleOracle()"><i data-lucide="x"></i></button>
            </div>
            <div class="chat-container">
                <div class="chat-history" id="oracleHistory">
                    <div class="chat-message ai">
                        <div class="chat-bubble">I am Nexus Oracle. Connected to Gemini 2.5 Flash. Awaiting your market query...</div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="oracleInput" class="form-input" placeholder="Ask about markets, symbols, or definitions..." onkeypress="app.handleOracleKey(event)">
                    <button class="icon-btn" onclick="app.submitOracle()"><i data-lucide="send"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- ASSET REPORT MODAL -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal">
            <div class="flex justify-between items-center" style="margin-bottom: 24px;">
                <h3 class="mono text-purple"><i data-lucide="sparkles"></i> AI EXECUTIVE REPORT</h3>
                <button class="icon-btn" onclick="document.getElementById('reportModal').classList.remove('open')"><i data-lucide="x"></i></button>
            </div>
            <div id="reportContent" style="font-family: var(--font-mono); line-height: 1.6; color: var(--text-main); white-space: pre-wrap;">
                Generating analysis...
            </div>
        </div>
    </div>

    <!-- EXPANDED CHART MODAL -->
    <div class="modal-overlay" id="expandedChartModal">
        <div class="modal" style="width: 90vw; max-width: 1200px; height: 80vh; display: flex; flex-direction: column;">
            <div class="flex justify-between items-center" style="margin-bottom: 1rem;">
                <div>
                    <h3 class="mono text-green" id="expandedChartTitle">ASSET ANALYSIS</h3>
                    <div class="text-muted mono" style="font-size: 0.8rem;" id="expandedChartSubtitle">--</div>
                </div>
                <button class="icon-btn" onclick="app.toggleExpandedChart()"><i data-lucide="x"></i></button>
            </div>
            <div id="expandedChartContainer" style="flex-grow: 1; min-height: 0;"></div>
        </div>
    </div>

    <!-- EMAIL NEWSLETTER MODAL -->
    <div class="modal-overlay" id="newsletterModal">
        <div class="modal">
            <div class="flex justify-between items-center" style="margin-bottom: 24px;">
                <h3 class="mono text-amber"><i data-lucide="mail"></i> DAILY INTELLIGENCE DIGEST</h3>
                <button class="icon-btn" onclick="document.getElementById('newsletterModal').classList.remove('open')"><i data-lucide="x"></i></button>
            </div>
            <div class="email-composer">
                <div class="form-group">
                    <label class="form-label">RECIPIENT EMAIL</label>
                    <input type="email" id="recipientEmail" class="form-input" value="analyst@nexus-intel.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">SUBJECT</label>
                    <input type="text" id="emailSubject" class="form-input" value="NEXUS INTEL Daily Digest - Market Intelligence Briefing">
                </div>
                
                <div class="modal-section-title">PREVIEW</div>
                <div class="email-preview" id="emailPreview" style="background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; max-height: 300px; overflow-y: auto; font-family: var(--font-mono); font-size: 0.85rem; line-height: 1.6; white-space: pre-wrap;">
                    Generating daily intelligence digest...
                </div>
                
                <div class="email-controls" style="display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap;">
                    <button onclick="app.copyEmailContent()" class="icon-btn" style="width: auto; padding: 10px 20px;">
                        <i data-lucide="copy"></i> Copy to Clipboard
                    </button>
                    <button onclick="app.dispatchEmail()" style="padding: 12px 24px; background: linear-gradient(135deg, var(--neon-green), var(--neon-blue)); border: none; color: #000; font-family: var(--font-mono); font-weight: 700; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                        <i data-lucide="send"></i> Send via Email
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- VOICE COMMAND LIST -->
    <div class="voice-command-list" id="voiceCommandList">
        <div class="voice-hotkey">? or "help"</div>
        <h4><i data-lucide="mic"></i> VOICE COMMANDS</h4>
        <div class="voice-command-item"><strong>"Search [symbol]"</strong> - Lookup stock/crypto (e.g., "search BTC")</div>
        <div class="voice-command-item"><strong>"Show [symbol]"</strong> - Display stock details</div>
        <div class="voice-command-item"><strong>"Buy" / "Sell"</strong> - Trade current asset (10 units)</div>
        <div class="voice-command-item"><strong>"Auto" / "Bot"</strong> - Toggle Auto-Trader</div>
        <div class="voice-command-item"><strong>"Zen mode" / "Focus mode"</strong> - Toggle Zen mode</div>
        <div class="voice-command-item"><strong>"Refresh news"</strong> - Update intelligence stream</div>
        <div class="voice-command-item"><strong>"Open oracle"</strong> - Open AI chat</div>
        <div class="voice-command-item"><strong>"Generate report"</strong> - Create asset analysis</div>
        <div class="voice-command-item"><strong>"Play briefing"</strong> - Audio executive briefing</div>
        <div class="voice-command-item"><strong>"Stop listening"</strong> - Disable voice control</div>
    </div>
    
    <!-- TOASTS -->
    <div id="toast-container"></div>

    <!-- Background FX -->
    <div class="scanline"></div>

    <!-- Voice Controls -->
    <div class="voice-controls">
        <div class="voice-command-display" id="voiceCommandDisplay">
            <div class="voice-command-text" id="voiceCommandText">Ready for voice commands...</div>
            <div class="voice-command-hint">Say "help" for available commands</div>
        </div>
        <button class="voice-btn" id="voiceControlBtn" onclick="voice.toggleListening()">
            <i data-lucide="mic"></i>
        </button>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo" onclick="window.location.reload()">
            <div class="logo-icon"><i data-lucide="aperture"></i></div>
            <div>NEXUS <span class="text-green">INTEL v9.4</span></div>
        </div>
        
        <div class="search-bar">
            <i data-lucide="search" size="16" class="text-muted"></i>
            <input type="text" id="searchInput" placeholder="SEARCH (e.g. NVDA, BTC, ETH)" onkeypress="app.handleSearch(event)">
        </div>
        
        <div class="header-controls">
            <!-- Audio Visualizer -->
            <div class="audio-visualizer" id="audioVisualizer" style="display: none;">
                <div class="visualizer-bar" style="--i: 0; height: 5px;"></div>
                <div class="visualizer-bar" style="--i: 1; height: 8px;"></div>
                <div class="visualizer-bar" style="--i: 2; height: 12px;"></div>
                <div class="visualizer-bar" style="--i: 3; height: 15px;"></div>
                <div class="visualizer-bar" style="--i: 4; height: 12px;"></div>
                <div class="visualizer-bar" style="--i: 5; height: 8px;"></div>
                <div class="visualizer-bar" style="--i: 6; height: 5px;"></div>
            </div>
            
            <div class="mono text-green" style="font-size: 0.85rem;" id="clock">00:00:00</div>
            
            <button class="executive-briefing-btn" onclick="voiceEngine.playExecutiveBriefing()" title="Play Executive Briefing">
                <i data-lucide="play-circle" width="14"></i> BRIEFING
            </button>
            
            <button class="icon-btn" onclick="app.toggleOracle()" title="AI Oracle (Chat)"><i data-lucide="bot"></i></button>
            <button class="icon-btn" id="zenModeBtn" onclick="app.toggleZenMode()" title="Zen Mode / Cinematic">
                <i data-lucide="maximize"></i>
            </button>
            <button class="icon-btn" onclick="app.sendEmailDigest()" title="Email Daily Digest"><i data-lucide="mail"></i></button>
            <button class="icon-btn" onclick="app.startTour()" title="Start Tour"><i data-lucide="help-circle"></i></button>
            <button class="icon-btn" onclick="voice.toggleCommandList()" title="Voice Commands (?)"><i data-lucide="mic"></i></button>
            <button class="icon-btn" onclick="app.toggleSettings()"><i data-lucide="settings"></i></button>
        </div>
    </header>

    <!-- Ticker -->
    <div class="ticker-container">
        <div class="ticker-track" id="tickerTrack"></div>
    </div>

    <!-- Main Grid -->
    <div class="app-grid">
        
        <!-- Left Sidebar: Watchlist & Portfolio -->
        <aside class="sidebar left-sidebar" id="sidebarLeft">
            
            <!-- PORTFOLIO WIDGET -->
            <div class="portfolio-widget" id="portfolioWidget">
                <div class="portfolio-header">
                    <span class="portfolio-title">QUANT ACCOUNT</span>
                    <div style="display:flex; gap:8px;">
                        <button onclick="portfolio.sharePnl()" style="background:none; border:none; cursor:pointer; color:var(--text-muted); transition:0.2s;" title="Share P&L">
                            <i data-lucide="share-2" width="16"></i>
                        </button>
                        <button onclick="portfolio.showHistory()" style="background:none; border:none; cursor:pointer; color:var(--text-muted); transition:0.2s;" title="Transaction History">
                            <i data-lucide="history" width="16"></i>
                        </button>
                    </div>
                </div>
                <div class="portfolio-balance" id="portBalance">$100,000.00</div>
                <div class="portfolio-pnl" id="portPnl">+0.00%</div>
                
                <div class="xp-bar-container">
                    <div class="xp-bar-fill" id="xpBar"></div>
                </div>
                <div class="rank-badge">
                    <span id="rankTitle">SCRIPT KIDDIE</span>
                    <span id="rankLevel">LVL 1</span>
                </div>

                <div style="margin-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 0.5rem;" id="holdingList">
                    <!-- Holdings injected here -->
                    <div style="text-align:center; color: var(--text-muted); font-size: 0.8rem; padding: 10px;">NO POSITIONS</div>
                </div>
            </div>

            <div>
                <div class="section-title"><i data-lucide="crosshair"></i> WATCHLIST</div>
                <div id="watchlist"></div>
            </div>

            <div style="margin-top: auto;">
                <div class="section-title"><i data-lucide="flame"></i> MARKET HEATMAP</div>
                <div id="heatmap" style="height: 180px; width: 100%; border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; background: rgba(0,0,0,0.3);"></div>
            </div>
        </aside>

        <!-- Main Content: News Feed -->
        <main class="feed-container" id="mainFeed">
            
            <!-- Collapsible Top Brief -->
            <div id="topBriefPanel" class="brief-panel">
                <div class="brief-panel-header">
                    <div style="display:flex; align-items:center; gap:12px; flex-grow: 1; cursor:pointer;" onclick="app.toggleTopBrief()">
                        <i data-lucide="zap" style="color:var(--neon-amber);"></i>
                        <span>DAILY INTELLIGENCE BRIEFING</span>
                    </div>
                    <button class="synth-btn" onclick="app.synthesizeBriefing()">
                        <i data-lucide="sparkles" width="14"></i> SYNTHESIZE INTEL
                    </button>
                    <i data-lucide="chevron-up" id="briefPanelChevron" style="cursor:pointer;" onclick="app.toggleTopBrief()"></i>
                </div>
                <div class="brief-panel-content" id="briefPanelContent">
                    <div style="color: var(--text-muted); font-style:italic; font-family: var(--font-mono);">Initializing Briefing Protocol...</div>
                </div>
            </div>

            <div class="feed-header-row">
                <h2 class="mono" style="font-size: 1.3rem; font-weight: 800; letter-spacing: -0.03em;">
                    <i data-lucide="radio" style="display:inline; width:20px; margin-right:10px;"></i> 
                    INTELLIGENCE STREAM
                </h2>
                <div style="display:flex; align-items:center;">
                    <div class="view-toggle">
                        <button class="icon-btn active" id="viewRowBtn" onclick="app.toggleView('row')" title="Row View"><i data-lucide="list"></i></button>
                        <button class="icon-btn" id="viewGridBtn" onclick="app.toggleView('grid')" title="Grid View"><i data-lucide="grid"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="feed-tabs">
                <button class="feed-tab active" onclick="app.setFeedFilter('all')">ALL</button>
                <button class="feed-tab" onclick="app.setFeedFilter('crypto')">CRYPTO</button>
                <button class="feed-tab" onclick="app.setFeedFilter('tech')">TECH</button>
                <button class="feed-tab" onclick="app.setFeedFilter('startup')">STARTUPS</button>
                <button class="feed-tab" onclick="app.setFeedFilter('ai')">AI & DATA</button>
                <button class="feed-tab" onclick="app.setFeedFilter('energy')">ENERGY</button>
                <button class="feed-tab" onclick="app.setFeedFilter('policy')">POLICY</button>
                
                <button class="refresh-btn" onclick="app.refreshNews()" title="Force Refresh Intel">
                    <i data-lucide="refresh-cw" width="18"></i>
                </button>
            </div>

            <div id="newsFeed"></div>
        </main>

        <!-- Right Sidebar: Chart & Details -->
        <aside class="sidebar sidebar-right" id="sidebarRight">
            <div>
                <div class="section-title"><i data-lucide="activity"></i> ASSET DIAGNOSTICS</div>
                
                <!-- Profile Section -->
                <div id="assetProfile" class="profile-card" style="display:none;">
                    <img id="pLogo" class="profile-logo" src="" alt="logo">
                    <div>
                        <div id="pName" style="font-weight:800; font-size:0.95rem;"></div>
                        <div id="pIndustry" style="font-size:0.75rem; color:var(--text-muted); font-family: var(--font-mono);"></div>
                    </div>
                </div>

                <!-- BOT CONTROL -->
                <div class="bot-control" id="botControlWidget">
                    <div class="bot-status">
                        <div class="bot-active-dot" id="botDot"></div>
                        <span id="botStatusText">GHOST BOT: STANDBY</span>
                    </div>
                    <label class="toggle-switch" style="transform: scale(0.8);">
                        <input type="checkbox" id="botToggle" onchange="app.toggleBot()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- TRADING CONTROLS -->
                <div class="trade-controls">
                    <button class="trade-btn btn-buy" onclick="portfolio.buy()">
                        <i data-lucide="trending-up" width="16"></i> BUY
                    </button>
                    <button class="trade-btn btn-sell" onclick="portfolio.sell()">
                        <i data-lucide="trending-down" width="16"></i> SELL
                    </button>
                </div>
                
                <!-- Asset AI Button -->
                <button onclick="app.generateAssetReport()" style="width:100%; margin-bottom:1rem; padding:12px; background:linear-gradient(135deg, rgba(188, 19, 254, 0.2), rgba(0, 240, 255, 0.2)); border:1px solid var(--neon-purple); color:var(--neon-purple); border-radius:10px; cursor:pointer; font-family:var(--font-mono); font-weight:700; display:flex; align-items:center; justify-content:center; gap:10px; font-size:0.85rem; transition: all 0.3s;">
                    <i data-lucide="sparkles" width="16"></i> GENERATE AI REPORT
                </button>

                <div class="chart-card">
                    <button class="chart-expand-btn" onclick="app.toggleExpandedChart()" title="Maximize Chart">
                        <i data-lucide="maximize-2" width="14"></i>
                    </button>
                    <div class="chart-header">
                        <div>
                            <div class="symbol-title" id="detailSymbol">NVDA</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); font-family: var(--font-mono);" id="detailName">NVIDIA Corp</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="current-price" id="detailPrice">...</div>
                            <div class="price-change mono" id="detailChange">...</div>
                        </div>
                    </div>
                    <!-- Chart Switcher -->
                    <div class="chart-controls">
                        <button class="chart-btn active" onclick="app.toggleChartType('candlestick')" title="Candlestick"><i data-lucide="bar-chart-2"></i> CANDLE</button>
                        <button class="chart-btn" onclick="app.toggleChartType('line')" title="Line Chart"><i data-lucide="activity"></i> LINE</button>
                        <button class="chart-btn" onclick="app.toggleSMA()" id="smaBtn" title="Toggle SMA 20"><i data-lucide="trending-up"></i> SMA</button>
                    </div>
                    <!-- Chart Container -->
                    <div id="mainChart">
                        <div style="text-align:center;">
                            <i data-lucide="loader-2" class="fa-spin" style="margin-bottom:12px;"></i>
                            <div style="font-family: var(--font-mono);">INITIALIZING SENSORS...</div>
                        </div>
                    </div>
                    <!-- RSI Sub-Chart -->
                    <div id="rsiChart"></div>
                </div>
            </div>

            <div>
                <div class="section-title"><i data-lucide="cpu"></i> CORE METRICS</div>
                <div class="profile-stats">
                    <div class="stat-box" style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
                        <div class="p-stat-label">MARKET CAP</div>
                        <div class="p-stat-val" id="metricCap">--</div>
                    </div>
                    <div class="stat-box" style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
                        <div class="p-stat-label">VOLUME</div>
                        <div class="p-stat-val" id="metricVol">--</div>
                    </div>
                    <div class="stat-box" style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
                        <div class="p-stat-label">HIGH (D)</div>
                        <div class="p-stat-val" id="metricHigh">--</div>
                    </div>
                    <div class="stat-box" style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
                        <div class="p-stat-label">LOW (D)</div>
                        <div class="p-stat-val" id="metricLow">--</div>
                    </div>
                </div>
            </div>
            
            <!-- ORDER BOOK VISUALIZER -->
            <div class="order-book-container">
                <div class="ob-header">
                    <span>LEVEL 2 DATA</span>
                    <span>LIVE</span>
                </div>
                <div id="orderBookVisual"></div>
            </div>
        </aside>
    </div>

    <script>
        // ===== SOUND ENGINE =====
        const soundEngine = {
            ctx: null,
            enabled: true,
            init() {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                } catch(e) { console.warn("Web Audio API not supported"); }
            },
            playTone(freq, type, duration, vol = 0.1) {
                if(!this.ctx || !this.enabled) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            click() { this.playTone(800, 'sine', 0.1, 0.05); },
            success() { 
                this.playTone(600, 'sine', 0.1); 
                setTimeout(() => this.playTone(1200, 'sine', 0.2), 100); 
            },
            error() { 
                this.playTone(200, 'sawtooth', 0.2); 
                setTimeout(() => this.playTone(150, 'sawtooth', 0.2), 150); 
            },
            hover() { this.playTone(400, 'sine', 0.05, 0.02); },
            alert() {
                this.playTone(800, 'square', 0.3, 0.2);
                setTimeout(() => this.playTone(600, 'square', 0.3, 0.2), 300);
                setTimeout(() => this.playTone(800, 'square', 0.3, 0.2), 600);
            },
            bot() { this.playTone(1200, 'sine', 0.05, 0.02); }
        };

        // ===== VOICE ENGINE (TTS Integration) =====
        const voiceEngine = {
            speechSynthesis: window.speechSynthesis,
            isSpeaking: false,
            currentUtterance: null,
            voiceAlertsEnabled: true,
            briefingPlaying: false,
            currentButton: null,
            voices: [],
            audioVisualizer: null,

            init() {
                this.loadVoices();
                this.audioVisualizer = document.getElementById('audioVisualizer');
                this.speechSynthesis.onvoiceschanged = () => this.loadVoices();
                setInterval(() => { if (this.isSpeaking && this.audioVisualizer) this.animateVisualizer(); }, 100);
            },

            loadVoices() { this.voices = this.speechSynthesis.getVoices(); },

            getVoice() {
                const preferred = this.voices.find(v => v.lang.includes('en') && (v.name.includes('Google') || v.name.includes('Natural')));
                return preferred || this.voices[0];
            },

            speak(text, onEnd = null) {
                if (!this.speechSynthesis || !text) return;
                this.stop(); 
                this.currentUtterance = new SpeechSynthesisUtterance(text);
                this.currentUtterance.voice = this.getVoice();
                this.currentUtterance.rate = 1.05;
                if (this.audioVisualizer) this.audioVisualizer.style.display = 'flex';
                this.currentUtterance.onstart = () => { this.isSpeaking = true; };
                this.currentUtterance.onend = () => {
                    this.isSpeaking = false;
                    if (this.audioVisualizer) this.audioVisualizer.style.display = 'none';
                    if (onEnd) onEnd();
                    if (this.briefingPlaying) { this.briefingPlaying = false; this.resetBriefingButton(); }
                    if (this.currentButton) { this.resetNewsButton(this.currentButton); this.currentButton = null; }
                };
                this.currentUtterance.onerror = (e) => { this.isSpeaking = false; };
                this.speechSynthesis.speak(this.currentUtterance);
            },

            stop() {
                if (this.speechSynthesis.speaking) this.speechSynthesis.cancel();
                this.isSpeaking = false;
                if (this.audioVisualizer) this.audioVisualizer.style.display = 'none';
                if (this.briefingPlaying) { this.briefingPlaying = false; this.resetBriefingButton(); }
                if (this.currentButton) { this.resetNewsButton(this.currentButton); this.currentButton = null; }
            },
            
            resetBriefingButton() {
                const btn = document.querySelector('.executive-briefing-btn');
                if (btn) { btn.classList.remove('playing'); btn.innerHTML = '<i data-lucide="play-circle" width="14"></i> BRIEFING'; lucide.createIcons(); }
            },

            resetNewsButton(btn) {
                if(btn) { btn.classList.remove('playing'); btn.innerHTML = '<i data-lucide="volume-2"></i> PLAY'; lucide.createIcons(); }
            },

            toggleVoiceAlerts() {
                this.voiceAlertsEnabled = !this.voiceAlertsEnabled;
                notify(`Voice alerts ${this.voiceAlertsEnabled ? 'enabled' : 'disabled'}`, this.voiceAlertsEnabled ? 'success' : 'info');
            },

            announceBreakingNews(headline) {
                if (!this.voiceAlertsEnabled) return;
                this.speak(`Breaking news alert. ${headline}`);
                notify("Breaking news alert!", "info");
            },

            playNewsSummary(headline, summary, btn) {
                if (this.currentButton === btn && this.isSpeaking) { this.stop(); return; }
                const text = `${headline}. ${summary}`;
                this.speak(text);
                this.currentButton = btn;
                if(btn) { btn.classList.add('playing'); btn.innerHTML = '<i data-lucide="square" fill="currentColor" width="12"></i> STOP'; lucide.createIcons(); }
            },

            async playExecutiveBriefing() {
                soundEngine.click();
                const btn = document.querySelector('.executive-briefing-btn');
                if (this.briefingPlaying) { this.stop(); return; }
                this.briefingPlaying = true;
                btn.classList.add('playing');
                btn.innerHTML = '<i data-lucide="square" fill="currentColor" width="14"></i> STOP';
                lucide.createIcons();
                const articles = [...state.newsCache.general, ...state.newsCache.tech].sort((a,b) => b.datetime - a.datetime).slice(0, 3);
                if (articles.length === 0) { this.speak("No briefing data available."); return; }
                let briefing = "Executive Briefing. Top market intelligence for today. ";
                articles.forEach((article, index) => { briefing += `Story ${index + 1}. ${article.headline}. `; });
                briefing += "End of briefing.";
                this.speak(briefing);
            },

            animateVisualizer() {
                if (!this.audioVisualizer) return;
                const bars = this.audioVisualizer.querySelectorAll('.visualizer-bar');
                bars.forEach(bar => {
                    const randomHeight = 5 + Math.random() * 15;
                    bar.style.height = `${randomHeight}px`;
                    bar.style.opacity = 0.5 + Math.random() * 0.5;
                });
            }
        };

        // ===== VOICE CONTROLLER =====
        const voice = {
            recognition: null, isListening: false, isSupported: false,
            commands: {
                'search': (symbol) => { if (symbol) { document.getElementById('searchInput').value = symbol.toUpperCase(); app.loadSymbol(symbol.toUpperCase()); voice.showCommand(`Searching for ${symbol.toUpperCase()}...`); }},
                'show': (symbol) => app.loadSymbol(symbol.toUpperCase()),
                'buy': () => portfolio.buy(),
                'sell': () => portfolio.sell(),
                'auto': () => app.toggleBot(),
                'bot': () => app.toggleBot(),
                'zen mode': () => app.toggleZenMode(),
                'refresh news': () => app.refreshNews(),
                'open oracle': () => app.toggleOracle(),
                'generate report': () => app.generateAssetReport(),
                'play briefing': () => voiceEngine.playExecutiveBriefing(),
                'stop listening': () => voice.stopListening()
            },
            init() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    this.recognition = new SpeechRecognition(); this.recognition.continuous = true; this.recognition.interimResults = false; this.recognition.lang = 'en-US'; this.isSupported = true;
                    this.recognition.onresult = (event) => { const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase().trim(); this.processCommand(transcript); };
                    this.recognition.onerror = (e) => { if (e.error === 'no-speech' || e.error === 'audio-capture') this.stopListening(); };
                    document.addEventListener('keydown', (e) => { if (e.key === '`') { e.preventDefault(); this.toggleListening(); }});
                } else { document.getElementById('voiceControlBtn').style.display = 'none'; }
            },
            processCommand(transcript) {
                voice.showCommand(`Heard: "${transcript}"`);
                const searchMatch = transcript.match(/(?:search|show|lookup|analyze)\s+([a-z]{1,5})/i);
                if (searchMatch) { this.commands['search'](searchMatch[1].toUpperCase()); return; }
                for (const [command, action] of Object.entries(this.commands)) { if (transcript.includes(command)) { action(); return; } }
            },
            showCommand(text) { const display = document.getElementById('voiceCommandDisplay'); document.getElementById('voiceCommandText').textContent = text; display.classList.add('show'); setTimeout(() => display.classList.remove('show'), 3000); },
            toggleListening() { if (!this.isSupported) { notify("Voice not supported", "error"); return; } soundEngine.click(); this.isListening ? this.stopListening() : this.startListening(); },
            startListening() { try { this.recognition.start(); this.isListening = true; document.getElementById('voiceControlBtn').classList.add('listening'); document.getElementById('voiceControlBtn').innerHTML = '<i data-lucide="mic-off"></i>'; lucide.createIcons(); voice.showCommand("Listening..."); } catch (e) { console.error(e); } },
            stopListening() { try { this.recognition.stop(); } catch (e) {} this.isListening = false; document.getElementById('voiceControlBtn').classList.remove('listening'); document.getElementById('voiceControlBtn').innerHTML = '<i data-lucide="mic"></i>'; lucide.createIcons(); voice.showCommand("Voice control paused"); },
            toggleCommandList() { soundEngine.click(); document.getElementById('voiceCommandList').classList.toggle('show'); }
        };

        // ===== ORDER BOOK VISUALIZER =====
        const orderBook = {
            container: null,
            basePrice: 0,
            rows: [],
            
            init() {
                this.container = document.getElementById('orderBookVisual');
                // Create initial mock rows
                for(let i=0; i<5; i++) this.createRow('ask', i); // Asks (Sell)
                for(let i=0; i<5; i++) this.createRow('bid', i); // Bids (Buy)
                
                setInterval(() => this.update(), 500);
            },
            
            createRow(type, index) {
                const row = document.createElement('div');
                row.className = `ob-row ${type}`;
                row.id = `ob-${type}-${index}`;
                row.innerHTML = `
                    <span class="ob-bar ${type}" style="width: ${Math.random()*80}%"></span>
                    <span class="ob-price">--</span>
                    <span class="ob-size">--</span>
                `;
                this.container.appendChild(row);
                this.rows.push({ el: row, type, index });
            },
            
            update() {
                if(!state.quotes[state.currentSymbol]?.c) return;
                const price = state.quotes[state.currentSymbol].c;
                
                // Update Asks (Above Price)
                for(let i=0; i<5; i++) {
                    const row = document.getElementById(`ob-ask-${4-i}`); // Reverse order for visual stacking
                    if(row) {
                        const p = price + (0.05 * (i+1)) + (Math.random() * 0.05);
                        const s = Math.floor(Math.random() * 500);
                        row.querySelector('.ob-price').innerText = p.toFixed(2);
                        row.querySelector('.ob-size').innerText = s;
                        row.querySelector('.ob-bar').style.width = `${(s/500)*100}%`;
                    }
                }
                
                // Update Bids (Below Price)
                for(let i=0; i<5; i++) {
                    const row = document.getElementById(`ob-bid-${i}`);
                    if(row) {
                        const p = price - (0.05 * (i+1)) - (Math.random() * 0.05);
                        const s = Math.floor(Math.random() * 500);
                        row.querySelector('.ob-price').innerText = p.toFixed(2);
                        row.querySelector('.ob-size').innerText = s;
                        row.querySelector('.ob-bar').style.width = `${(s/500)*100}%`;
                    }
                }
            }
        };

        // ===== PORTFOLIO MANAGER & PROGRESSION =====
        const portfolio = {
            cash: 100000,
            holdings: {},
            history: [],
            xp: 0,
            level: 1,
            
            init() {
                const saved = localStorage.getItem('nexus_portfolio');
                if(saved) {
                    const p = JSON.parse(saved);
                    this.cash = p.cash;
                    this.holdings = p.holdings;
                    this.history = p.history || [];
                    this.xp = p.xp || 0;
                    this.level = p.level || 1;
                }
                this.render();
            },
            
            save() {
                localStorage.setItem('nexus_portfolio', JSON.stringify({
                    cash: this.cash,
                    holdings: this.holdings,
                    history: this.history,
                    xp: this.xp,
                    level: this.level
                }));
                this.render();
            },
            
            addXP(amount) {
                this.xp += amount;
                const nextLevel = Math.floor(this.xp / 1000) + 1;
                if(nextLevel > this.level) {
                    this.level = nextLevel;
                    notify(`LEVEL UP! RANK: ${this.getRank()}`, 'success');
                    soundEngine.alert(); // Celebration sound
                }
            },

            getRank() {
                if(this.level < 2) return "SCRIPT KIDDIE";
                if(this.level < 5) return "DAY TRADER";
                if(this.level < 10) return "QUANT ANALYST";
                if(this.level < 20) return "FUND MANAGER";
                return "MARKET MAKER";
            },
            
            logTransaction(type, symbol, qty, price) {
                const log = { type, symbol, qty, price, total: qty * price, time: new Date().toISOString() };
                this.history.unshift(log);
                if(this.history.length > 100) this.history.pop();
            },

            downloadHistory() {
                const headers = ["Type", "Symbol", "Quantity", "Price", "Total", "Time"];
                const csvContent = "data:text/csv;charset=utf-8," 
                    + headers.join(",") + "\n" 
                    + this.history.map(e => `${e.type},${e.symbol},${e.qty},${e.price},${e.total},${e.time}`).join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "nexus_trade_ledger.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                notify("Ledger Downloaded", "success");
            },

            sharePnl() {
                let totalValue = this.cash;
                for(const [sym, data] of Object.entries(this.holdings)) {
                    const currentPrice = state.quotes[sym]?.c || data.avgPrice;
                    totalValue += data.qty * currentPrice;
                }
                const totalPnl = (totalValue - 100000) / 100000 * 100;
                const symbol = totalPnl >= 0 ? '' : '';
                
                const shareText = `NEXUS INTEL TRADER REPORT\n--------------------------\nRANK: ${this.getRank()} (LVL ${this.level})\nPNL: ${totalPnl >= 0 ? '+' : ''}${totalPnl.toFixed(2)}% ${symbol}\nBALANCE: $${totalValue.toLocaleString(undefined, {maximumFractionDigits:0})}\n\nTrade like a machine at NEXUS INTEL.`;
                
                navigator.clipboard.writeText(shareText)
                    .then(() => notify("P&L Receipt Copied to Clipboard", "success"))
                    .catch(() => notify("Failed to copy", "error"));
            },
            
            showHistory() {
                const modal = document.getElementById('historyModal');
                const list = document.getElementById('transactionList');
                list.innerHTML = '';
                if (this.history.length === 0) list.innerHTML = '<div style="text-align:center; color: var(--text-muted); font-family:var(--font-mono);">NO TRANSACTIONS LOGGED</div>';
                else {
                    this.history.slice(0, 20).forEach(tx => {
                        const div = document.createElement('div');
                        div.style.cssText = 'display:flex; justify-content:space-between; padding:10px; background:rgba(255,255,255,0.05); border-radius:6px; font-family:var(--font-mono); font-size:0.85rem;';
                        div.innerHTML = `<div><span class="${tx.type === 'BUY' ? 'text-green' : 'text-red'}" style="font-weight:700;">${tx.type}</span> <span>${tx.symbol}</span> <span class="text-muted">x${tx.qty}</span></div><div style="text-align:right;"><div>$${tx.price.toFixed(2)}</div><div class="text-muted" style="font-size:0.75rem;">${new Date(tx.time).toLocaleTimeString()}</div></div>`;
                        list.appendChild(div);
                    });
                }
                modal.classList.add('open');
            },
            
            buy(auto = false) {
                if(!auto) soundEngine.click();
                const symbol = state.currentSymbol;
                const price = state.quotes[symbol]?.c || 0;
                if(price === 0) { if(!auto) notify("Price unavailable", "error"); return; }
                const qty = 10; const cost = price * qty;
                if(this.cash >= cost) {
                    this.cash -= cost;
                    if(!this.holdings[symbol]) this.holdings[symbol] = { qty: 0, avgPrice: 0 };
                    const oldCost = this.holdings[symbol].qty * this.holdings[symbol].avgPrice;
                    this.holdings[symbol].qty += qty;
                    this.holdings[symbol].avgPrice = (oldCost + cost) / this.holdings[symbol].qty;
                    this.logTransaction('BUY', symbol, qty, price);
                    this.save();
                    if(!auto) { notify(`BOUGHT 10 ${symbol}`, "success"); soundEngine.success(); }
                    else { notify(`GHOST BOT: BUY ${symbol}`, "info"); soundEngine.bot(); }
                } else if(!auto) { notify("INSUFFICIENT FUNDS", "error"); soundEngine.error(); }
            },
            
            sell(auto = false) {
                if(!auto) soundEngine.click();
                const symbol = state.currentSymbol;
                const price = state.quotes[symbol]?.c || 0;
                const qty = 10;
                if(this.holdings[symbol] && this.holdings[symbol].qty >= qty) {
                    const profit = (price - this.holdings[symbol].avgPrice) * qty;
                    this.cash += price * qty;
                    this.holdings[symbol].qty -= qty;
                    if(this.holdings[symbol].qty === 0) delete this.holdings[symbol];
                    if(profit > 0) this.addXP(Math.floor(profit));
                    this.logTransaction('SELL', symbol, qty, price);
                    this.save();
                    if(!auto) { notify(`SOLD 10 ${symbol} (P&L: $${profit.toFixed(2)})`, "success"); soundEngine.success(); }
                    else { notify(`GHOST BOT: SELL ${symbol}`, "info"); soundEngine.bot(); }
                } else if(!auto) { notify("INSUFFICIENT HOLDINGS", "error"); soundEngine.error(); }
            },
            
            render() {
                const list = document.getElementById('holdingList');
                list.innerHTML = '';
                let totalValue = this.cash;
                if(Object.keys(this.holdings).length === 0) list.innerHTML = '<div style="text-align:center; color: var(--text-muted); font-size: 0.8rem; padding: 10px;">NO POSITIONS</div>';
                else {
                    for(const [sym, data] of Object.entries(this.holdings)) {
                        const currentPrice = state.quotes[sym]?.c || data.avgPrice;
                        const value = data.qty * currentPrice;
                        totalValue += value;
                        const pnl = (currentPrice - data.avgPrice) / data.avgPrice * 100;
                        const pnlClass = pnl >= 0 ? 'text-green' : 'text-red';
                        const item = document.createElement('div');
                        item.className = 'holding-item';
                        item.innerHTML = `<div><span style="font-weight:700;">${sym}</span> <span style="color:var(--text-muted); font-size:0.75rem;">x${data.qty}</span></div><div style="text-align:right;"><div>$${value.toFixed(2)}</div><div class="${pnlClass}" style="font-size:0.75rem;">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}%</div></div>`;
                        item.onclick = () => app.loadSymbol(sym);
                        item.style.cursor = 'pointer';
                        list.appendChild(item);
                    }
                }
                document.getElementById('portBalance').innerText = `$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                const totalPnl = (totalValue - 100000) / 100000 * 100;
                const pnlEl = document.getElementById('portPnl');
                pnlEl.innerText = `${totalPnl >= 0 ? '+' : ''}${totalPnl.toFixed(2)}% (ALL)`;
                pnlEl.className = `portfolio-pnl ${totalPnl >= 0 ? 'positive' : 'negative'}`;
                
                // Render XP
                const xpProgress = (this.xp % 1000) / 10;
                document.getElementById('xpBar').style.width = `${xpProgress}%`;
                document.getElementById('rankTitle').innerText = this.getRank();
                document.getElementById('rankLevel').innerText = `LVL ${this.level}`;
            }
        };

        // ===== FLASH EVENT ENGINE & WHALE WATCHER =====
        const eventEngine = {
            marketModifier: 1.0,
            events: [
                { msg: "QUANTUM DECRYPTION BREAKTHROUGH: TECH SURGE", impact: 1.05 },
                { msg: "GLOBAL ENERGY GRID FAILURE: MARKETS PAUSED", impact: 0.95 },
                { msg: "AI SENTIENCE CONFIRMED: NVIDIA SHARES HALTED", impact: 0.90 },
                { msg: "CYBER-ATTACK ON CENTRAL BANK: CRYPTO SPIKE", impact: 1.08 },
                { msg: "FUSION REACTOR STABILIZED: ENERGY RALLY", impact: 1.03 }
            ],
            
            init() { 
                setInterval(() => { if (Math.random() > 0.8) this.triggerEvent(); }, 120000); 
                // Whale Watcher
                setInterval(() => { if (Math.random() > 0.85) this.triggerWhaleAlert(); }, 45000);
            }, 
            
            triggerEvent() {
                const event = this.events[Math.floor(Math.random() * this.events.length)];
                const alertBox = document.getElementById('flashAlert');
                alertBox.style.display = 'block';
                document.body.classList.add('shake-active');
                
                soundEngine.alert();
                notify(`URGENT: ${event.msg}`, "error");
                
                // FIXED: Only speak if voice alerts are enabled
                if (state.voiceAlerts) {
                    voiceEngine.speak(`Emergency Alert. ${event.msg}`);
                } else {
                    notify("Voice Alert Suppressed (Settings)", "info");
                }
                
                this.marketModifier = event.impact;
                setTimeout(() => { this.marketModifier = 1.0; notify("MARKET STABILIZED", "success"); }, 20000);
                setTimeout(() => { alertBox.style.display = 'none'; document.body.classList.remove('shake-active'); }, 3000);
            },
            
            triggerWhaleAlert() {
                const whaleBox = document.getElementById('whaleAlert');
                whaleBox.classList.add('active');
                soundEngine.playTone(200, 'sine', 0.5, 0.2); // Low frequency "Whale" sound
                setTimeout(() => whaleBox.classList.remove('active'), 4000);
            }
        };

        // ===== APP STATE =====
        const state = {
            apiKeys: { finnhub: localStorage.getItem('nexus_finnhub_key') || 'd5e7311r01qjckl29au0d5e7311r01qjckl29aug', gemini: localStorage.getItem('nexus_gemini_key') || '' },
            symbols: JSON.parse(localStorage.getItem('nexus_watchlist')) || ['NVDA', 'BTC', 'ETH', 'SOL', 'AAPL', 'MSFT', 'TSLA', 'AMZN'],
            currentSymbol: localStorage.getItem('nexus_last_symbol') || 'NVDA',
            quotes: {},
            newsCache: { general: [], crypto: [], startup: [], ai: [], energy: [], policy: [], tech: [] },
            activeFilter: 'all',
            viewMode: 'row',
            zenMode: false,
            briefCollapsed: false,
            chart: null,
            rsiChart: null,
            chartType: 'candlestick',
            showSMA: false,
            currentCandles: null,
            heatmap: null,
            newsletterEmail: localStorage.getItem('nexus_newsletter_email') || 'analyst@nexus-intel.com',
            autoNewsletter: localStorage.getItem('nexus_auto_newsletter') === 'true',
            voiceAlerts: localStorage.getItem('nexus_voice_alerts') !== 'false',
            soundEnabled: localStorage.getItem('nexus_sound_enabled') !== 'false',
            // Replace boolean mode with string theme
            currentTheme: localStorage.getItem('nexus_theme') || 'theme-cyberpunk',
            botActive: false,
            rsiValue: 50 // Current RSI
        };

        const notify = (msg, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            let icon = type === 'success' ? 'check' : type === 'error' ? 'alert-triangle' : 'info';
            let color = type === 'success' ? 'var(--neon-green)' : type === 'error' ? 'var(--neon-red)' : 'var(--neon-blue)';
            toast.style.borderColor = color;
            toast.innerHTML = `<i data-lucide="${icon}" style="color:${color}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
        };

        // ===== API CONTROLLER =====
        const api = {
            baseUrl: 'https://finnhub.io/api/v1',
            rssProxy: 'https://api.rss2json.com/v1/api.json?rss_url=',
            async getQuote(symbol) {
                // Apply simulated market event impact
                const impact = eventEngine.marketModifier;
                try {
                    const res = await fetch(`${this.baseUrl}/quote?symbol=${symbol}&token=${state.apiKeys.finnhub}`);
                    const data = await res.json();
                    if(data.c && data.c > 0) {
                        data.c = data.c * impact; // Apply impact
                        return data;
                    }
                } catch (e) { }
                return this.generateSimulatedQuote(symbol, impact);
            },
            generateSimulatedQuote(symbol, impact) {
                const seed = symbol.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                const volatility = (seed % 10) / 100;
                const basePrice = ((seed % 500) + 10) * impact; 
                const randomMove = (Math.random() - 0.45) * basePrice * volatility;
                const c = basePrice + randomMove;
                const o = basePrice;
                return { c, d: c-o, dp: ((c-o)/o)*100, h: c*1.02, l: c*0.98, o, pc: o };
            },
            async getProfile(symbol) {
                try {
                    const res = await fetch(`${this.baseUrl}/stock/profile2?symbol=${symbol}&token=${state.apiKeys.finnhub}`);
                    const data = await res.json();
                    if(data && data.name) return data;
                } catch (e) { }
                const isCrypto = ['BTC','ETH','SOL','XRP','ADA','DOGE','DOT','MATIC'].includes(symbol);
                if (isCrypto || symbol.length <= 4) return { name: `${symbol} (Crypto)`, finnhubIndustry: 'Cryptocurrency', marketCapitalization: 0, shareOutstanding: 0, logo: `https://assets.coincap.io/assets/icons/${symbol.toLowerCase()}@2x.png` };
                return { name: `${symbol} Corp (Simulated)`, finnhubIndustry: 'Technology', marketCapitalization: 1000000000, shareOutstanding: 500000, logo: `https://logo.clearbit.com/${symbol.toLowerCase()}.com` };
            },
            async getCandles(symbol) {
                const to = Math.floor(Date.now() / 1000); const from = to - (30 * 24 * 60 * 60); 
                try {
                    const res = await fetch(`${this.baseUrl}/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${to}&token=${state.apiKeys.finnhub}`);
                    const data = await res.json();
                    if(data.s === 'ok') return data;
                } catch (e) { }
                notify(`Simulating chart for ${symbol}.`, 'warning');
                return this.generateSimulatedCandles(to, 30);
            },
            generateSimulatedCandles(endTime, days) {
                const c = [], h = [], l = [], o = [], t = [];
                let price = 150 + Math.random() * 50;
                for (let i = days; i > 0; i--) {
                    const time = endTime - (i * 24 * 60 * 60);
                    const volatility = price * 0.05;
                    const change = (Math.random() - 0.5) * volatility;
                    const open = price; const close = price + change;
                    o.push(open); c.push(close); h.push(Math.max(open,close)*1.02); l.push(Math.min(open,close)*0.98); t.push(time);
                    price = close;
                }
                return { s: 'ok', c, h, l, o, t };
            },
            async getAllNews() {
                // Clear existing cache
                for(let key in state.newsCache) state.newsCache[key] = [];
                
                // Add Timeout Wrapper
                const timeout = (ms, promise) => {
                    return new Promise((resolve, reject) => {
                        const timer = setTimeout(() => { reject(new Error("TIMEOUT")) }, ms);
                        promise.then(value => { clearTimeout(timer); resolve(value); })
                               .catch(reason => { clearTimeout(timer); reject(reason); });
                    });
                };

                try {
                    await Promise.allSettled([
                        // Market / Finance (Yahoo is usually reliable for free RSS)
                        timeout(3000, this.getRSSNews('https://api.rss2json.com/v1/api.json?rss_url=https://finance.yahoo.com/news/rssindex', 'market')),
                        // Tech (CNBC Tech is robust)
                        timeout(3000, this.getRSSNews('https://api.rss2json.com/v1/api.json?rss_url=https://www.cnbc.com/id/19854910/device/rss/rss.html', 'tech')),
                        // Startups / Tech
                        timeout(3000, this.getRSSNews('https://api.rss2json.com/v1/api.json?rss_url=https://techcrunch.com/feed/', 'startup')),
                        // Crypto (Coindesk)
                        timeout(3000, this.getRSSNews('https://api.rss2json.com/v1/api.json?rss_url=https://www.coindesk.com/arc/outboundfeeds/rss/', 'crypto')),
                        // AI (Wired)
                        timeout(3000, this.getRSSNews('https://api.rss2json.com/v1/api.json?rss_url=https://www.wired.com/feed/category/ai/latest/rss', 'ai')),
                        // Energy (OilPrice)
                        timeout(3000, this.getRSSNews('https://api.rss2json.com/v1/api.json?rss_url=https://oilprice.com/rss/main', 'energy')),
                        // Finnhub (API based)
                        timeout(3000, this.getFinnhubNews())
                    ]);
                } catch (e) { console.warn("Some feeds failed/timed out"); }

                let totalNews = 0; 
                for(let key in state.newsCache) totalNews += state.newsCache[key].length;
                if (totalNews === 0) this.generateSimulationData(); 
                else this.checkBreakingNews();
            },
            generateSimulationData() {
                // COMPREHENSIVE MOCK DATA GENERATOR FOR ALL CATEGORIES
                const mockNews = [
                    { headline: "Global Markets Brace for Impact as Tech Sector Adjusts", summary: "Analysts predict a shift in capital allocation.", source: "NEXUS CORE", category: "TECH", datetime: Date.now()/1000 - 300 },
                    { headline: "Crypto Volatility Spikes: BTC Tests Key Resistance", summary: "Bitcoin movement following regulatory news.", source: "BLOCKCHAIN WIRE", category: "CRYPTO", datetime: Date.now()/1000 - 3600 },
                    { headline: "Neural Link Integration: The Next Frontier?", summary: "Bio-tech firms race to develop interface.", source: "FUTURE WATCH", category: "AI", datetime: Date.now()/1000 - 7200 },
                    { headline: "Fusion Reactor Breakthrough: Infinite Energy?", summary: "Clean energy sector rallies on new physics data.", source: "GREEN TECH", category: "ENERGY", datetime: Date.now()/1000 - 5000 },
                    { headline: "New Privacy Laws Shake Up Silicon Valley", summary: "Legislators introduce strict data compliance bills.", source: "GOV WIRE", category: "POLICY", datetime: Date.now()/1000 - 1500 },
                    { headline: "Unicorn Startup Raises $500M in Series B", summary: "Disruptive AI startup achieves massive valuation.", source: "VENTURE CAP", category: "STARTUP", datetime: Date.now()/1000 - 2000 }
                ];
                
                state.newsCache.general = mockNews; 
                state.newsCache.tech = mockNews.filter(n => n.category === 'TECH'); 
                state.newsCache.crypto = mockNews.filter(n => n.category === 'CRYPTO');
                state.newsCache.ai = mockNews.filter(n => n.category === 'AI');
                state.newsCache.energy = mockNews.filter(n => n.category === 'ENERGY');
                state.newsCache.policy = mockNews.filter(n => n.category === 'POLICY');
                state.newsCache.startup = mockNews.filter(n => n.category === 'STARTUP');
            },
            async getFinnhubNews() {
                try { const res = await fetch(`${this.baseUrl}/news?category=general&token=${state.apiKeys.finnhub}`); const data = await res.json(); if(Array.isArray(data)) state.newsCache.general = data.slice(0, 50); } catch (e) { }
            },
            async getRSSNews(url, category) {
                try {
                    const res = await fetch(url); const data = await res.json();
                    if(data.status === 'ok') {
                        const newItems = data.items.slice(0, 10).map(item => ({ headline: item.title, summary: item.description ? item.description.replace(/<[^>]*>?/gm, '').substring(0, 150) + '...' : 'No summary available', url: item.link, source: data.feed.title || 'RSS', datetime: new Date(item.pubDate).getTime() / 1000, category: category.toUpperCase() }));
                        if (!state.newsCache[category]) state.newsCache[category] = [];
                        state.newsCache[category] = [...state.newsCache[category], ...newItems].sort((a,b) => b.datetime - a.datetime);
                    }
                } catch (e) { }
            },
            checkBreakingNews() {
                const now = Date.now() / 1000; const fiveMinutesAgo = now - 300; let breakingNews = null;
                for (const category in state.newsCache) {
                    const recent = state.newsCache[category].filter(item => item.datetime > fiveMinutesAgo && (item.headline.toLowerCase().includes('breaking') || item.headline.toLowerCase().includes('alert')));
                    if (recent.length > 0) { breakingNews = recent[0]; break; }
                }
                if (breakingNews && voiceEngine.voiceAlertsEnabled) voiceEngine.announceBreakingNews(breakingNews.headline);
            },
            async callGemini(prompt) {
                if (!state.apiKeys.gemini) { notify("Gemini API Key Required", "error"); return null; }
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKeys.gemini}`;
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    const data = await response.json(); return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) { notify("AI Connection Failed", "error"); return null; }
            },
            async summarizeWithGemini(text, elementId) {
                const btn = document.getElementById(`btn-${elementId}`); const box = document.getElementById(`box-${elementId}`);
                btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> THINKING`; btn.disabled = true;
                const result = await this.callGemini(`Summarize for investor: ${text}`);
                if (result) { box.innerText = result; box.classList.add('active'); btn.innerHTML = `<i data-lucide="check"></i> DONE`; btn.disabled = false; lucide.createIcons(); } else { btn.innerHTML = `ERROR`; btn.disabled = false; }
            },
            async generateDailyDigest() {
                if(!state.apiKeys.gemini) return `NEXUS INTEL DAILY DIGEST\n\nAI Key Missing. Simulated Output available.`;
                return await this.callGemini(`Generate market digest based on recent trends.`);
            }
        };

        // ===== UI CONTROLLER =====
        const app = {
            tourStep: 0,
            
            async init() {
                this.runBootSequence(); soundEngine.init(); lucide.createIcons(); this.initClock(); voiceEngine.init(); voice.init(); this.loadSettings(); portfolio.init(); eventEngine.init(); orderBook.init();
                
                // Theme Init
                this.setTheme(state.currentTheme);
                document.getElementById('themeSelector').value = state.currentTheme;

                document.getElementById('finnhubKey').value = state.apiKeys.finnhub;
                document.getElementById('geminiKey').value = state.apiKeys.gemini;
                document.getElementById('newsletterEmail').value = state.newsletterEmail;
                document.getElementById('voiceAlertsToggle').checked = state.voiceAlerts;
                document.getElementById('soundEffectsToggle').checked = state.soundEnabled; 
                document.getElementById('autoNewsletterToggle').checked = state.autoNewsletter;
                await this.loadSymbol(state.currentSymbol); await this.refreshNews(); this.updateTicker();
                setInterval(() => this.updateTicker(), 60000);
                
                // BOT LOOP (Running every 5 seconds)
                setInterval(() => {
                    if(state.botActive) {
                        if(state.rsiValue < 30) portfolio.buy(true); // Oversold -> Buy
                        else if(state.rsiValue > 70) portfolio.sell(true); // Overbought -> Sell
                    }
                }, 5000);

                document.querySelectorAll('.modal-overlay').forEach(overlay => { overlay.addEventListener('click', (e) => { if (e.target === overlay) { overlay.classList.remove('open'); soundEngine.click(); } }); });
                document.querySelectorAll('button, .news-headline, .ticker-item').forEach(el => { el.addEventListener('mouseenter', () => soundEngine.hover()); });
                
                // Show tour on first visit
                if (!localStorage.getItem('nexus_tour_completed')) {
                    setTimeout(() => this.startTour(), 3000);
                }
            },

            runBootSequence() {
                const screen = document.getElementById('bootScreen'); const log = document.getElementById('bootLog');
                const msgs = ["INITIALIZING KERNEL...", "LOADING NEURAL NETWORKS...", "CONNECTING TO GLOBAL EXCHANGES...", "ACTIVATING QUANT PROTOCOLS...", "SYSTEM ONLINE."];
                let i = 0;
                const interval = setInterval(() => {
                    if(i < msgs.length) { const div = document.createElement('div'); div.className = 'boot-log'; div.innerText = `> ${msgs[i]}`; log.appendChild(div); i++; soundEngine.playTone(800 + (i*100), 'square', 0.05, 0.05); } 
                    else { clearInterval(interval); setTimeout(() => { screen.style.opacity = '0'; setTimeout(() => screen.remove(), 500); }, 500); }
                }, 200);
            },
            
            setTheme(themeName) {
                document.body.className = themeName; // Clears old classes, sets new one
                state.currentTheme = themeName;
                localStorage.setItem('nexus_theme', themeName);
            },

            loadSettings() {
                state.apiKeys.finnhub = localStorage.getItem('nexus_finnhub_key') || state.apiKeys.finnhub;
                state.apiKeys.gemini = localStorage.getItem('nexus_gemini_key') || '';
                state.newsletterEmail = localStorage.getItem('nexus_newsletter_email') || 'analyst@nexus-intel.com';
                state.autoNewsletter = localStorage.getItem('nexus_auto_newsletter') === 'true';
                state.voiceAlerts = localStorage.getItem('nexus_voice_alerts') !== 'false';
                state.soundEnabled = localStorage.getItem('nexus_sound_enabled') !== 'false';
                state.currentTheme = localStorage.getItem('nexus_theme') || 'theme-cyberpunk';
                soundEngine.enabled = state.soundEnabled; 
                voiceEngine.voiceAlertsEnabled = state.voiceAlerts; // Ensure initial sync
            },
            initClock() { setInterval(() => { document.getElementById('clock').innerText = new Date().toISOString().split('T')[1].split('.')[0] + " UTC"; }, 1000); },
            toggleOracle() { soundEngine.click(); document.getElementById('oracleModal').classList.toggle('open'); setTimeout(() => document.getElementById('oracleInput').focus(), 100); },
            handleOracleKey(e) { if (e.key === 'Enter') this.submitOracle(); },
            
            async submitOracle() {
                const input = document.getElementById('oracleInput');
                const history = document.getElementById('oracleHistory');
                const q = input.value.trim();
                if(!q) return;
                soundEngine.click();

                history.innerHTML += `<div class="chat-message user"><div class="chat-bubble">${q.replace(/</g, "&lt;")}</div></div>`;
                input.value = '';
                history.scrollTop = history.scrollHeight;

                const prompt = `You are Nexus Oracle, a cynical cyberpunk market analyst. Answer this briefly: ${q}`;
                const response = await api.callGemini(prompt);
                const responseText = response || "CONNECTION ERROR: AI UPLINK FAILED. TRY CONFIGURING API KEY.";
                history.innerHTML += `<div class="chat-message ai"><div class="chat-bubble">${responseText}</div></div>`;
                
                if(response) { 
                    // FIXED: Respect voice alerts toggle for Oracle response
                    if (state.voiceAlerts) {
                        voiceEngine.speak(response); 
                    }
                    soundEngine.success(); 
                } else { 
                    soundEngine.error(); 
                }
                history.scrollTop = history.scrollHeight;
            },

            async generateAssetReport() { /* ... */ },
            async synthesizeBriefing() { /* ... */ },
            async sendEmailDigest(auto = false) { /* ... */ },
            dispatchEmail() { /* ... */ },
            copyEmailContent() { /* ... */ },
            
            toggleZenMode() { 
                soundEngine.click();
                state.zenMode = !state.zenMode;
                const btn = document.getElementById('zenModeBtn');
                if (state.zenMode) {
                    document.body.classList.add('zen-mode');
                    btn.classList.add('active');
                    btn.querySelector('i').setAttribute('data-lucide', 'minimize');
                    // Hide sidebars in Cinematic mode
                    document.querySelectorAll('.sidebar').forEach(el => el.style.display = 'none');
                    document.querySelector('.app-grid').style.gridTemplateColumns = '1fr';
                    notify("CINEMATIC HUD ACTIVE", "success");
                } else {
                    document.body.classList.remove('zen-mode');
                    btn.classList.remove('active');
                    btn.querySelector('i').setAttribute('data-lucide', 'maximize');
                    // Restore grid
                    document.querySelectorAll('.sidebar').forEach(el => el.style.display = ''); // Reset display
                    if(window.innerWidth > 1200) document.querySelector('.app-grid').style.gridTemplateColumns = '280px 1fr 340px';
                    else if(window.innerWidth > 768) document.querySelector('.app-grid').style.gridTemplateColumns = '240px 1fr 0';
                    else document.querySelector('.app-grid').style.gridTemplateColumns = '0 1fr 0';
                }
                lucide.createIcons();
                if(state.chart) setTimeout(() => state.chart.resize(), 300);
                if(state.heatmap) setTimeout(() => state.heatmap.resize(), 300);
            },
            toggleView(mode) { /* ... */ },
            toggleTopBrief() { /* ... */ },
            renderTopBrief(articles) {
                const container = document.getElementById('briefPanelContent');
                if (!articles || articles.length === 0) return;
                const topPicks = articles.filter(a => a.category !== 'Crypto').slice(0, 3);
                container.innerHTML = topPicks.map((art, i) => `
                    <div class="tldr-item" onclick="window.open('${art.url}', '_blank')">
                        <div class="tldr-rank">0${i+1}</div>
                        <div class="tldr-text">
                            <h4>${art.headline}</h4>
                            <div class="tldr-meta">
                                <span>${art.source}</span>
                                <span></span>
                                <span>${new Date(art.datetime*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                <button class="voice-play-btn" style="margin-left: auto;" onclick="event.stopPropagation(); voiceEngine.playNewsSummary('${art.headline.replace(/'/g, "")}', '${art.summary.substring(0, 100).replace(/'/g, "")}', this);">
                                    <i data-lucide="volume-2"></i> PLAY
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            },
            toggleSettings() { soundEngine.click(); document.getElementById('settingsModal').classList.toggle('open'); },
            clearCache() { localStorage.clear(); location.reload(); },
            
            saveSettings() {
                soundEngine.click();
                state.apiKeys.finnhub = document.getElementById('finnhubKey').value;
                state.apiKeys.gemini = document.getElementById('geminiKey').value;
                state.newsletterEmail = document.getElementById('newsletterEmail').value;
                state.voiceAlerts = document.getElementById('voiceAlertsToggle').checked;
                state.soundEnabled = document.getElementById('soundEffectsToggle').checked;
                state.autoNewsletter = document.getElementById('autoNewsletterToggle').checked;
                
                // Get theme from selector directly in case it changed
                const selectedTheme = document.getElementById('themeSelector').value;
                state.currentTheme = selectedTheme;
                
                localStorage.setItem('nexus_finnhub_key', state.apiKeys.finnhub);
                localStorage.setItem('nexus_gemini_key', state.apiKeys.gemini);
                localStorage.setItem('nexus_newsletter_email', state.newsletterEmail);
                localStorage.setItem('nexus_voice_alerts', state.voiceAlerts);
                localStorage.setItem('nexus_sound_enabled', state.soundEnabled);
                localStorage.setItem('nexus_auto_newsletter', state.autoNewsletter);
                localStorage.setItem('nexus_theme', state.currentTheme);
                
                voiceEngine.voiceAlertsEnabled = state.voiceAlerts;
                soundEngine.enabled = state.soundEnabled; 
                this.setTheme(state.currentTheme);
                
                this.toggleSettings();
                notify("Settings Saved", "success");
            },

            // TOUR LOGIC
            startTour() {
                this.tourStep = 0;
                document.getElementById('tourOverlay').style.display = 'block';
                this.updateTour();
            },
            endTour() {
                document.getElementById('tourOverlay').style.display = 'none';
                localStorage.setItem('nexus_tour_completed', 'true');
            },
            nextTourStep() {
                this.tourStep++;
                this.updateTour();
            },
            updateTour() {
                const highlight = document.getElementById('tourHighlight');
                const card = document.getElementById('tourCard');
                const title = document.getElementById('tourTitle');
                const text = document.getElementById('tourText');
                
                // Reset styles
                highlight.style.display = 'block';
                
                const setPos = (elId, t, msg) => {
                    const el = document.getElementById(elId);
                    
                    // Check if element exists AND is visible (not display:none)
                    // If offsetParent is null, the element is hidden
                    const isVisible = el && el.offsetParent !== null;

                    if(!isVisible) {
                        // Fallback for mobile/hidden elements: Center the card
                        highlight.style.display = 'none';
                        card.style.top = '50%';
                        card.style.left = '50%';
                        card.style.transform = 'translate(-50%, -50%)';
                        title.innerText = t;
                        text.innerText = msg;
                        return;
                    }
                    
                    // Reset transform from fallback
                    card.style.transform = 'none';

                    const rect = el.getBoundingClientRect();
                    highlight.style.top = rect.top - 5 + 'px';
                    highlight.style.left = rect.left - 5 + 'px';
                    highlight.style.width = rect.width + 10 + 'px';
                    highlight.style.height = rect.height + 10 + 'px';
                    
                    let top = rect.bottom + 20;
                    let left = rect.left;
                    
                    // Boundary checks to keep card on screen
                    if (top + 200 > window.innerHeight) top = rect.top - 220; 
                    if (left + 300 > window.innerWidth) left = window.innerWidth - 320; 
                    if (left < 0) left = 10;
                    if (top < 0) top = 10;

                    card.style.top = top + 'px';
                    card.style.left = left + 'px';
                    
                    title.innerText = t;
                    text.innerText = msg;
                };

                switch(this.tourStep) {
                    case 0:
                        setPos('portfolioWidget', 'YOUR COMMAND CENTER', 'Track your fake money, XP level, and rank here. Try not to go broke.');
                        break;
                    case 1:
                        setPos('mainFeed', 'INTELLIGENCE STREAM', 'Live news from 50+ sources. Click "Analyze" to let AI summarize the fluff for you.');
                        break;
                    case 2:
                        setPos('mainChart', 'MARKET DATA', 'Real-time charts with SMA and RSI indicators. Toggle "Zen Mode" in the header for a cinematic view.');
                        break;
                    case 3:
                        setPos('botControlWidget', 'GHOST BOT', 'Feeling lazy? Activate the Ghost Bot. It trades based on RSI levels automatically.');
                        break;
                    default:
                        this.endTour();
                }
            },

            async handleSearch(e) { if (e.key === 'Enter') { soundEngine.click(); const symbol = e.target.value.toUpperCase(); await this.loadSymbol(symbol); if (!state.symbols.includes(symbol)) { state.symbols.unshift(symbol); localStorage.setItem('nexus_watchlist', JSON.stringify(state.symbols)); } await this.updateTicker(); e.target.value = ''; notify(`Tracking ${symbol}`, "success"); } },
            async refreshNews() { 
                soundEngine.click(); 
                const btn = document.querySelector('.refresh-btn i');
                if(btn) btn.classList.add('fa-spin');
                notify("Scanning Intelligence Feeds...", "info"); 
                await api.getAllNews(); 
                this.renderFeed(); 
                if(btn) btn.classList.remove('fa-spin');
                notify("Intel Updated", "success"); 
            },
            
            toggleBot() {
                state.botActive = !state.botActive;
                document.getElementById('botToggle').checked = state.botActive;
                const status = document.getElementById('botStatusText');
                const dot = document.getElementById('botDot');
                if(state.botActive) {
                    status.innerText = "GHOST BOT: ACTIVE";
                    status.style.color = "var(--neon-green)";
                    dot.classList.add('active');
                    notify("AUTO-TRADER ENGAGED", "success");
                    soundEngine.bot();
                } else {
                    status.innerText = "GHOST BOT: STANDBY";
                    status.style.color = "var(--neon-purple)";
                    dot.classList.remove('active');
                    notify("AUTO-TRADER STANDBY", "info");
                }
            },

            async updateTicker() {
                const track = document.getElementById('tickerTrack'); const list = document.getElementById('watchlist'); track.innerHTML = ''; list.innerHTML = ''; let heatmapData = [];
                for (const sym of state.symbols) {
                    const quote = await api.getQuote(sym); state.quotes[sym] = quote;
                    const changeClass = quote.d >= 0 ? 'text-green' : 'text-red'; const icon = quote.d >= 0 ? '' : '';
                    heatmapData.push({ x: sym, y: Math.abs(quote.dp).toFixed(2), fillColor: quote.d >= 0 ? '#00ff9d' : '#ff2a6d' });
                    const tItem = document.createElement('div'); tItem.className = 'ticker-item mono'; tItem.innerHTML = `<span class="text-muted">${sym}</span> <span class="${changeClass}">${quote.c.toFixed(2)} ${icon} ${Math.abs(quote.dp).toFixed(2)}%</span>`; tItem.onclick = () => { soundEngine.click(); this.loadSymbol(sym); }; tItem.addEventListener('mouseenter', () => soundEngine.hover()); track.appendChild(tItem);
                    const wItem = document.createElement('div'); wItem.className = 'watchlist-item'; wItem.style.cssText = `display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid var(--border-color); cursor:pointer; transition: all 0.3s; ${sym === state.currentSymbol ? 'background:rgba(255,255,255,0.05); border-left: 3px solid var(--neon-green);' : ''}`; wItem.innerHTML = `<div><div style="font-weight:800; font-family: var(--font-mono);">${sym}</div></div><div style="text-align:right"><div class="mono" style="font-weight:600;">${quote.c.toFixed(2)}</div><div class="${changeClass}" style="font-size:0.8rem; font-family: var(--font-mono);">${quote.dp.toFixed(2)}%</div></div>`; wItem.onclick = () => { soundEngine.click(); this.loadSymbol(sym); }; wItem.addEventListener('mouseenter', () => { soundEngine.hover(); if(sym !== state.currentSymbol) wItem.style.background = 'rgba(255,255,255,0.03)'; }); wItem.addEventListener('mouseleave', () => { if(sym !== state.currentSymbol) wItem.style.background = 'transparent'; }); list.appendChild(wItem);
                }
                if(track.children.length > 0) Array.from(track.children).forEach(c => track.appendChild(c.cloneNode(true)));
                this.renderHeatmap(heatmapData); portfolio.render();
            },
            renderHeatmap(data) { if(state.heatmap) state.heatmap.destroy(); if(data.length === 0) return; const options = { series: [{ data: data }], chart: { type: 'treemap', height: 180, toolbar: {show:false}, background: 'transparent' }, colors: ['#00ff9d', '#ff2a6d'], plotOptions: { treemap: { distributed: true, enableShades: false, useFillColorAsStroke: true } }, dataLabels: { enabled: true, style: { fontSize: '11px', fontFamily: 'JetBrains Mono', colors: ['#000'] } }, stroke: { show: true, width: 2, colors: ['#0e0e12'] }, tooltip: { theme: 'dark', style: { fontFamily: 'JetBrains Mono' } } }; state.heatmap = new ApexCharts(document.querySelector("#heatmap"), options); state.heatmap.render(); },
            setFeedFilter(filter) { soundEngine.click(); state.activeFilter = filter; document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active')); event.target.classList.add('active'); this.renderFeed(); },
            
            renderFeed() {
                const container = document.getElementById('newsFeed');
                container.innerHTML = '';
                let articles = [];

                if (state.activeFilter === 'all') articles = [...state.newsCache.general, ...state.newsCache.tech].sort((a,b) => b.datetime - a.datetime);
                else if (state.activeFilter === 'crypto') articles = (state.newsCache.crypto || []).map(a => ({ ...a, category: 'Crypto' }));
                else articles = state.newsCache[state.activeFilter] || [];

                if (!document.querySelector('.synth-btn i.fa-spin')) this.renderTopBrief(articles);
                if (!articles || articles.length === 0) {
                    container.innerHTML = `<div class="text-muted" style="padding:20px; text-align:center; font-family: var(--font-mono);">NO INTEL FOUND FOR CHANNEL: ${state.activeFilter.toUpperCase()}</div>`;
                    return;
                }

                articles.slice(0, 25).forEach((art, idx) => {
                    const text = (art.headline + ' ' + art.summary).toLowerCase();
                    let sentiment = 'neutral';
                    if (text.includes('surge') || text.includes('record') || text.includes('bull')) sentiment = 'bullish';
                    else if (text.includes('drop') || text.includes('crash') || text.includes('bear')) sentiment = 'bearish';

                    const div = document.createElement('div');
                    div.className = `news-card ${sentiment}`;
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:var(--text-muted); margin-bottom:8px; font-family: var(--font-mono);">
                            <span>${art.source ? art.source.toUpperCase() : 'SOURCE'}</span>
                            <span>${new Date(art.datetime*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="news-headline" onclick="window.open('${art.url}', '_blank')">${art.headline}</div>
                        <div class="news-summary">${art.summary}</div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:1rem; flex-wrap: wrap; gap: 10px;">
                            <span class="tag" style="background:rgba(255,255,255,0.1); padding:6px 12px; border-radius:6px; font-size:0.75rem; font-family: var(--font-mono); letter-spacing:0.05em;">${state.activeFilter.toUpperCase()}</span>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="voice-play-btn" onclick="voiceEngine.playNewsSummary('${art.headline.replace(/'/g, "")}', '${art.summary.substring(0, 100).replace(/'/g, "")}', this)">
                                    <i data-lucide="volume-2"></i> PLAY
                                </button>
                                <button class="analyze-btn" id="btn-${idx}" onclick="api.summarizeWithGemini('${art.headline.replace(/'/g, "")}', '${idx}')">
                                    <i data-lucide="sparkles" width="12"></i> ANALYZE
                                </button>
                            </div>
                        </div>
                        <div class="ai-summary-box" id="box-${idx}"></div>
                    `;
                    container.appendChild(div);
                });
                lucide.createIcons();
            },

            toggleChartType(type) { soundEngine.click(); state.chartType = type; if (state.currentCandles) this.renderChart(state.currentCandles); },
            toggleSMA() { soundEngine.click(); state.showSMA = !state.showSMA; const btn = document.getElementById('smaBtn'); if(state.showSMA) btn.classList.add('active'); else btn.classList.remove('active'); if(state.currentCandles) this.renderChart(state.currentCandles); },
            toggleExpandedChart() { soundEngine.click(); document.getElementById('expandedChartModal').classList.toggle('open'); if(document.getElementById('expandedChartModal').classList.contains('open')) this.renderExpandedChart(state.currentCandles); },
            renderExpandedChart(candles) { if (!candles || candles.s !== 'ok') return; const container = document.getElementById('expandedChartContainer'); container.innerHTML = ''; this.renderApexChart(container, candles, '100%'); },
            
            async loadSymbol(symbol) {
                state.currentSymbol = symbol; localStorage.setItem('nexus_last_symbol', symbol);
                if (state.chart) { state.chart.destroy(); state.chart = null; }
                if (state.rsiChart) { state.rsiChart.destroy(); state.rsiChart = null; }
                document.getElementById('mainChart').innerHTML = `<div style="text-align:center;"><i data-lucide="loader-2" class="fa-spin" style="margin-bottom:12px;"></i><div style="font-family: var(--font-mono);">ANALYZING ASSET...</div></div>`;
                lucide.createIcons();
                const quote = await api.getQuote(symbol);
                if (quote) {
                    document.getElementById('detailSymbol').innerText = symbol; document.getElementById('detailPrice').innerText = quote.c.toFixed(2); document.getElementById('detailChange').innerHTML = `<span class="${quote.d >= 0 ? 'text-green' : 'text-red'}">${quote.d.toFixed(2)} (${quote.dp.toFixed(2)}%)</span>`; document.getElementById('metricHigh').innerText = quote.h.toFixed(2); document.getElementById('metricLow').innerText = quote.l.toFixed(2);
                }
                const profile = await api.getProfile(symbol); const card = document.getElementById('assetProfile');
                if(profile && profile.name) { document.getElementById('detailName').innerText = profile.name; document.getElementById('pLogo').src = profile.logo || ''; document.getElementById('pLogo').style.display = profile.logo ? 'block' : 'none'; document.getElementById('pName').innerText = profile.name; document.getElementById('pIndustry').innerText = profile.finnhubIndustry; document.getElementById('metricCap').innerText = (profile.marketCapitalization / 1000).toFixed(2) + 'B'; document.getElementById('metricVol').innerText = (profile.shareOutstanding / 1000).toFixed(1) + 'M'; card.style.display = 'flex'; } else { card.style.display = 'none'; }
                const candles = await api.getCandles(symbol);
                if (candles && candles.s === 'ok') { state.currentCandles = candles; this.renderChart(candles); } else { document.getElementById('mainChart').innerHTML = `<div style="text-align:center; color: var(--neon-red); font-family: var(--font-mono);"><i data-lucide="alert-octagon"></i> DATA UNAVAILABLE</div>`; lucide.createIcons(); }
            },

            renderChart(candles) {
                const chartEl = document.querySelector("#mainChart"); const rsiEl = document.querySelector("#rsiChart"); chartEl.innerHTML = ""; rsiEl.innerHTML = "";
                this.renderApexChart(chartEl, candles, 220); this.renderRSI(rsiEl, candles);
            },

            renderApexChart(element, candles, height) {
                let seriesData = []; let chartOptions = { chart: { type: state.chartType, height: height, background: 'transparent', toolbar: { show: height !== 220 }, animations: { enabled: true } }, theme: { mode: state.currentTheme.includes('light') ? 'light' : 'dark' }, xaxis: { type: 'datetime', labels: { show: height !== 220, style: { colors: '#888899', fontFamily: 'JetBrains Mono' } }, axisBorder: { show: false }, axisTicks: { show: false } }, yaxis: { labels: { style: { colors: '#888899', fontFamily: 'JetBrains Mono' } } }, grid: { borderColor: state.currentTheme.includes('solarpunk') ? 'rgba(0,0,0,0.1)' : '#2a2a35', strokeDashArray: 4 }, stroke: { width: 2, curve: 'smooth' }, tooltip: { theme: 'dark', style: { fontFamily: 'JetBrains Mono' } } };
                if (state.chartType === 'candlestick') { seriesData = candles.t.map((t, i) => ({ x: new Date(t * 1000), y: [candles.o[i], candles.h[i], candles.l[i], candles.c[i]] })); chartOptions.plotOptions = { candlestick: { colors: { upward: '#00ff9d', downward: '#ff2a6d' }, wick: { useFillColor: true } } }; } else { seriesData = candles.t.map((t, i) => ({ x: new Date(t * 1000), y: candles.c[i] })); chartOptions.colors = ['#00ff9d']; if (state.chartType === 'area') { chartOptions.fill = { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.1, stops: [0, 90, 100], colorStops: [{ offset: 0, color: '#00ff9d', opacity: 0.4 }, { offset: 100, color: '#00ff9d', opacity: 0 }] } }; } }
                chartOptions.series = [{ name: 'Price', data: seriesData, type: state.chartType }];
                if(state.showSMA) { const smaData = []; const period = 20; for (let i = period - 1; i < candles.c.length; i++) { const sum = candles.c.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0); smaData.push({ x: new Date(candles.t[i] * 1000), y: sum / period }); } chartOptions.series.push({ name: 'SMA 20', type: 'line', data: smaData, color: '#ffb800' }); chartOptions.stroke.width = [2, 2]; }
                const chart = new ApexCharts(element, chartOptions); chart.render(); if (height === 220) state.chart = chart;
            },
            
            renderRSI(element, candles) {
                const period = 14; let rsiData = []; let gains = 0; let losses = 0;
                for (let i = 1; i <= period; i++) { const change = candles.c[i] - candles.c[i-1]; if (change > 0) gains += change; else losses -= change; }
                let avgGain = gains / period; let avgLoss = losses / period;
                for (let i = period + 1; i < candles.c.length; i++) {
                    const change = candles.c[i] - candles.c[i-1]; const gain = change > 0 ? change : 0; const loss = change < 0 ? -change : 0;
                    avgGain = ((avgGain * (period - 1)) + gain) / period; avgLoss = ((avgLoss * (period - 1)) + loss) / period;
                    const rs = avgGain / avgLoss; const rsi = 100 - (100 / (1 + rs));
                    rsiData.push({ x: new Date(candles.t[i] * 1000), y: rsi });
                }
                if(rsiData.length > 0) state.rsiValue = rsiData[rsiData.length-1].y;
                const options = { series: [{ name: 'RSI', data: rsiData }], chart: { type: 'line', height: 100, toolbar: { show: false }, background: 'transparent' }, theme: { mode: 'dark' }, colors: ['#bc13fe'], stroke: { width: 2 }, xaxis: { type: 'datetime', labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false }, tooltip: { enabled: false } }, yaxis: { min: 0, max: 100, tickAmount: 2, labels: { style: { colors: '#888899', fontFamily: 'JetBrains Mono' } } }, grid: { borderColor: state.currentTheme.includes('solarpunk') ? 'rgba(0,0,0,0.1)' : '#2a2a35', strokeDashArray: 4 }, annotations: { yaxis: [ { y: 70, borderColor: '#ff2a6d', strokeDashArray: 2, opacity: 0.5 }, { y: 30, borderColor: '#00ff9d', strokeDashArray: 2, opacity: 0.5 } ] }, tooltip: { theme: 'dark', x: { show: false } } };
                const chart = new ApexCharts(element, options); chart.render(); state.rsiChart = chart;
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
