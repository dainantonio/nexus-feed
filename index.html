<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS INTELLIGENCE | AI × Data × Energy × Policy</title>
    <!-- Performance: Preconnect to external domains -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://unpkg.com">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
    
    <!-- Performance: Defer non-critical scripts -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts" defer></script>
    
    <style>
        /* ===== CORE VARIABLES ===== */
        :root {
            --color-bg-dark: #0a0a0f;
            --color-bg-card: #13131f; 
            --color-bg-sidebar: #0e0e15;
            --color-electric-green: #00ff9d;
            --color-data-blue: #0095ff;
            --color-accent-purple: #8a2be2;
            --color-alert-red: #ff4757;
            --color-realestate-orange: #ff9f43;
            --color-text-primary: #ffffff;
            --color-text-secondary: #b0b0c0;
            --color-text-muted: #7a7a8a;
            --color-border: #2a2a3a;
            
            --tag-bg-energy: rgba(0, 255, 157, 0.1);
            --tag-bg-ai: rgba(0, 149, 255, 0.1);
            --tag-bg-policy: rgba(138, 43, 226, 0.1);
            --tag-bg-realestate: rgba(255, 159, 67, 0.1);
            
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            
            --scanline-color: rgba(0, 255, 157, 0.03);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-dark);
            color: var(--color-text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        /* Accessibility: Focus States */
        :focus-visible {
            outline: 2px solid var(--color-electric-green);
            outline-offset: 2px;
        }

        /* ===== MODERN SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-electric-green); }

        /* ===== TICKER ===== */
        .signal-ticker {
            grid-column: 1 / -1;
            background: linear-gradient(90deg, #0d0d14, #1a1a24);
            border-bottom: 1px solid var(--color-border);
            overflow: hidden;
            position: relative;
            height: 40px;
            display: flex;
            align-items: center;
            font-family: 'JetBrains Mono', monospace;
            contain: layout size; /* Performance: Isolate layout */
        }
        .ticker-wrap { width: 100%; overflow: hidden; position: relative; }
        .ticker { 
            display: flex; 
            animation: ticker-scroll 60s linear infinite; 
            white-space: nowrap; 
            padding-left: 100%;
            will-change: transform; /* Performance: Hint to browser */
        }
        .ticker:hover { animation-play-state: paused; }
        .ticker-item { padding: 0 3rem; color: var(--color-electric-green); font-size: 0.75rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; display: flex; align-items: center; gap: 10px; cursor: default; }
        @keyframes ticker-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* ===== CYBERPUNK EFFECTS ===== */
        .cyberpunk-active .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent 50%, var(--scanline-color) 51%);
            background-size: 100% 4px; z-index: 9998; pointer-events: none; animation: scanlines 8s linear infinite;
            will-change: background-position;
        }
        .cyberpunk-active .crt-flicker {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 2px; z-index: 9999; pointer-events: none; opacity: 0.1; animation: flicker 0.15s infinite;
        }
        .cyberpunk-active .glow-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(0, 255, 157, 0.05) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(0, 149, 255, 0.05) 0%, transparent 50%);
            z-index: 9997; pointer-events: none;
        }
        @keyframes scanlines { from { background-position: 0 0; } to { background-position: 0 8px; } }
        @keyframes flicker { 0% { opacity: 0.1; } 50% { opacity: 0.15; } 100% { opacity: 0.1; } }

        /* ===== MAP STYLES ===== */
        .map-marker-pulse {
            width: 14px; height: 14px;
            background: var(--color-electric-green);
            border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(0, 255, 157, 0.7);
            animation: markerPulse 2s infinite;
            border: 2px solid white;
            will-change: transform, box-shadow;
        }
        .map-marker-pulse.ai { background: var(--color-data-blue); box-shadow: 0 0 0 0 rgba(0, 149, 255, 0.7); animation: markerPulseAI 2s infinite; }
        .map-marker-pulse.policy { background: var(--color-accent-purple); box-shadow: 0 0 0 0 rgba(138, 43, 226, 0.7); animation: markerPulsePolicy 2s infinite; }
        .map-marker-pulse.realestate { background: var(--color-realestate-orange); box-shadow: 0 0 0 0 rgba(255, 159, 67, 0.7); animation: markerPulseRE 2s infinite; }
        .map-marker-pulse.high-impact { background: #ff4757; width: 18px; height: 18px; animation: markerPulseCritical 1s infinite; border-width: 3px; }

        @keyframes markerPulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 255, 157, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(0, 255, 157, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 255, 157, 0); } }
        @keyframes markerPulseAI { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 149, 255, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(0, 149, 255, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 149, 255, 0); } }
        @keyframes markerPulsePolicy { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(138, 43, 226, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(138, 43, 226, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(138, 43, 226, 0); } }
        @keyframes markerPulseRE { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 159, 67, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 159, 67, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 159, 67, 0); } }
        @keyframes markerPulseCritical { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(255, 71, 87, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); } }

        /* Custom Leaflet Popup */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: rgba(15, 15, 20, 0.95) !important;
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-border);
            color: #fff !important;
            border-radius: 8px !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .leaflet-popup-content { margin: 12px !important; line-height: 1.4; }
        .leaflet-container a.leaflet-popup-close-button { color: #aaa; }

        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);
            z-index: 10000; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s ease;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-content {
            background: var(--color-bg-card); border-radius: var(--border-radius);
            border: 1px solid var(--color-border); max-height: 85vh; width: 90%; max-width: 600px;
            overflow-y: auto; position: relative; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        }

        /* Search Modal */
        .search-header { padding: 25px; border-bottom: 1px solid var(--color-border); display: flex; align-items: center; gap: 15px; }
        .search-input { background: transparent; border: none; color: white; font-size: 1.4rem; width: 100%; outline: none; font-weight: 300; }
        .search-results { padding: 10px; }
        .search-result-item { padding: 15px 20px; border-radius: 8px; cursor: pointer; transition: var(--transition); display: flex; flex-direction: column; gap: 5px; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .search-result-item:hover { background: rgba(255,255,255,0.05); transform: translateX(5px); }
        .search-footer { padding: 15px 25px; border-top: 1px solid var(--color-border); font-size: 0.75rem; color: var(--color-text-muted); display: flex; justify-content: space-between; }

        /* Settings Modal */
        .settings-container { padding: 30px; }
        .setting-group { margin-bottom: 30px; }
        .setting-group h3 { font-size: 0.85rem; color: var(--color-text-muted); text-transform: uppercase; margin-bottom: 15px; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; }
        .setting-item { background: rgba(255,255,255,0.02); padding: 16px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); }
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.1); transition: .3s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--color-electric-green); }
        input:checked + .slider:before { transform: translateX(22px); }
        .setting-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--color-border); padding: 10px 12px; color: white; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; margin-top: 5px; }
        .setting-input:focus { border-color: var(--color-electric-green); outline: none; }

        /* Reader Modal */
        .reader-container { padding: 40px; font-family: 'Inter', sans-serif; }
        .reader-meta { display: flex; gap: 15px; margin-bottom: 20px; font-size: 0.85rem; color: var(--color-text-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 20px; }
        .reader-title { font-size: 2rem; font-weight: 800; line-height: 1.2; margin-bottom: 10px; color: white; text-transform: uppercase; letter-spacing: -0.5px; }
        .reader-content { font-size: 1.1rem; line-height: 1.8; color: #d0d0e0; }
        .reader-badge { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 4px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; }

        /* Help Modal */
        .help-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .help-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .help-key { font-family: 'JetBrains Mono', monospace; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); font-size: 0.8rem; }

        /* ===== LAYOUT ===== */
        .app-container {
            display: grid;
            grid-template-columns: 300px 1fr 360px;
            grid-template-rows: auto auto auto 1fr auto;
            min-height: 100vh;
        }

        .app-header {
            grid-column: 1 / -1;
            background: rgba(10, 10, 15, 0.8); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--color-border); padding: 1rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        .logo-container { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--color-electric-green), var(--color-data-blue)); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px rgba(0,255,157,0.3); }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .action-btn { width: 40px; height: 40px; border-radius: 10px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255,255,255,0.05); color: var(--color-text-secondary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); }
        .action-btn:hover, .action-btn.active { background: var(--color-electric-green); color: var(--color-bg-dark); border-color: var(--color-electric-green); box-shadow: 0 0 15px rgba(0,255,157,0.2); }
        
        .intelligence-aggregator { grid-column: 1 / -1; background: #0e0e15; padding: 1.5rem 2rem; border-bottom: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between; gap: 2rem; }
        
        /* Filter Container */
        .filter-container { grid-column: 1 / -1; padding: 1rem 2rem; display: flex; gap: 10px; flex-wrap: wrap; background: var(--color-bg-dark); border-bottom: 1px solid var(--color-border); }
        .filter-chip { padding: 0.6rem 1.4rem; background: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: 50px; font-size: 0.8rem; font-weight: 600; color: var(--color-text-secondary); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: var(--transition); letter-spacing: 0.5px; }
        .filter-chip:hover { border-color: var(--color-text-primary); color: var(--color-text-primary); transform: translateY(-2px); }
        .filter-chip.active { background: var(--color-text-primary); color: var(--color-bg-dark); border-color: var(--color-text-primary); box-shadow: 0 4px 12px rgba(255,255,255,0.2); }
        .filter-chip.active i { color: var(--color-bg-dark); }
        .filter-chip-count { font-size: 0.7rem; opacity: 0.7; margin-left: 4px; }

        .left-sidebar, .right-sidebar { background: var(--color-bg-sidebar); padding: 2rem; overflow-y: auto; height: calc(100vh - 180px); position: sticky; top: 180px; contain: content; }
        .left-sidebar { border-right: 1px solid var(--color-border); }
        .right-sidebar { border-left: 1px solid var(--color-border); }
        .sidebar-section { margin-bottom: 2.5rem; }
        .sidebar-section h3 { font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 1.2rem; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }

        .main-feed { padding: 2rem; overflow-y: auto; background: linear-gradient(180deg, var(--color-bg-dark) 0%, #08080c 100%); contain: content; content-visibility: auto; }
        .feed-header { display: flex; justify-content: space-between; margin-bottom: 2rem; align-items: center; }
        .feed-controls { display: flex; gap: 10px; align-items: center; }
        .sort-select { background: rgba(255,255,255,0.05); color: var(--color-text-primary); border: 1px solid var(--color-border); padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; outline: none; cursor: pointer; }
        
        /* ===== REDESIGNED CARD UI ===== */
        .news-card { 
            background: rgba(20, 20, 28, 0.6); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            border-radius: var(--border-radius); 
            padding: 1.8rem; 
            margin-bottom: 1.8rem; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            contain: content; /* Performance Optimization */
            content-visibility: auto;
        }
        
        /* Category Stripe */
        .news-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.1); transition: height 0.3s; }
        .news-card[data-category="ai"]::before { background: var(--color-data-blue); }
        .news-card[data-category="energy"]::before { background: var(--color-electric-green); }
        .news-card[data-category="policy"]::before { background: var(--color-accent-purple); }
        .news-card[data-category="realestate"]::before { background: var(--color-realestate-orange); }
        .news-card[data-category="breaking"]::before { background: var(--color-alert-red); height: 4px; }

        .news-card:hover { transform: translateY(-5px) scale(1.01); border-color: rgba(255, 255, 255, 0.2); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6); }
        .news-card:hover::before { height: 5px; }
        
        .news-card.highlight-card { animation: highlightFlash 1.5s ease; border-color: var(--color-data-blue); }
        @keyframes highlightFlash { 0% { box-shadow: 0 0 0 0 rgba(0, 149, 255, 0); } 50% { box-shadow: 0 0 30px 5px rgba(0, 149, 255, 0.3); border-color: var(--color-data-blue); } 100% { box-shadow: 0 0 0 0 rgba(0, 149, 255, 0); } }
        
        .card-header { display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 0.75rem; color: var(--color-text-muted); font-weight: 600; letter-spacing: 1px; text-transform: uppercase; font-family: 'JetBrains Mono', monospace; }
        .card-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 0.5rem; cursor: pointer; line-height: 1.3; color: #fff; text-transform: uppercase; letter-spacing: -0.5px; transition: color 0.2s; }
        .card-title:hover { color: var(--color-electric-green); text-shadow: 0 0 20px rgba(0,255,157,0.3); }
        
        .card-meta-line { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 1.2rem; font-family: 'JetBrains Mono', monospace; }
        .impact-score { color: var(--color-electric-green); font-weight: 700; background: rgba(0, 255, 157, 0.1); padding: 2px 6px; border-radius: 4px; }
        .impact-score.high { color: var(--color-alert-red); background: rgba(255, 71, 87, 0.15); }
        .velocity-score { display: flex; align-items: center; gap: 4px; color: #ff9f43; font-weight: 600; }

        .card-summary { color: #ccc; margin-bottom: 1.5rem; font-size: 1rem; line-height: 1.7; font-weight: 400; opacity: 0.9; }
        
        /* AI Analysis Section */
        .ai-analysis-container { margin-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 1.5rem; }
        .ai-analysis-btn { background: rgba(0, 149, 255, 0.08); color: var(--color-data-blue); border: 1px solid rgba(0, 149, 255, 0.2); width: 100%; padding: 14px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 700; font-size: 0.8rem; transition: var(--transition); letter-spacing: 1px; text-transform: uppercase; }
        .ai-analysis-btn:hover { background: rgba(0, 149, 255, 0.15); border-color: var(--color-data-blue); color: #fff; box-shadow: 0 0 15px rgba(0, 149, 255, 0.2); }
        .ai-content { margin-top: 15px; padding: 20px; background: rgba(0,0,0,0.4); border-radius: 10px; border-left: 3px solid var(--color-data-blue); font-size: 0.95rem; color: #e0e0e0; line-height: 1.7; display: none; }
        .ai-content.visible { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; }
        .card-tags { display: flex; gap: 8px; flex-wrap: wrap; }
        .tag { padding: 6px 14px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; }
        .tag.ai { background: var(--tag-bg-ai); color: var(--color-data-blue); border: 1px solid rgba(0,149,255,0.2); }
        .tag.energy { background: var(--tag-bg-energy); color: var(--color-electric-green); border: 1px solid rgba(0,255,157,0.2); }
        .tag.policy { background: var(--tag-bg-policy); color: var(--color-accent-purple); border: 1px solid rgba(138,43,226,0.2); }
        .tag.realestate { background: var(--tag-bg-realestate); color: var(--color-realestate-orange); border: 1px solid rgba(255,159,67,0.2); }
        
        .card-actions-right { display: flex; gap: 15px; }
        .card-action-btn { background: transparent; border: none; cursor: pointer; color: var(--color-text-muted); transition: all 0.2s; transform: scale(1); display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; }
        .card-action-btn:hover { color: var(--color-text-primary); transform: scale(1.15); background: rgba(255,255,255,0.05); }
        .card-action-btn.bookmarked { color: var(--color-electric-green); }
        .card-action-btn.speaking { color: var(--color-electric-green); animation: pulse-speak 1s infinite; }
        
        @keyframes pulse-speak { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Notification with Status Colors */
        .notification { position: fixed; top: 20px; right: 20px; background: var(--color-bg-card); padding: 15px 25px; border-radius: 12px; border-left: 4px solid var(--color-electric-green); z-index: 10001; box-shadow: 0 10px 40px rgba(0,0,0,0.5); transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); display: flex; align-items: center; gap: 12px; font-weight: 600; border: 1px solid rgba(255,255,255,0.05); }
        .notification.visible { transform: translateX(0); }
        .notification.error { border-left-color: var(--color-alert-red); }
        .notification.info { border-left-color: var(--color-data-blue); }
        .notification.success { border-left-color: var(--color-electric-green); }
        
        .breaking-banner { 
            background: linear-gradient(90deg, rgba(255, 71, 87, 0.9), rgba(255, 107, 129, 0.9)); 
            color: white; padding: 16px 24px; border-radius: 12px; margin-bottom: 2rem; 
            display: none; align-items: center; justify-content: space-between;
            gap: 15px; font-weight: 700; animation: pulse 2s infinite; 
            letter-spacing: 0.5px; font-size: 0.95rem; 
            box-shadow: 0 10px 30px rgba(255, 71, 87, 0.3);
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .breaking-banner:hover { transform: scale(1.01); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); } }

        /* Widget Containers */
        #miniMap { height: 320px; width: 100%; border-radius: 16px; z-index: 1; background: #1a1a20; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; position: relative; contain: strict; }
        .map-scan-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999;
            background: radial-gradient(circle, rgba(0,255,157,0.05) 0%, transparent 70%);
            animation: radarScan 4s infinite linear;
            opacity: 0;
            will-change: transform;
        }
        @keyframes radarScan { 0% { transform: scale(0); opacity: 0.5; } 100% { transform: scale(2); opacity: 0; } }

        .stat-grid { display: flex; flex-direction: column; gap: 15px; margin-top: 10px; }
        .health-bar-container { margin-bottom: 5px; }
        .health-label { display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: 600; color: var(--color-text-secondary); margin-bottom: 6px; }
        .health-progress-bg { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; }
        .health-progress-fill { height: 100%; background: var(--color-electric-green); width: 0%; transition: width 1s ease; border-radius: 4px; }

        /* Custom Chart Styles */
        .apexcharts-tooltip { background: #13131f !important; border: 1px solid rgba(255,255,255,0.1) !important; color: #fff !important; box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important; border-radius: 8px !important; }
        .apexcharts-tooltip-title { background: #0d0d14 !important; border-bottom: 1px solid rgba(255,255,255,0.1) !important; font-family: 'Inter', sans-serif !important; }
        .apexcharts-text { fill: #7a7a8a !important; font-family: 'Inter', sans-serif !important; }

        /* Collapsible Intelligence Brief */
        .brief-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .brief-header:hover { color: var(--color-text-primary); }
        .brief-content-wrapper { transition: max-height 0.3s ease, opacity 0.3s ease; max-height: 500px; opacity: 1; overflow: hidden; }
        .brief-content-wrapper.collapsed { max-height: 0; opacity: 0; }
        .tldr-card { 
            background: rgba(20, 20, 28, 0.8); padding: 1.2rem; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid var(--color-electric-green); display: flex; gap: 15px; align-items: flex-start; transition: var(--transition); cursor: pointer; border: 1px solid rgba(255,255,255,0.05);
        }
        .tldr-card:hover { transform: translateX(5px); background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .tldr-number { font-size: 1.2rem; font-weight: 800; color: rgba(255,255,255,0.15); font-family: 'JetBrains Mono'; line-height: 1; }
        .tldr-content h4 { font-size: 0.9rem; font-weight: 700; color: #e0e0e0; margin-bottom: 5px; text-transform: uppercase; line-height: 1.4; }
        .tldr-meta { font-size: 0.7rem; color: var(--color-text-muted); font-family: 'JetBrains Mono'; }

        /* Enhanced Sentiment Gauge */
        .sentiment-gauge-wrapper { position: relative; height: 180px; display: flex; justify-content: center; align-items: center; }
        .sentiment-value-overlay { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .sentiment-score { font-size: 2.2rem; font-weight: 800; color: #fff; line-height: 1; font-family: 'JetBrains Mono'; }
        .sentiment-text { font-size: 0.75rem; color: var(--color-text-muted); letter-spacing: 2px; margin-top: 5px; text-transform: uppercase; }

        /* Empty State */
        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem 2rem; color: var(--color-text-muted); text-align: center;
        }
        .empty-state i { margin-bottom: 1rem; opacity: 0.5; }

        /* Footer */
        .app-footer {
            grid-column: 1 / -1;
            background: #0a0a0f;
            border-top: 1px solid var(--color-border);
            padding: 0.8rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            color: var(--color-text-muted);
            font-family: 'JetBrains Mono', monospace;
            z-index: 10;
        }
        .footer-status { display: flex; gap: 15px; align-items: center; }
        .footer-status-item { display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--color-electric-green); box-shadow: 0 0 5px var(--color-electric-green); }
        .footer-center { opacity: 0.5; letter-spacing: 1px; }
        .footer-links { display: flex; gap: 20px; }
        .footer-link { color: var(--color-text-secondary); text-decoration: none; transition: color 0.2s; }
        .footer-link:hover { color: var(--color-electric-green); }

        @media (max-width: 1200px) { .app-container { grid-template-columns: 260px 1fr 300px; } }
        @media (max-width: 1024px) { .app-container { grid-template-columns: 240px 1fr; } .right-sidebar { display: none; } }
        @media (max-width: 768px) { .app-container { grid-template-columns: 1fr; } .left-sidebar { display: none; } .filter-container { overflow-x: auto; flex-wrap: nowrap; } .news-card { padding: 1.2rem; } .app-footer { flex-direction: column; gap: 10px; padding: 1rem; text-align: center; } }
    </style>
</head>
<body>

    <div class="scanlines" style="display: none;"></div>
    <div class="crt-flicker" style="display: none;"></div>
    <div class="glow-overlay" style="display: none;"></div>

    <div id="notificationArea" class="notification">
        <i data-lucide="check-circle" style="color: var(--color-electric-green)"></i>
        <span id="notificationText">System Ready</span>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="searchModal">
        <div class="modal-content">
            <div class="search-container">
                <div class="search-header">
                    <i data-lucide="search" style="color: var(--color-electric-green);"></i>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search global intelligence stream..." aria-label="Search">
                    <button class="action-btn" id="closeSearchBtn" aria-label="Close Search"><i data-lucide="x"></i></button>
                </div>
                <div class="search-results" id="searchResults">
                    <div style="padding: 40px; text-align: center; color: var(--color-text-muted);">
                        <i data-lucide="command" style="margin-bottom: 10px; opacity: 0.5;"></i><br>
                        Start typing to search titles, sources, and summaries...
                    </div>
                </div>
                <div class="search-footer">
                    <span><span style="border: 1px solid #333; padding: 2px 6px; border-radius: 4px;">ESC</span> to close</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Reader Modal -->
    <div class="modal-overlay" id="readerModal">
        <div class="modal-content">
            <div class="reader-container">
                <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                    <button class="action-btn" onclick="document.getElementById('readerModal').classList.remove('active')" aria-label="Close Reader"><i data-lucide="x"></i></button>
                </div>
                <h1 id="readerTitle" class="reader-title">Article Title</h1>
                <div class="reader-meta">
                    <span id="readerSource">Source</span>
                    <span>•</span>
                    <span id="readerTime">Time</span>
                    <span id="readerTag" class="reader-badge">TAG</span>
                </div>
                <div id="readerBody" class="reader-content"></div>
                <div style="margin-top: 30px; border-top: 1px solid var(--color-border); padding-top: 20px;">
                    <h3 style="color: var(--color-electric-green); font-size: 0.9rem; margin-bottom: 10px;">INTELLIGENCE SUMMARY</h3>
                    <div id="readerAiSummary" style="font-size: 0.95rem; color: #aaa; background: rgba(0,255,157,0.05); padding: 15px; border-radius: 8px;"></div>
                </div>
                <div style="margin-top: 20px; display:flex; justify-content:center;">
                    <button class="ai-analysis-btn" id="readerExternalLink" style="width: auto; padding: 10px 25px;">OPEN ORIGINAL SOURCE <i data-lucide="external-link" size="14"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal-content">
            <div class="settings-container">
                <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
                    <h2><i data-lucide="keyboard" style="color: var(--color-electric-green); margin-right: 10px;"></i> Shortcuts</h2>
                    <button class="action-btn" onclick="document.getElementById('helpModal').classList.remove('active')" aria-label="Close Help"><i data-lucide="x"></i></button>
                </div>
                <div class="help-grid">
                    <div class="help-item"><span>Search</span> <span class="help-key">Cmd + K</span></div>
                    <div class="help-item"><span>Refresh Data</span> <span class="help-key">R</span></div>
                    <div class="help-item"><span>Toggle Settings</span> <span class="help-key">S</span></div>
                    <div class="help-item"><span>Close Modals</span> <span class="help-key">Esc</span></div>
                    <div class="help-item"><span>Help</span> <span class="help-key">?</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="settings-container">
                <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
                    <h2><i data-lucide="settings" style="color: var(--color-electric-green); margin-right: 10px;"></i> System Config</h2>
                    <button class="action-btn" id="closeSettingsBtn" aria-label="Close Settings"><i data-lucide="x"></i></button>
                </div>
                <div class="setting-group">
                    <h3><i data-lucide="eye"></i> Interface</h3>
                    <div class="setting-item">
                        <div>
                            <div style="font-weight: 500;">Cyberpunk Mode</div>
                            <div style="font-size: 0.8rem; color: var(--color-text-muted);">Scanlines & CRT effects</div>
                        </div>
                        <label class="switch"><input type="checkbox" id="cyberpunkToggle"><span class="slider"></span></label>
                    </div>
                </div>
                <div class="setting-group">
                    <h3><i data-lucide="bell"></i> Data Stream</h3>
                    <div class="setting-item">
                        <div>
                            <div style="font-weight: 500;">Breaking News Alerts</div>
                            <div style="font-size: 0.8rem; color: var(--color-text-muted);">Top banner for high impact events</div>
                        </div>
                        <label class="switch"><input type="checkbox" id="breakingNewsToggle" checked><span class="slider"></span></label>
                    </div>
                    <div class="setting-item">
                        <div>
                            <div style="font-weight: 500;">Live Simulation</div>
                            <div style="font-size: 0.8rem; color: var(--color-text-muted);">Inject mock events every 45s</div>
                        </div>
                        <label class="switch"><input type="checkbox" id="liveSimToggle"><span class="slider"></span></label>
                    </div>
                </div>
                <div class="setting-group">
                    <h3><i data-lucide="key"></i> API Configuration</h3>
                    <input type="password" id="geminiKey" class="setting-input" placeholder="Gemini API Key">
                    <input type="password" id="newsApiKey" class="setting-input" placeholder="NewsAPI Key">
                    <input type="password" id="gnewsApiKey" class="setting-input" placeholder="GNews API Key">
                </div>
                <button id="saveSettingsBtn" style="width: 100%; padding: 14px; background: var(--color-electric-green); border: none; border-radius: 8px; font-weight: 700; cursor: pointer; color: #000;">SAVE CONFIGURATION</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="signal-ticker">
        <div class="ticker-wrap">
            <div class="ticker">
                <div class="ticker-item"><i data-lucide="activity"></i> SYSTEM ONLINE</div>
                <div class="ticker-item"><i data-lucide="globe"></i> MONITORING GLOBAL GRIDS</div>
                <div class="ticker-item"><i data-lucide="cpu"></i> AI TRAINING RUN DETECTED</div>
                <div class="ticker-item"><i data-lucide="scale"></i> EU AI ACT COMPLIANCE CHECK</div>
                <div class="ticker-item"><i data-lucide="zap"></i> DATA CENTER LOAD: NOMINAL</div>
                <div class="ticker-item"><i data-lucide="trending-up"></i> NVIDIA STOCK VOLATILITY</div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <header class="app-header">
            <div class="logo-container">
                <div class="logo-icon"><i data-lucide="aperture" style="color: #0a0a0f;"></i></div>
                <div>
                    <h1 style="font-size: 1.2rem; font-weight: 800; letter-spacing: -0.5px;">NEXUS INTELLIGENCE</h1>
                    <div style="font-size: 0.65rem; color: var(--color-text-muted); letter-spacing: 1.5px; font-weight: 600;">AI × DATA × ENERGY × POLICY</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="action-btn" id="tldrToggleBtn" title="TL;DR Mode" aria-label="TLDR Mode"><i data-lucide="list"></i></button>
                <div id="systemClock" style="font-family: 'JetBrains Mono'; font-size: 0.8rem; color: var(--color-electric-green); border: 1px solid rgba(0,255,157,0.2); padding: 8px 12px; border-radius: 8px; margin-right: 10px;">00:00:00 UTC</div>
                <button class="action-btn" id="refreshBtn" title="Refresh Feed" aria-label="Refresh"><i data-lucide="refresh-cw"></i></button>
                <button class="action-btn" id="triggerSearchBtn" title="Search (Cmd+K)" aria-label="Search"><i data-lucide="search"></i></button>
                <button class="action-btn" id="triggerSettingsBtn" title="Settings" aria-label="Settings"><i data-lucide="settings"></i></button>
            </div>
        </header>

        <div class="intelligence-aggregator">
            <div style="flex:1">
                <div style="font-size: 0.75rem; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">Global Threat Level</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #fff;">MODERATE <span style="font-size: 0.8rem; color: var(--color-electric-green); font-weight: 400;">STABLE</span></div>
            </div>
            <div style="width: 200px; display:flex; flex-direction:column; gap:5px;">
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:var(--color-text-muted);"><span>CONFIDENCE</span><span>94%</span></div>
                <div style="height:6px; background:rgba(255,255,255,0.1); border-radius:3px;"><div style="width:94%; height:100%; background:var(--color-data-blue); border-radius:3px;"></div></div>
            </div>
        </div>

        <div class="filter-container">
            <div class="filter-chip active" data-filter="all"><i data-lucide="layers" size="14"></i> ALL NEXUS <span class="filter-chip-count"></span></div>
            <div class="filter-chip" data-filter="ai"><i data-lucide="cpu" size="14"></i> AI <span class="filter-chip-count"></span></div>
            <div class="filter-chip" data-filter="energy"><i data-lucide="zap" size="14"></i> ENERGY <span class="filter-chip-count"></span></div>
            <div class="filter-chip" data-filter="realestate"><i data-lucide="building" size="14"></i> REAL ESTATE <span class="filter-chip-count"></span></div>
            <div class="filter-chip" data-filter="policy"><i data-lucide="scale" size="14"></i> POLICY <span class="filter-chip-count"></span></div>
            <div class="filter-chip" data-filter="breaking"><i data-lucide="alert-circle" size="14"></i> BREAKING <span class="filter-chip-count"></span></div>
            <div class="filter-chip" data-filter="saved"><i data-lucide="bookmark" size="14"></i> SAVED <span class="filter-chip-count"></span></div>
        </div>

        <aside class="left-sidebar">
            <div class="sidebar-section">
                <h3><i data-lucide="map"></i> GEOSPATIAL INTEL</h3>
                <div id="miniMap">
                    <div class="map-scan-overlay"></div>
                </div>
            </div>
            <div class="sidebar-section">
                <h3><i data-lucide="pie-chart"></i> IMPACT DISTRIBUTION</h3>
                <div id="impactChart"></div>
            </div>
            <div class="sidebar-section">
                <h3><i data-lucide="hash"></i> TRENDING TOPICS</h3>
                <div id="trendingContainer" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
            </div>
        </aside>

        <main class="main-feed" id="mainFeed">
            <div id="breakingBanner" class="breaking-banner">
                <div style="display:flex; align-items:center; gap:12px;">
                    <i data-lucide="alert-triangle"></i>
                    <span id="breakingText">BREAKING: MAJOR REGULATORY SHIFT DETECTED</span>
                </div>
                <i data-lucide="arrow-right" size="16"></i>
            </div>

            <div class="feed-header">
                <div style="display:flex; align-items:center; gap: 15px;">
                    <h2 id="feedTitle" style="font-size:1.1rem; font-weight:700;">LIVE INTELLIGENCE</h2>
                    <span style="font-size:0.75rem; background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:4px;"><span id="articleCount">0</span> NODES</span>
                </div>
                <div class="feed-controls">
                    <select id="sortSelect" class="sort-select" aria-label="Sort Articles">
                        <option value="latest">Latest</option>
                        <option value="impact">Highest Impact</option>
                    </select>
                </div>
            </div>

            <div id="articlesContainer"></div>
        </main>

        <aside class="right-sidebar">
            <div class="sidebar-section">
                <div class="brief-header" onclick="toggleBrief()">
                    <h3><i data-lucide="list"></i> TOP INTELLIGENCE BRIEF</h3>
                    <i data-lucide="chevron-up" id="briefChevron" style="width:16px; transition: transform 0.3s;"></i>
                </div>
                <div id="topBriefWidget" class="brief-content-wrapper">
                    <!-- Filled by JS -->
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i data-lucide="gauge"></i> MARKET SENTIMENT</h3>
                <div class="sentiment-gauge-wrapper">
                    <div id="sentimentRadialChart"></div>
                    <div class="sentiment-value-overlay">
                        <div id="sentimentValue" class="sentiment-score">--</div>
                        <div id="sentimentText" class="sentiment-text">ANALYZING</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i data-lucide="activity"></i> SYSTEM HEALTH</h3>
                <div class="stat-grid">
                    <div class="health-bar-container">
                        <div class="health-label"><span>CPU LOAD</span><span style="color:#00ff9d">32%</span></div>
                        <div class="health-progress-bg"><div class="health-progress-fill" style="width:32%"></div></div>
                    </div>
                    <div class="health-bar-container">
                        <div class="health-label"><span>MEMORY</span><span style="color:#0095ff">14.2GB</span></div>
                        <div class="health-progress-bg"><div class="health-progress-fill" style="width:45%; background:#0095ff"></div></div>
                    </div>
                    <div class="health-bar-container">
                        <div class="health-label"><span>NETWORK</span><span style="color:#8a2be2">1.2GB/s</span></div>
                        <div class="health-progress-bg"><div class="health-progress-fill" style="width:78%; background:#8a2be2"></div></div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.2rem;">
                    <h3 style="margin-bottom:0"><i data-lucide="bookmark"></i> QUICK SAVED</h3>
                    <button id="downloadBriefBtn" style="background:none; border:none; color:var(--color-electric-green); cursor:pointer; font-size:0.7rem; font-weight:700; display:none; letter-spacing:0.5px;">
                        <i data-lucide="download" size="12" style="margin-right:4px;"></i> EXPORT
                    </button>
                </div>
                <div id="quickSavedList" style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 12px;">
                    <span style="color: var(--color-text-muted); font-style: italic; font-size: 0.8rem;">No bookmarks yet.</span>
                </div>
            </div>
        </aside>

        <!-- FOOTER -->
        <footer class="app-footer">
            <div class="footer-status">
                <div class="footer-status-item"><div class="status-dot"></div><span>SECURE TLS v1.3</span></div>
                <div class="footer-status-item"><span>LATENCY: <span id="footerLatency">12ms</span></span></div>
            </div>
            <div class="footer-center">NEXUS INTELLIGENCE v4.0.2 (BETA) | © 2026</div>
            <div class="footer-links">
                <a href="#" class="footer-link">API DOCS</a>
                <a href="#" class="footer-link">SYSTEM LOGS</a>
                <a href="#" class="footer-link">PRIVACY</a>
                <a href="#" class="footer-link">TERMS</a>
            </div>
        </footer>
    </div>

    <script>
        // Lucide is deferred, so we wait for DOMContentLoaded + check for it
        
        // ===== APP STATE =====
        const appState = {
            articles: [],
            savedArticles: JSON.parse(localStorage.getItem('nexus_saved') || '[]'),
            settings: JSON.parse(localStorage.getItem('nexus_settings') || '{"cyberpunk":false, "breakingNews":true, "liveSim":false, "geminiKey":"", "newsApiKey":"", "gnewsApiKey":""}'),
            currentFilter: 'all',
            map: null,
            markers: {},
            charts: { sentiment: null, impact: null },
            simInterval: null,
            clockInterval: null,
            tldrMode: false,
            briefCollapsed: false,
            cache: {
                data: null,
                timestamp: 0,
                duration: 5 * 60 * 1000 // 5 minutes cache
            }
        };

        // ===== MOCK DATA =====
        const generateMockData = () => {
            const sources = [
                { name: 'Reuters', baseUrl: 'https://www.reuters.com/site-search/?query=' },
                { name: 'TechCrunch', baseUrl: 'https://techcrunch.com/?s=' },
                { name: 'Bloomberg', baseUrl: 'https://www.bloomberg.com/search?query=' },
                { name: 'Wired', baseUrl: 'https://www.wired.com/search/?q=' },
                { name: 'The Verge', baseUrl: 'https://www.theverge.com/search?q=' }
            ];
            
            const topics = [
                { title: "NVIDIA Announces New Blackwell Chip Efficiency", tag: "ai", impact: "high", score: 9.2 },
                { title: "Global Energy Grid Strain due to AI Data Centers", tag: "energy", impact: "high", score: 8.8 },
                { title: "EU Passes Comprehensive AI Regulation Act", tag: "policy", impact: "medium", score: 7.5 },
                { title: "Nuclear Fusion Breakthrough at Lawrence Livermore", tag: "energy", impact: "high", score: 9.5 },
                { title: "Google DeepMind Solves Protein Folding at Scale", tag: "ai", impact: "medium", score: 7.2 },
                { title: "Tesla Energy Deployments Hit Record High", tag: "energy", impact: "medium", score: 6.8 },
                { title: "White House Executive Order on Crypto Mining", tag: "policy", impact: "medium", score: 7.0 },
                { title: "AWS Invests $10B in Nuclear-Powered Data Centers", tag: "ai", impact: "high", score: 8.9 },
                { title: "Blackstone Acquires Digital Realty Portfolio for $7B", tag: "realestate", impact: "high", score: 8.5 },
                { title: "Data Center Land Prices Surge in Northern Virginia", tag: "realestate", impact: "medium", score: 7.4 },
                { title: "Microsoft & BlackRock Launch $30B AI Infrastructure Fund", tag: "ai", impact: "high", score: 9.1 },
                { title: "Grid Congestion: Renewables Face Interconnection Delays", tag: "energy", impact: "medium", score: 6.5 }
            ];

            return topics.map((t, i) => {
                const src = sources[Math.floor(Math.random() * sources.length)];
                const deepLink = src.baseUrl + encodeURIComponent(t.title);
                return {
                    id: `art_${i}_${Date.now()}`,
                    title: t.title,
                    summary: "Market analysis indicates significant movement following this announcement. Sector impact projected to be substantial over the next quarter.",
                    source: src.name,
                    url: deepLink, 
                    timeObj: new Date(Date.now() - Math.floor(Math.random() * 86400000)),
                    time: `${Math.floor(Math.random() * 12) + 1}h ago`,
                    tag: t.tag,
                    impact: t.impact,
                    impactScore: t.score || (Math.random() * 4 + 5).toFixed(1),
                    lat: 20 + Math.random() * 40, 
                    lng: -100 + Math.random() * 100,
                    aiAnalysis: null 
                };
            });
        };

        // ===== AI LOGIC (GEMINI) =====
        async function performGeminiAnalysis(article) {
            const key = appState.settings.geminiKey;
            if (!key) {
                return `
                    <strong><i class="fas fa-robot"></i> NEXUS AI BRIEF (SIMULATED):</strong><br>
                    <ul style="margin-top:10px; padding-left:20px;">
                        <li><strong>Impact:</strong> High probability of affecting ${article.tag.toUpperCase()} sector stocks.</li>
                        <li><strong>Risk:</strong> Moderate short-term volatility expected.</li>
                        <li><strong>Strategy:</strong> Monitor regulatory filings in the next 48h.</li>
                    </ul>
                    <small style="color: #666; display:block; margin-top:10px;">*Add Gemini API key in Settings for real-time analysis.*</small>
                `;
            }

            try {
                // Modified prompt for 3 bullet points
                const prompt = `Analyze this news headline and summary for the ${article.tag} sector. Provide exactly 3 short bullet points: 1) Market Impact, 2) Risk Level, 3) Strategic Action. Format as HTML <ul> list. Keep it very concise. Title: "${article.title}". Summary: "${article.summary}"`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return text ? `<strong><i class="fas fa-brain"></i> GEMINI INTEL:</strong><br>${text}` : "Analysis Unavailable";
            } catch (error) { return "AI Analysis Connection Failed. Please check API Key."; }
        }

        // ===== RSS FETCHING =====
        async function fetchRSS() {
            const rssFeeds = [
                "https://techcrunch.com/category/artificial-intelligence/feed/",
                "https://www.wired.com/feed/category/science/latest/rss",
                "https://www.theverge.com/rss/index.xml"
            ];
            const proxy = "https://api.rss2json.com/v1/api.json?rss_url=";
            let articles = [];
            
            const promises = rssFeeds.map(async url => {
                try {
                    const res = await fetch(proxy + encodeURIComponent(url));
                    const data = await res.json();
                    if(data.status === 'ok') {
                        return data.items.map(item => ({
                            id: `rss_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,
                            title: item.title,
                            summary: item.description ? item.description.replace(/<[^>]*>?/gm, '').substring(0, 150) + "..." : "Click to read full story.",
                            source: data.feed.title || "RSS Feed",
                            url: item.link, 
                            timeObj: new Date(item.pubDate),
                            time: new Date(item.pubDate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                            tag: determineTag(item.title, item.description),
                            impact: 'medium', impactScore: (Math.random() * 3 + 5).toFixed(1),
                            lat: (Math.random() * 100) - 50, lng: (Math.random() * 360) - 180, aiAnalysis: null
                        }));
                    }
                } catch(e) { console.warn("RSS Fetch Error", e); }
                return [];
            });
            const results = await Promise.all(promises);
            results.forEach(arr => articles = [...articles, ...arr]);
            return articles;
        }

        function determineTag(title, desc) {
            const text = (title + " " + (desc||"")).toLowerCase();
            if(text.includes('energy') || text.includes('nuclear') || text.includes('grid')) return 'energy';
            if(text.includes('policy') || text.includes('regulation') || text.includes('law')) return 'policy';
            if(text.includes('real estate') || text.includes('data center')) return 'realestate';
            return 'ai';
        }

        // ===== DATA FETCHING with CACHE =====
        async function fetchRealNews() {
            // Check Cache
            const now = Date.now();
            if (appState.cache.data && (now - appState.cache.timestamp < appState.cache.duration)) {
                console.log("Serving from Session Cache");
                return appState.cache.data;
            }

            let newsData = [];
            // Placeholder for real APIs
            if (appState.settings.gnewsApiKey) { /* GNews Placeholder */ }
            
            // RSS Logic
            if (newsData.length === 0) { 
                const rss = await fetchRSS(); 
                if(rss.length > 0) newsData = rss; 
            }
            
            // Mock Fallback
            if (newsData.length === 0) newsData = generateMockData();

            // Update Cache
            appState.cache.data = newsData;
            appState.cache.timestamp = now;
            
            return newsData;
        }

        // ===== SIMULATION =====
        function startLiveSimulation() {
            if (appState.simInterval) clearInterval(appState.simInterval);
            if (!appState.settings.liveSim) return;
            appState.simInterval = setInterval(() => {
                const mock = generateMockData()[Math.floor(Math.random() * 10)];
                mock.id = `live_${Date.now()}`; mock.time = "JUST NOW"; mock.timeObj = new Date();
                mock.impact = "high"; mock.impactScore = "9.2";
                mock.title = "[LIVE INCOMING] " + mock.title;
                appState.articles.unshift(mock);
                refreshUIComponents();
                showNotification("INCOMING INTEL RECEIVED", "info");
            }, 45000); 
        }

        function startClock() {
            if(appState.clockInterval) clearInterval(appState.clockInterval);
            appState.clockInterval = setInterval(() => {
                const now = new Date();
                document.getElementById('systemClock').innerText = now.toISOString().split('T')[1].split('.')[0] + " UTC";
                
                // Update Latency
                const latency = Math.floor(Math.random() * 20) + 10;
                const latEl = document.getElementById('footerLatency');
                if(latEl) latEl.innerText = `${latency}ms`;
            }, 1000);
        }

        // ===== INIT =====
        function init() {
            // Wait for deferred scripts if needed
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', onReady);
            } else {
                onReady();
            }
        }
        
        function onReady() {
             // Init Lucide if available, else retry shortly
             if(window.lucide) {
                 window.lucide.createIcons();
             } else {
                 setTimeout(() => window.lucide && window.lucide.createIcons(), 500);
             }
             
             applySettings(); 
             initCharts(); 
             initMap(); 
             refreshData(); 
             setupEventListeners(); 
             startLiveSimulation(); 
             startClock();
        }

        // Utility: Debounce Function for Performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function calculateReadTime(text) {
            const wpm = 225;
            const words = text.trim().split(/\s+/).length;
            return Math.ceil(words / wpm);
        }

        async function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            const icon = refreshBtn?.querySelector('svg') || refreshBtn?.querySelector('i');
            if(icon) icon.classList.add('fa-spin'); // Fallback class if lucide not ready
            
            // Only update DOM if necessary
            if (appState.articles.length === 0) renderSkeletonLoader(); 
            
            const newArticles = await fetchRealNews();
            
            // Basic Diff Check (Optimization)
            if (newArticles.length !== appState.articles.length || newArticles[0]?.id !== appState.articles[0]?.id) {
                appState.articles = newArticles;
                appState.articles.sort((a, b) => b.timeObj - a.timeObj);
                appState.articles.forEach(art => { if(appState.savedArticles.includes(art.id)) art.bookmarked = true; });
                refreshUIComponents();
            } else {
                console.log("Data up to date, skipping re-render.");
            }

            if(icon) icon.classList.remove('fa-spin');
            showNotification("Data Stream Synced", "success");
        }

        function refreshUIComponents() {
            renderFeed(); checkBreakingNews(); updateQuickSaved(); updateMapMarkers(); updateCharts(); updateAnalytics(); updateTLDRWidget(); updateFilterCounts();
            if(window.lucide) window.lucide.createIcons();
        }

        function updateFilterCounts() {
            const counts = { all: appState.articles.length, ai: 0, energy: 0, realestate: 0, policy: 0, breaking: 0, saved: appState.savedArticles.length };
            appState.articles.forEach(a => {
                if(counts[a.tag] !== undefined) counts[a.tag]++;
                if(a.impact === 'high') counts.breaking++;
            });
            
            document.querySelectorAll('.filter-chip').forEach(chip => {
                const type = chip.dataset.filter;
                const countSpan = chip.querySelector('.filter-chip-count');
                if(countSpan && counts[type] !== undefined) countSpan.innerText = `(${counts[type]})`;
            });
        }

        function renderSkeletonLoader() {
            const container = document.getElementById('articlesContainer');
            container.innerHTML = Array(4).fill(0).map(() => `
                <div class="news-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text" style="width: 80%;"></div><div style="margin-top: 15px;"><div class="skeleton skeleton-tag"></div></div></div>
            `).join('');
        }

        // ===== CHARTS & WIDGETS =====
        function toggleBrief() {
            appState.briefCollapsed = !appState.briefCollapsed;
            const container = document.getElementById('topBriefWidget');
            const chevron = document.getElementById('briefChevron');
            if (appState.briefCollapsed) {
                container.classList.add('collapsed');
                if(chevron) chevron.style.transform = 'rotate(180deg)';
            } else {
                container.classList.remove('collapsed');
                if(chevron) chevron.style.transform = 'rotate(0deg)';
            }
        }

        function updateTLDRWidget() {
            const container = document.getElementById('topBriefWidget');
            const topArticles = [...appState.articles].sort((a,b) => b.impactScore - a.impactScore).slice(0, 3);
            
            container.innerHTML = topArticles.map((a, i) => `
                <div class="tldr-card" onclick="window.open('${a.url}', '_blank')">
                    <div class="tldr-number">${i+1}.</div>
                    <div class="tldr-content">
                        <h4>${a.title}</h4>
                        <div class="tldr-meta">${a.source} • ${a.time} • Impact: <span style="color:${a.impactScore > 8 ? '#ff4757' : '#00ff9d'}">${a.impactScore}</span></div>
                    </div>
                </div>
            `).join('');
        }

        function initCharts() {
            // Enhanced Multi-Color Semi-Circle Gauge
            const sentimentOpts = {
                chart: { type: 'radialBar', height: 260, background: 'transparent', animations: { enabled: true, easing: 'easeinout', speed: 800 } },
                series: [0],
                colors: ['#00ff9d'],
                plotOptions: {
                    radialBar: {
                        startAngle: -90, endAngle: 90,
                        hollow: { margin: 0, size: '65%', background: 'transparent' },
                        track: { background: '#2a2a3a', strokeWidth: '100%', margin: 5 },
                        dataLabels: { 
                            show: false 
                        }
                    }
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark', type: 'horizontal', shadeIntensity: 0.5,
                        gradientToColors: ['#ff4757'], inverseColors: false,
                        opacityFrom: 1, opacityTo: 1, stops: [0, 100]
                    }
                },
                stroke: { lineCap: 'butt' }
            };
            if(document.querySelector("#sentimentRadialChart")) {
                 appState.charts.sentiment = new ApexCharts(document.querySelector("#sentimentRadialChart"), sentimentOpts);
                 appState.charts.sentiment.render();
            }

            const impactOpts = {
                chart: { type: 'donut', height: 220, background: 'transparent' },
                series: [],
                labels: ['High Impact', 'Medium Impact', 'Low Impact'],
                colors: ['#ff4757', '#ffa502', '#0095ff'],
                legend: { show: false },
                plotOptions: { pie: { donut: { size: '75%', labels: { show: true, total: { show: true, showAlways: true, label: 'EVENTS', color: '#fff', fontSize: '14px' }, value: { color: '#fff', fontSize: '20px', fontWeight: 700 } } } } },
                dataLabels: { enabled: false },
                stroke: { width: 0 }
            };
            if(document.querySelector("#impactChart")) {
                appState.charts.impact = new ApexCharts(document.querySelector("#impactChart"), impactOpts);
                appState.charts.impact.render();
            }
        }

        function updateCharts() {
            if(!appState.charts.impact || !appState.charts.sentiment) return;
            const impacts = { high: 0, medium: 0, low: 0 };
            appState.articles.forEach(a => {
                const imp = a.impact ? a.impact.toLowerCase() : 'low';
                if(impacts[imp] !== undefined) impacts[imp]++; else impacts.low++;
            });
            appState.charts.impact.updateSeries([impacts.high, impacts.medium, impacts.low]);
        }

        function updateAnalytics() {
            const allText = appState.articles.map(a => a.title).join(' ').toLowerCase();
            const stopWords = ['the', 'and', 'to', 'of', 'in', 'a', 'for', 'on', 'with', 'new', 'at', 'is', 'by', 'announces', 'launches', 'passes'];
            const words = allText.split(/\W+/).filter(w => w.length > 3 && !stopWords.includes(w));
            
            const freq = {};
            words.forEach(w => freq[w] = (freq[w] || 0) + 1);
            const sortedTags = Object.entries(freq).sort((a,b) => b[1] - a[1]).slice(0, 6).map(e => e[0]);
            document.getElementById('trendingContainer').innerHTML = sortedTags.map(t => `<span class="tag" style="background: rgba(255,255,255,0.05); border: 1px solid var(--color-border); font-size: 0.65rem;">#${t.toUpperCase()}</span>`).join('');

            // Sentiment Calculation
            const positive = ['surge', 'record', 'breakthrough', 'success', 'growth', 'fund', 'invests', 'launches', 'advances', 'gain'];
            const negative = ['strain', 'delays', 'congestion', 'crisis', 'ban', 'lawsuit', 'warning', 'drop', 'outage'];
            let totalScore = 50;
            appState.articles.forEach(a => {
                const text = (a.title + ' ' + a.summary).toLowerCase();
                positive.forEach(w => { if(text.includes(w)) totalScore += 2; });
                negative.forEach(w => { if(text.includes(w)) totalScore -= 2; });
            });
            totalScore = Math.max(0, Math.min(100, totalScore));
            
            if(appState.charts.sentiment) appState.charts.sentiment.updateSeries([totalScore]);
            const valEl = document.getElementById('sentimentValue');
            const txtEl = document.getElementById('sentimentText');
            if(valEl) valEl.innerText = totalScore;
            
            // Dynamic Color Logic for Gauge Text
            if(totalScore > 60) {
                if(txtEl) { txtEl.innerText = "BULLISH"; txtEl.style.color = "#00ff9d"; }
            } else if (totalScore < 40) {
                if(txtEl) { txtEl.innerText = "BEARISH"; txtEl.style.color = "#ff4757"; }
            } else {
                if(txtEl) { txtEl.innerText = "NEUTRAL"; txtEl.style.color = "#ffa502"; }
            }
        }

        // ===== READER MODE =====
        function openReader(id) {
            const article = appState.articles.find(a => a.id === id);
            if(!article) return;
            
            document.getElementById('readerTitle').innerText = article.title;
            document.getElementById('readerSource').innerText = article.source;
            document.getElementById('readerTime').innerText = article.time;
            document.getElementById('readerTag').innerText = article.tag.toUpperCase();
            document.getElementById('readerBody').innerText = article.summary;
            
            const aiDiv = document.getElementById('readerAiSummary');
            if(article.aiAnalysis && article.aiAnalysis !== 'loading') {
                aiDiv.innerHTML = article.aiAnalysis;
            } else {
                aiDiv.innerHTML = "<em>AI Analysis has not been run on this specific intelligence item yet. Use the 'Neural Analysis' button on the dashboard card to generate deep insights.</em>";
            }
            
            document.getElementById('readerExternalLink').onclick = () => window.open(article.url, '_blank');
            document.getElementById('readerModal').classList.add('active');
        }

        // ===== RENDERING =====
        function toggleTLDR() {
            appState.tldrMode = !appState.tldrMode;
            const btn = document.getElementById('tldrToggleBtn');
            if(appState.tldrMode) {
                btn.classList.add('active');
                renderTLDRFeed();
            } else {
                btn.classList.remove('active');
                renderFeed();
            }
        }

        function renderTLDRFeed() {
            const container = document.getElementById('articlesContainer');
            document.getElementById('feedTitle').innerText = "TOP INTELLIGENCE BRIEF";
            const topArticles = [...appState.articles].sort((a,b) => b.impactScore - a.impactScore).slice(0, 10);
            
            if (topArticles.length === 0) {
                container.innerHTML = '<div class="empty-state"><i data-lucide="inbox" size="48"></i><div>No intelligence data available.</div></div>';
                if(window.lucide) window.lucide.createIcons();
                return;
            }

            container.innerHTML = topArticles.map((a, i) => `
                <div class="tldr-card" onclick="window.open('${a.url}', '_blank')">
                    <div class="tldr-number">${i+1}.</div>
                    <div class="tldr-content">
                        <h4>${a.title}</h4>
                        <div class="tldr-meta">${a.source} • ${a.time} • Impact: <span style="color:${a.impactScore > 8 ? '#ff4757' : '#00ff9d'}">${a.impactScore}</span></div>
                    </div>
                </div>
            `).join('');
            if(window.lucide) window.lucide.createIcons();
        }

        function renderFeed() {
            if(appState.tldrMode) return renderTLDRFeed();
            document.getElementById('feedTitle').innerText = "LIVE INTELLIGENCE";
            const container = document.getElementById('articlesContainer');
            
            container.innerHTML = '';

            let filtered = appState.articles;
            if (appState.currentFilter === 'saved') filtered = appState.articles.filter(a => appState.savedArticles.includes(a.id));
            else if (appState.currentFilter === 'breaking') filtered = appState.articles.filter(a => a.impact === 'high');
            else if (appState.currentFilter !== 'all') filtered = appState.articles.filter(a => a.tag === appState.currentFilter);

            const sortMode = document.getElementById('sortSelect').value;
            if(sortMode === 'impact') filtered.sort((a,b) => (a.impact === 'high' ? -1 : 1));
            else filtered.sort((a,b) => b.timeObj - a.timeObj);

            document.getElementById('articleCount').innerText = filtered.length;

            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><i data-lucide="search" size="48"></i><div>No intelligence data found for this filter.</div></div>`;
                if(window.lucide) window.lucide.createIcons();
                return;
            }

            const fragment = document.createDocumentFragment();

            filtered.forEach(art => {
                const card = document.createElement('div');
                card.id = art.id; 
                card.dataset.category = (art.impact === 'high' ? 'breaking' : art.tag);
                card.className = `news-card ${art.impact === 'high' ? 'breaking' : ''}`;
                card.onmouseenter = () => highlightMapMarker(art.id);
                card.onmouseleave = () => unhighlightMapMarker(art.id);

                card.innerHTML = `
                    <div class="card-header">
                        <span><i data-lucide="globe" style="width:12px; margin-right:5px;"></i>${art.source}</span>
                        <span>${art.time}</span>
                    </div>
                    <h3 class="card-title" onclick="window.open('${art.url}', '_blank')">${art.title} <i data-lucide="external-link" style="width:14px; display:inline; opacity:0.7;"></i></h3>
                    <div class="card-meta-line">
                        <span class="impact-score ${art.impact === 'high' ? 'high' : ''}">Impact: ${art.impactScore}</span>
                        <span>•</span>
                        <span>Relevance: 98%</span>
                        ${art.impactScore > 8 ? '<span style="margin-left:10px;" class="velocity-score"><i data-lucide="trending-up" size="12"></i> High Velocity</span>' : ''}
                    </div>
                    <p class="card-summary">${art.summary}</p>
                    
                    <div class="ai-analysis-container">
                        <button class="ai-analysis-btn" onclick="toggleAnalysis('${art.id}')" aria-label="Toggle Neural Analysis">
                            <i data-lucide="brain"></i> NEURAL ANALYSIS
                        </button>
                        <div id="ai-${art.id}" class="ai-content">
                            <div class="loading-spinner"><i data-lucide="loader-2" class="fa-spin"></i> Processing Neural Pathway...</div>
                        </div>
                    </div>

                    <div class="card-footer">
                        <div class="card-tags">
                            <span class="tag ${art.tag}"><i data-lucide="${getTagIcon(art.tag)}" size="12"></i> ${art.tag.toUpperCase()}</span>
                            ${art.impact === 'high' ? '<span class="tag" style="background:rgba(255, 71, 87, 0.1); color:#ff4757; border: 1px solid rgba(255,71,87,0.2);"><i data-lucide="alert-triangle" size="12"></i> HIGH IMPACT</span>' : ''}
                            <span style="font-size:0.7rem; color:var(--color-text-muted); margin-left:5px;">~${calculateReadTime(art.summary)} min read</span>
                        </div>
                        <div class="card-actions-right">
                            <button class="card-action-btn share-btn" onclick="shareArticle('${art.url}')" title="Copy Link" aria-label="Copy Link"><i data-lucide="share-2" size="16"></i></button>
                            <button class="card-action-btn speak-btn" onclick="speakText('${art.summary.replace(/'/g, "\\'")}', this)" title="Read Briefing" aria-label="Speak Summary"><i data-lucide="volume-2" size="16"></i></button>
                            <button class="card-action-btn bookmark-btn ${appState.savedArticles.includes(art.id) ? 'bookmarked' : ''}" onclick="toggleBookmark('${art.id}')" aria-label="Bookmark"><i data-lucide="bookmark" size="16"></i></button>
                        </div>
                    </div>
                `;
                fragment.appendChild(card);
            });
            container.appendChild(fragment);
            if(window.lucide) window.lucide.createIcons();
        }

        function getTagIcon(tag) {
            if(tag === 'ai') return 'cpu';
            if(tag === 'energy') return 'zap';
            if(tag === 'policy') return 'scale';
            if(tag === 'realestate') return 'building';
            return 'tag';
        }

        async function toggleAnalysis(id) {
            const el = document.getElementById(`ai-${id}`);
            const article = appState.articles.find(a => a.id === id);
            if (el.classList.contains('visible')) { el.classList.remove('visible'); } 
            else { 
                el.classList.add('visible');
                if (!article.aiAnalysis || article.aiAnalysis === 'loading') {
                    article.aiAnalysis = 'loading';
                    const analysis = await performGeminiAnalysis(article);
                    article.aiAnalysis = analysis;
                    el.innerHTML = analysis;
                } else { el.innerHTML = article.aiAnalysis; }
            }
        }

        function speakText(text, btn) {
            if ('speechSynthesis' in window) {
                if (window.speechSynthesis.speaking) { window.speechSynthesis.cancel(); btn.classList.remove('speaking'); return; }
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.1; utterance.pitch = 1;
                utterance.onend = () => btn.classList.remove('speaking');
                btn.classList.add('speaking');
                window.speechSynthesis.speak(utterance);
            } else { showNotification("TTS Not Supported", "error"); }
        }

        function shareArticle(url) {
            navigator.clipboard.writeText(url).then(() => { showNotification("Link Copied", "success"); }).catch(err => console.error(err));
        }

        window.toggleBookmark = function(id) {
            const index = appState.savedArticles.indexOf(id);
            if (index === -1) { appState.savedArticles.push(id); showNotification("Article Saved", "success"); } 
            else { appState.savedArticles.splice(index, 1); showNotification("Article Removed", "info"); }
            localStorage.setItem('nexus_saved', JSON.stringify(appState.savedArticles));
            refreshUIComponents();
        };

        function updateQuickSaved() {
            const container = document.getElementById('quickSavedList');
            const btn = document.getElementById('downloadBriefBtn');
            const savedArts = appState.articles.filter(a => appState.savedArticles.includes(a.id));
            if (savedArts.length === 0) { container.innerHTML = '<span style="color: var(--color-text-muted); font-style: italic; font-size:0.8rem;">No bookmarks yet.</span>'; btn.style.display = 'none'; return; }
            btn.style.display = 'block';
            container.innerHTML = savedArts.slice(0, 5).map(a => `<div style="padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer;" onclick="openReader('${a.id}')"><div style="font-weight: 500; color: var(--color-text-secondary); font-size:0.85rem;">${a.title.substring(0, 40)}...</div><div style="font-size: 0.7rem; color: var(--color-text-muted);">${a.source}</div></div>`).join('');
        }

        function checkBreakingNews() {
            const banner = document.getElementById('breakingBanner');
            const breakingArt = appState.articles.find(a => a.impact === 'high');
            if (breakingArt && appState.settings.breakingNews) {
                document.getElementById('breakingText').innerText = "BREAKING: " + breakingArt.title.toUpperCase();
                banner.style.display = 'flex';
                banner.onclick = () => { window.open(breakingArt.url, '_blank'); };
            } else {
                banner.style.display = 'none';
            }
        }

        function initMap() {
            if(appState.map) return;
            const mapEl = document.getElementById('miniMap');
            if(!mapEl) return;
            appState.map = L.map('miniMap', { center: [30, -10], zoom: 1.5, zoomControl: false, attributionControl: false });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, subdomains: 'abcd' }).addTo(appState.map);
        }

        function updateMapMarkers() {
            if(!appState.map) return;
            Object.values(appState.markers).forEach(m => appState.map.removeLayer(m));
            appState.markers = {};
            
            let visibleArticles = appState.articles;
            if (appState.currentFilter === 'saved') visibleArticles = appState.articles.filter(a => appState.savedArticles.includes(a.id));
            else if (appState.currentFilter === 'breaking') visibleArticles = appState.articles.filter(a => a.impact === 'high');
            else if (appState.currentFilter !== 'all') visibleArticles = appState.articles.filter(a => a.tag === appState.currentFilter);

            const bounds = [];
            visibleArticles.forEach(art => {
                const customIcon = L.divIcon({ className: 'custom-map-icon', html: `<div class="map-marker-pulse ${art.tag} ${art.impact === 'high' ? 'high-impact' : ''}"></div>`, iconSize: [16, 16], iconAnchor: [8, 8] });
                const marker = L.marker([art.lat, art.lng], { icon: customIcon }).addTo(appState.map);
                bounds.push([art.lat, art.lng]);
                marker.bindPopup(`<div style="font-family: Inter, sans-serif; color: #eee;"><strong style="display:block; margin-bottom: 4px; font-size:0.9rem;">${art.title}</strong><span style="font-size: 0.75rem; color: #aaa; text-transform:uppercase;">${art.source}</span></div>`);
                marker.on('click', () => { const card = document.getElementById(art.id); if (card) { card.scrollIntoView({ behavior: 'smooth', block: 'center' }); card.classList.add('highlight-card'); setTimeout(() => card.classList.remove('highlight-card'), 2000); } });
                appState.markers[art.id] = marker; 
            });
            if(bounds.length > 0) appState.map.fitBounds(bounds, { padding: [50, 50], maxZoom: 5 });
        }

        function highlightMapMarker(id) { const marker = appState.markers[id]; if (marker) marker.openPopup(); }
        function unhighlightMapMarker(id) { const marker = appState.markers[id]; if (marker) marker.closePopup(); }

        function applySettings() {
            if (appState.settings.cyberpunk) { document.body.classList.add('cyberpunk-active'); document.querySelectorAll('.scanlines, .crt-flicker, .glow-overlay').forEach(el => el.style.display = 'block'); document.getElementById('cyberpunkToggle').checked = true; } 
            else { document.body.classList.remove('cyberpunk-active'); document.querySelectorAll('.scanlines, .crt-flicker, .glow-overlay').forEach(el => el.style.display = 'none'); document.getElementById('cyberpunkToggle').checked = false; }
            document.getElementById('breakingNewsToggle').checked = appState.settings.breakingNews;
            document.getElementById('liveSimToggle').checked = appState.settings.liveSim;
            document.getElementById('geminiKey').value = appState.settings.geminiKey || '';
            document.getElementById('newsApiKey').value = appState.settings.newsApiKey || '';
            document.getElementById('gnewsApiKey').value = appState.settings.gnewsApiKey || '';
        }

        function saveSettings() {
            appState.settings = {
                cyberpunk: document.getElementById('cyberpunkToggle').checked,
                breakingNews: document.getElementById('breakingNewsToggle').checked,
                liveSim: document.getElementById('liveSimToggle').checked,
                geminiKey: document.getElementById('geminiKey').value,
                newsApiKey: document.getElementById('newsApiKey').value,
                gnewsApiKey: document.getElementById('gnewsApiKey').value
            };
            localStorage.setItem('nexus_settings', JSON.stringify(appState.settings));
            applySettings(); refreshData(); startLiveSimulation(); 
            document.getElementById('settingsModal').classList.remove('active');
            showNotification("Configuration Saved", "success");
        }

        function showNotification(text, type = 'info') {
            const el = document.getElementById('notificationArea');
            document.getElementById('notificationText').innerText = text;
            el.className = `notification ${type}`; // Reset classes
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), 3000);
        }

        function toggleSearch() {
            const modal = document.getElementById('searchModal');
            if(modal.classList.contains('active')) modal.classList.remove('active');
            else { modal.classList.add('active'); setTimeout(() => document.getElementById('searchInput').focus(), 100); }
        }

        document.getElementById('downloadBriefBtn').addEventListener('click', () => {
            const saved = appState.articles.filter(a => appState.savedArticles.includes(a.id));
            if(saved.length === 0) return;
            let content = `NEXUS INTELLIGENCE BRIEF\nGenerated: ${new Date().toLocaleString()}\n\n`;
            saved.forEach((a, i) => { content += `${i+1}. ${a.title}\nSource: ${a.source} | ${a.time}\nSummary: ${a.summary}\nLink: ${a.url}\n\n`; });
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `NEXUS_Brief_${Date.now()}.txt`; a.click();
            showNotification("Brief Downloaded", "success");
        });

        function setupEventListeners() {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    appState.currentFilter = e.currentTarget.dataset.filter;
                    renderFeed(); updateMapMarkers();
                });
            });
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            document.getElementById('tldrToggleBtn').addEventListener('click', toggleTLDR);
            document.getElementById('triggerSearchBtn').addEventListener('click', toggleSearch);
            document.getElementById('closeSearchBtn').addEventListener('click', toggleSearch);
            document.getElementById('triggerSettingsBtn').addEventListener('click', () => document.getElementById('settingsModal').classList.add('active'));
            document.getElementById('closeSettingsBtn').addEventListener('click', () => document.getElementById('settingsModal').classList.remove('active'));
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            document.getElementById('sortSelect').addEventListener('change', renderFeed);
            document.addEventListener('keydown', (e) => { 
                if((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); toggleSearch(); } 
                if(e.key === 'Escape') { 
                    document.getElementById('searchModal').classList.remove('active'); 
                    document.getElementById('settingsModal').classList.remove('active'); 
                    document.getElementById('helpModal').classList.remove('active');
                    document.getElementById('readerModal').classList.remove('active');
                }
                if(e.shiftKey && e.key === '?') { document.getElementById('helpModal').classList.add('active'); }
                if(e.key === 'r' && !e.metaKey && !e.ctrlKey && document.activeElement.tagName !== 'INPUT') { refreshData(); }
            });
            document.querySelectorAll('.modal-overlay').forEach(m => { m.addEventListener('click', e => { if(e.target === m) m.classList.remove('active'); }); });
        }

        init();
    </script>
</body>
</html>