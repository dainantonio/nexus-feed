<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS INTEL | v3.5 AI</title>
    
    <!-- External Dependencies -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        /* ===== CORE VARIABLES ===== */
        :root {
            --bg-dark: #050507;
            --bg-panel: #0e0e12;
            --bg-card: #15151b;
            --border-color: #2a2a35;
            
            --neon-green: #00ff9d;
            --neon-blue: #00f0ff;
            --neon-red: #ff2a6d;
            --neon-purple: #bc13fe;
            --neon-amber: #ffb800;
            
            --text-main: #ffffff;
            --text-muted: #888899;
            
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            --scanline-opacity: 0.05;
            --glow-strength: 0px;
        }

        /* ===== CYBERPUNK MODE OVERRIDES ===== */
        body.cyberpunk-mode {
            --bg-dark: #000000;
            --bg-panel: #050505;
            --border-color: #333333;
            --scanline-opacity: 0.15;
            --glow-strength: 0 0 10px;
        }
        
        body.cyberpunk-mode .text-green { text-shadow: 0 0 5px var(--neon-green); }
        body.cyberpunk-mode .text-blue { text-shadow: 0 0 5px var(--neon-blue); }
        body.cyberpunk-mode .text-purple { text-shadow: 0 0 5px var(--neon-purple); }

        /* ===== RESET & BASE ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background 0.3s;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-green); }

        /* ===== UTILITIES ===== */
        .mono { font-family: var(--font-mono); }
        .text-green { color: var(--neon-green); }
        .text-red { color: var(--neon-red); }
        .text-blue { color: var(--neon-blue); }
        .text-purple { color: var(--neon-purple); }
        .text-amber { color: var(--neon-amber); }
        
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }

        /* ===== LAYOUT GRID & ZEN MODE ===== */
        .app-grid {
            display: grid;
            grid-template-columns: 280px 1fr 340px;
            grid-template-rows: auto 1fr;
            height: 100%;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* ZEN MODE STYLES */
        body.zen-mode .app-grid {
            grid-template-columns: 0 1fr 0;
        }
        body.zen-mode .sidebar {
            display: none;
        }
        body.zen-mode .feed-container {
            padding: 2rem 15%; /* Center focus */
        }
        @media (max-width: 1024px) {
            body.zen-mode .feed-container { padding: 2rem 5%; }
        }

        @media (max-width: 1200px) { .app-grid { grid-template-columns: 240px 1fr 0; } }
        @media (max-width: 768px) { .app-grid { grid-template-columns: 0 1fr 0; } }

        /* ===== HEADER ===== */
        .header {
            grid-column: 1 / -1;
            background: rgba(14, 14, 18, 0.95);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(10px);
            z-index: 50;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.25rem;
            letter-spacing: -0.05em;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--neon-green);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            box-shadow: var(--glow-strength) var(--neon-green);
        }

        .search-bar {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 300px;
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: #fff;
            font-family: var(--font-mono);
            outline: none;
            width: 100%;
            text-transform: uppercase;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .icon-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            width: 32px; height: 32px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .icon-btn:hover, .icon-btn.active { border-color: var(--neon-green); color: var(--neon-green); }

        /* ===== TICKER ===== */
        .ticker-container {
            grid-column: 1 / -1;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            height: 36px;
            overflow: hidden;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .ticker-track {
            display: flex;
            animation: scroll 60s linear infinite;
            white-space: nowrap;
        }
        
        .ticker-item {
            padding: 0 1.5rem;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
            border-right: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .ticker-item:hover { background: rgba(255,255,255,0.05); }

        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* ===== SIDEBARS ===== */
        .sidebar {
            background: var(--bg-panel);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .sidebar-right {
            border-right: none;
            border-left: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
        }

        /* ===== CHART CONTAINER ===== */
        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            position: relative;
            box-shadow: var(--glow-strength) rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 1rem;
        }

        .chart-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .chart-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
        }

        .chart-btn:hover, .chart-btn.active {
            background: rgba(0,255,157,0.1);
            color: var(--neon-green);
            border-color: var(--neon-green);
        }

        #mainChart {
            min-height: 250px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 0.8rem;
        }

        .symbol-title { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .current-price { font-size: 1.5rem; font-weight: 700; color: var(--neon-green); font-family: var(--font-mono); }

        /* ===== MAIN FEED & TOP BRIEF ===== */
        .feed-container {
            padding: 1.5rem;
            overflow-y: auto;
            background: radial-gradient(circle at top right, rgba(0,255,157,0.03), transparent 40%);
            display: flex;
            flex-direction: column;
        }

        /* Top Brief Styles */
        .brief-panel {
            background: rgba(255, 184, 0, 0.05);
            border: 1px solid rgba(255, 184, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .brief-panel-header {
            padding: 12px 16px;
            background: rgba(255, 184, 0, 0.1);
            border-bottom: 1px solid rgba(255, 184, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--neon-amber);
            font-weight: 700;
        }
        
        .brief-panel-header:hover { background: rgba(255, 184, 0, 0.15); }

        .brief-panel-content {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 500px;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }
        
        .brief-panel.collapsed .brief-panel-content {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
            overflow: hidden;
        }
        
        .brief-panel.collapsed .brief-panel-header { border-bottom: none; }

        .tldr-item {
            display: flex;
            gap: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .tldr-item:last-child { border-bottom: none; padding-bottom: 0; }
        
        .tldr-rank { font-size: 1.1rem; font-weight: 800; color: rgba(255,255,255,0.2); font-family: var(--font-mono); }
        .tldr-text h4 { font-size: 0.9rem; margin-bottom: 4px; color: #eee; cursor: pointer; }
        .tldr-text h4:hover { color: var(--neon-amber); }
        .tldr-meta { font-size: 0.7rem; color: var(--text-muted); }

        .synth-btn {
            background: rgba(255,184,0,0.1);
            border: 1px solid var(--neon-amber);
            color: var(--neon-amber);
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .synth-btn:hover { background: var(--neon-amber); color: #000; }

        /* Feed Controls */
        .feed-header-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;
        }

        .feed-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            align-items: center;
        }

        .feed-tab {
            background: rgba(255,255,255,0.05);
            border: 1px solid transparent;
            padding: 8px 16px;
            border-radius: 4px;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .feed-tab:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .feed-tab.active { background: rgba(0,255,157,0.1); color: var(--neon-green); border-color: var(--neon-green); }

        .refresh-btn {
            margin-left: auto;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            width: 32px; height: 32px;
            min-width: 32px;
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .refresh-btn:hover { color: var(--neon-green); border-color: var(--neon-green); }

        .view-toggle {
            display: flex;
            gap: 5px;
            margin-left: 10px;
            border-left: 1px solid var(--border-color);
            padding-left: 10px;
        }

        /* GRID VIEW OVERRIDES */
        #newsFeed.grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        #newsFeed.grid-view .news-card {
            height: 100%;
            margin-bottom: 0;
        }

        /* ===== NEWS CARD REDESIGN ===== */
        .news-card {
            background: rgba(30, 30, 35, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-left-width: 4px; /* Integrated color bar */
            border-radius: 12px; /* Rounded corners */
            padding: 1.5rem;
            margin-bottom: 1.25rem;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .news-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
            border-top-color: rgba(255,255,255,0.2);
            border-right-color: rgba(255,255,255,0.2);
            border-bottom-color: rgba(255,255,255,0.2);
        }

        /* Sentiment Variants */
        .news-card.bullish {
            border-left-color: var(--neon-green);
            background: linear-gradient(145deg, rgba(0, 255, 157, 0.03) 0%, rgba(30, 30, 35, 0.8) 100%);
        }
        .news-card.bullish:hover {
            box-shadow: 0 12px 24px rgba(0, 255, 157, 0.1);
        }

        .news-card.bearish {
            border-left-color: var(--neon-red);
            background: linear-gradient(145deg, rgba(255, 42, 109, 0.03) 0%, rgba(30, 30, 35, 0.8) 100%);
        }
        .news-card.bearish:hover {
            box-shadow: 0 12px 24px rgba(255, 42, 109, 0.1);
        }

        .news-card.neutral {
            border-left-color: var(--border-color);
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.01) 0%, rgba(30, 30, 35, 0.8) 100%);
        }

        /* Typography updates for better readability on new cards */
        .news-headline { 
            font-size: 1.1rem; 
            font-weight: 700; 
            line-height: 1.4; 
            margin-bottom: 0.75rem; 
            color: #fff; 
            cursor: pointer; 
            letter-spacing: -0.02em;
        }
        .news-headline:hover { color: var(--neon-green); }
        
        .news-summary { 
            font-size: 0.9rem; 
            color: #999; 
            line-height: 1.6; 
            margin-bottom: 12px; 
            font-weight: 300;
        }

        .ai-summary-box {
            background: rgba(188, 19, 254, 0.05);
            border-left: 2px solid var(--neon-purple);
            padding: 12px;
            margin-top: 12px;
            font-size: 0.85rem;
            color: #d0d0d0;
            display: none;
            border-radius: 0 4px 4px 0;
            animation: fadeIn 0.3s ease;
        }
        
        .ai-summary-box.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .analyze-btn {
            background: transparent; border: 1px solid var(--neon-purple); color: var(--neon-purple);
            padding: 4px 10px; font-size: 0.7rem; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;
        }
        .analyze-btn:hover { background: var(--neon-purple); color: #fff; }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            width: 500px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-section-title {
            font-size: 0.7rem; color: var(--neon-green); text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;
        }

        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; display: block; }
        .form-input {
            width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color);
            padding: 8px; color: #fff; border-radius: 4px; font-family: var(--font-mono);
        }

        /* ===== ORACLE CHAT STYLES ===== */
        .chat-container {
            display: flex; flex-direction: column; height: 400px;
        }
        .chat-history {
            flex-grow: 1; overflow-y: auto; padding: 10px; 
            border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;
        }
        .chat-message { margin-bottom: 10px; font-size: 0.85rem; line-height: 1.4; display: flex; flex-direction: column; }
        .chat-message.user { align-items: flex-end; }
        .chat-message.ai { align-items: flex-start; color: var(--neon-green); }
        .chat-bubble { padding: 8px 12px; border-radius: 6px; max-width: 80%; }
        .chat-message.user .chat-bubble { background: rgba(0,240,255,0.1); border: 1px solid rgba(0,240,255,0.3); color: #fff; }
        .chat-message.ai .chat-bubble { background: rgba(0,255,157,0.05); border: 1px solid rgba(0,255,157,0.2); font-family: var(--font-mono); }
        
        .chat-input-area { display: flex; gap: 10px; }
        .chat-input-area input { flex-grow: 1; }

        /* ===== DECORATION ===== */
        .scanline {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.5) 51%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 999;
            opacity: var(--scanline-opacity);
        }

        /* ===== PROFILE CARD ===== */
        .profile-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .profile-logo {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: #fff;
            object-fit: contain;
            padding: 2px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .p-stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }
        .p-stat-val { font-size: 0.8rem; font-weight: 600; font-family: var(--font-mono); }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        #toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 3000;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        .toast {
            background: var(--bg-card); border: 1px solid var(--neon-green);
            padding: 12px 20px; border-radius: 4px; color: #fff; font-family: var(--font-mono); font-size: 0.8rem;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease forwards;
        }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
    </style>
</head>
<body>

    <!-- SETTINGS MODAL -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="flex justify-between items-center" style="margin-bottom: 20px;">
                <h3 class="mono text-green">SYSTEM CONFIGURATION</h3>
                <button class="icon-btn" onclick="app.toggleSettings()"><i data-lucide="x"></i></button>
            </div>
            
            <div class="modal-section-title">DATA KEYS</div>
            
            <div class="form-group">
                <label class="form-label">FINNHUB API KEY (Primary Data)</label>
                <input type="password" id="finnhubKey" class="form-input" value="d5e7311r01qjckl29au0d5e7311r01qjckl29aug">
            </div>

            <div class="form-group">
                <label class="form-label">GEMINI API KEY (AI Intelligence)</label>
                <input type="password" id="geminiKey" class="form-input" placeholder="Enter Google Gemini API Key...">
            </div>

            <div class="modal-section-title" style="margin-top: 20px;">SYSTEM PREFS</div>

            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <span class="mono" style="font-size:0.9rem;">CYBERPUNK MODE</span>
                <label class="switch">
                    <input type="checkbox" id="cyberModeToggle" onchange="app.toggleCyberpunk(this.checked)">
                    <span class="slider" style="background:var(--border-color); width:36px; height:20px; display:inline-block; border-radius:10px; position:relative;">
                        <span style="position:absolute; top:2px; left:2px; width:16px; height:16px; background:#fff; border-radius:50%; transition:0.2s; transform:translateX(0);"></span>
                    </span>
                </label>
            </div>

             <div class="modal-section-title" style="margin-top: 20px;">DEBUG & MAINTENANCE</div>
             
             <button onclick="app.clearCache()" style="width: 100%; padding: 8px; background: rgba(255, 42, 109, 0.2); border: 1px solid var(--neon-red); color: var(--neon-red); font-family: var(--font-mono); cursor: pointer; margin-bottom: 10px;">
                 <i data-lucide="trash-2" width="14"></i> PURGE CACHE & RELOAD
             </button>
            
            <button onclick="app.saveSettings()" style="width: 100%; padding: 12px; background: var(--neon-green); border: none; font-weight: bold; color: #000; cursor: pointer; border-radius: 4px; margin-top: 10px;">
                SAVE CONFIGURATION
            </button>
        </div>
    </div>

    <!-- ORACLE MODAL -->
    <div class="modal-overlay" id="oracleModal">
        <div class="modal">
            <div class="flex justify-between items-center" style="margin-bottom: 20px;">
                <h3 class="mono text-green"><i data-lucide="bot"></i> NEXUS ORACLE</h3>
                <button class="icon-btn" onclick="app.toggleOracle()"><i data-lucide="x"></i></button>
            </div>
            <div class="chat-container">
                <div class="chat-history" id="oracleHistory">
                    <div class="chat-message ai">
                        <div class="chat-bubble">I am Nexus Oracle. Connected to Gemini 2.5 Flash. Awaiting your market query...</div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="oracleInput" class="form-input" placeholder="Ask about markets, symbols, or definitions..." onkeypress="app.handleOracleKey(event)">
                    <button class="icon-btn" onclick="app.submitOracle()"><i data-lucide="send"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- ASSET REPORT MODAL -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal">
            <div class="flex justify-between items-center" style="margin-bottom: 20px;">
                <h3 class="mono text-purple"><i data-lucide="sparkles"></i> AI EXECUTIVE REPORT</h3>
                <button class="icon-btn" onclick="document.getElementById('reportModal').classList.remove('open')"><i data-lucide="x"></i></button>
            </div>
            <div id="reportContent" style="font-family: var(--font-mono); line-height: 1.6; color: #e0e0e0; white-space: pre-wrap;">
                Generating analysis...
            </div>
        </div>
    </div>
    
    <!-- TOASTS -->
    <div id="toast-container"></div>

    <!-- Background FX -->
    <div class="scanline"></div>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon"><i data-lucide="aperture"></i></div>
            <div>NEXUS <span class="text-green">INTEL</span></div>
        </div>
        
        <div class="search-bar">
            <i data-lucide="search" size="16" class="text-muted"></i>
            <input type="text" id="searchInput" placeholder="SEARCH TICKER (e.g. AMD)" onkeypress="app.handleSearch(event)">
        </div>
        
        <div class="header-controls">
            <div class="mono text-green" style="font-size: 0.8rem;" id="clock">00:00:00</div>
            <button class="icon-btn" onclick="app.toggleOracle()" title="AI Oracle (Chat)"><i data-lucide="bot"></i></button>
            <button class="icon-btn" id="zenModeBtn" onclick="app.toggleZenMode()" title="Zen Mode">
                <i data-lucide="maximize"></i>
            </button>
            <button class="icon-btn" onclick="app.toggleSettings()"><i data-lucide="settings"></i></button>
        </div>
    </header>

    <!-- Ticker -->
    <div class="ticker-container">
        <div class="ticker-track" id="tickerTrack"></div>
    </div>

    <!-- Main Grid -->
    <div class="app-grid">
        
        <!-- Left Sidebar: Watchlist -->
        <aside class="sidebar left-sidebar">
            <div>
                <div class="section-title"><i data-lucide="crosshair"></i> WATCHLIST</div>
                <div id="watchlist"></div>
            </div>

            <div style="margin-top: auto;">
                <div class="section-title"><i data-lucide="flame"></i> MARKET HEATMAP</div>
                <div id="heatmap" style="height: 180px; width: 100%; border-radius: 6px; border: 1px solid var(--border-color); overflow: hidden;"></div>
            </div>
        </aside>

        <!-- Main Content: News Feed -->
        <main class="feed-container">
            
            <!-- Collapsible Top Brief -->
            <div id="topBriefPanel" class="brief-panel">
                <div class="brief-panel-header">
                    <div style="display:flex; align-items:center; gap:10px; flex-grow: 1; cursor:pointer;" onclick="app.toggleTopBrief()">
                       <i data-lucide="zap" style="color:var(--neon-amber);"></i>
                       <span>DAILY INTELLIGENCE BRIEFING</span>
                    </div>
                    <button class="synth-btn" onclick="app.synthesizeBriefing()">
                        <i data-lucide="sparkles" width="12"></i> SYNTHESIZE INTEL
                    </button>
                    <i data-lucide="chevron-up" id="briefPanelChevron" style="cursor:pointer;" onclick="app.toggleTopBrief()"></i>
                </div>
                <div class="brief-panel-content" id="briefPanelContent">
                    <div style="color: var(--text-muted); font-style:italic;">Initializing Briefing Protocol...</div>
                </div>
            </div>

            <div class="feed-header-row">
                <h2 class="mono" style="font-size: 1.2rem; font-weight: 700;"><i data-lucide="radio" style="display:inline; width:18px;"></i> INTELLIGENCE STREAM</h2>
                <div style="display:flex; align-items:center;">
                    <div class="view-toggle">
                        <button class="icon-btn active" id="viewRowBtn" onclick="app.toggleView('row')" title="Row View"><i data-lucide="list"></i></button>
                        <button class="icon-btn" id="viewGridBtn" onclick="app.toggleView('grid')" title="Grid View"><i data-lucide="grid"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="feed-tabs">
                <button class="feed-tab active" onclick="app.setFeedFilter('all')">ALL</button>
                <button class="feed-tab" onclick="app.setFeedFilter('tech')">TECH</button>
                <button class="feed-tab" onclick="app.setFeedFilter('startup')">STARTUPS</button>
                <button class="feed-tab" onclick="app.setFeedFilter('ai')">AI & DATA</button>
                <button class="feed-tab" onclick="app.setFeedFilter('energy')">ENERGY</button>
                <button class="feed-tab" onclick="app.setFeedFilter('policy')">POLICY</button>
                <button class="feed-tab" onclick="app.setFeedFilter('crypto')">CRYPTO</button>
                
                <button class="refresh-btn" onclick="app.refreshNews()" title="Force Refresh Intel">
                    <i data-lucide="refresh-cw" width="16"></i>
                </button>
            </div>

            <div id="newsFeed"></div>
        </main>

        <!-- Right Sidebar: Chart & Details -->
        <aside class="sidebar sidebar-right">
            <div>
                <div class="section-title"><i data-lucide="activity"></i> ASSET DIAGNOSTICS</div>
                
                <!-- Profile Section -->
                <div id="assetProfile" class="profile-card" style="display:none;">
                    <img id="pLogo" class="profile-logo" src="" alt="logo">
                    <div>
                        <div id="pName" style="font-weight:700; font-size:0.9rem;"></div>
                        <div id="pIndustry" style="font-size:0.7rem; color:var(--text-muted);"></div>
                    </div>
                </div>
                
                <!-- Asset AI Button -->
                <button onclick="app.generateAssetReport()" style="width:100%; margin-bottom:1rem; padding:8px; background:rgba(188, 19, 254, 0.1); border:1px solid var(--neon-purple); color:var(--neon-purple); border-radius:4px; cursor:pointer; font-family:var(--font-mono); font-weight:bold; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <i data-lucide="sparkles" width="14"></i> GENERATE AI REPORT
                </button>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="symbol-title" id="detailSymbol">NVDA</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);" id="detailName">NVIDIA Corp</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="current-price" id="detailPrice">...</div>
                            <div class="price-change mono" id="detailChange">...</div>
                        </div>
                    </div>
                    <!-- Chart Switcher -->
                    <div class="chart-controls">
                        <button class="chart-btn active" onclick="app.toggleChartType('candlestick')" title="Candlestick"><i data-lucide="bar-chart-2"></i></button>
                        <button class="chart-btn" onclick="app.toggleChartType('line')" title="Line Chart"><i data-lucide="activity"></i></button>
                        <button class="chart-btn" onclick="app.toggleChartType('area')" title="Area Chart"><i data-lucide="mountain"></i></button>
                    </div>
                    <!-- Chart Container -->
                    <div id="mainChart">
                        <!-- Content injected via JS (Chart or Loader) -->
                        <div style="text-align:center;">
                            <i data-lucide="loader-2" class="fa-spin" style="margin-bottom:10px;"></i>
                            <div>INITIALIZING SENSORS...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div class="section-title"><i data-lucide="cpu"></i> CORE METRICS</div>
                <div class="profile-stats">
                    <div class="stat-box" style="background: rgba(255,255,255,0.03); padding: 8px; border-radius: 4px;">
                        <div class="p-stat-label">MARKET CAP</div>
                        <div class="p-stat-val" id="metricCap">--</div>
                    </div>
                    <div class="stat-box" style="background: rgba(255,255,255,0.03); padding: 8px; border-radius: 4px;">
                        <div class="p-stat-label">VOLUME</div>
                        <div class="p-stat-val" id="metricVol">--</div>
                    </div>
                    <div class="stat-box" style="background: rgba(255,255,255,0.03); padding: 8px; border-radius: 4px;">
                        <div class="p-stat-label">HIGH (D)</div>
                        <div class="p-stat-val" id="metricHigh">--</div>
                    </div>
                    <div class="stat-box" style="background: rgba(255,255,255,0.03); padding: 8px; border-radius: 4px;">
                        <div class="p-stat-label">LOW (D)</div>
                        <div class="p-stat-val" id="metricLow">--</div>
                    </div>
                </div>
            </div>
            
            <div class="chart-card" style="margin-top: 1rem; border-color: var(--neon-purple);">
                 <div class="section-title" style="color: var(--neon-purple); margin-bottom: 0.5rem;"><i data-lucide="brain-circuit"></i> AI MARKET SENTIMENT</div>
                 <p style="font-size: 0.8rem; color: #ccc; line-height: 1.4;" id="marketSentiment">
                     Global market sentiment analysis requires aggregated news data. Check specific news items for AI-driven summaries.
                 </p>
            </div>
        </aside>

    </div>

    <script>
        // ===== APP CONFIGURATION & STATE =====
        const state = {
            apiKeys: {
                finnhub: 'd5e7311r01qjckl29au0d5e7311r01qjckl29aug',
                gemini: localStorage.getItem('nexus_gemini_key') || ''
            },
            symbols: ['NVDA', 'AAPL', 'MSFT', 'TSLA', 'AMZN', 'GOOGL', 'AMD', 'PLTR', 'SMCI', 'META', 'COIN'],
            currentSymbol: 'NVDA',
            quotes: {},
            newsCache: {
                general: [],
                crypto: [],
                startup: [],
                ai: [],
                energy: [],
                policy: [],
                tech: []
            },
            activeFilter: 'all',
            viewMode: 'row', // row or grid
            zenMode: false,
            briefCollapsed: false,
            chart: null,
            chartType: 'candlestick',
            currentCandles: null, 
            heatmap: null
        };

        // ===== TOAST SYSTEM =====
        const notify = (msg, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            let icon = type === 'success' ? 'check' : type === 'error' ? 'alert-triangle' : 'info';
            let color = type === 'success' ? 'var(--neon-green)' : type === 'error' ? 'var(--neon-red)' : 'var(--neon-blue)';
            
            toast.style.borderColor = color;
            toast.innerHTML = `<i data-lucide="${icon}" style="color:${color}"></i> ${msg}`;
            container.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        // ===== API CONTROLLER =====
        const api = {
            baseUrl: 'https://finnhub.io/api/v1',
            rssProxy: 'https://api.rss2json.com/v1/api.json?rss_url=',

            async getQuote(symbol) {
                try {
                    const res = await fetch(`${this.baseUrl}/quote?symbol=${symbol}&token=${state.apiKeys.finnhub}`);
                    return await res.json();
                } catch (e) { return null; }
            },

            async getProfile(symbol) {
                try {
                    const res = await fetch(`${this.baseUrl}/stock/profile2?symbol=${symbol}&token=${state.apiKeys.finnhub}`);
                    return await res.json();
                } catch (e) { return null; }
            },

            async getCandles(symbol) {
                const to = Math.floor(Date.now() / 1000);
                const from = to - (30 * 24 * 60 * 60); 
                try {
                    const res = await fetch(`${this.baseUrl}/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${to}&token=${state.apiKeys.finnhub}`);
                    return await res.json();
                } catch (e) { return null; }
            },

            // --- NEWS ENGINE V3 (RSS HYBRID) ---
            async getAllNews() {
                // Clear existing caches to prevent duplicates on refresh
                for(let key in state.newsCache) state.newsCache[key] = [];

                // Parallel Fetching for Speed
                const promises = [
                    // 1. API Based
                    this.getFinnhubNews(),
                    this.getCryptoNews(),
                    
                    // 2. TECH (The Verge + TechCrunch)
                    this.getRSSNews('https://www.theverge.com/rss/index.xml', 'tech'),
                    this.getRSSNews('https://techcrunch.com/feed/', 'tech'),

                    // 3. AI (TechCrunch + Verge AI)
                    this.getRSSNews('https://techcrunch.com/category/artificial-intelligence/feed/', 'ai'),
                    this.getRSSNews('https://www.theverge.com/rss/ai-artificial-intelligence/index.xml', 'ai'),

                    // 4. Startups
                    this.getRSSNews('https://techcrunch.com/category/startups/feed/', 'startup'),

                    // 5. Energy
                    this.getRSSNews('https://oilprice.com/rss/main', 'energy'),

                    // 6. Policy
                    this.getRSSNews('https://www.politico.com/rss/politicopicks.xml', 'policy')
                ];

                await Promise.all(promises);
            },

            async getFinnhubNews() {
                try {
                    const res = await fetch(`${this.baseUrl}/news?category=general&token=${state.apiKeys.finnhub}`);
                    state.newsCache.general = await res.json();
                } catch (e) { console.error('Finnhub fail'); }
            },

            async getCryptoNews() {
                try {
                    const res = await fetch('https://min-api.cryptocompare.com/data/v2/news/?lang=EN');
                    const data = await res.json();
                    state.newsCache.crypto = data.Data;
                } catch (e) { console.error('Crypto fail'); }
            },

            async getRSSNews(url, category) {
                try {
                    const res = await fetch(`${this.rssProxy}${encodeURIComponent(url)}`);
                    const data = await res.json();
                    if(data.status === 'ok') {
                        const newItems = data.items.map(item => ({
                            headline: item.title,
                            summary: item.description.replace(/<[^>]*>?/gm, '').substring(0, 150) + '...', // Strip HTML
                            url: item.link,
                            source: data.feed.title || 'RSS',
                            datetime: new Date(item.pubDate).getTime() / 1000,
                            category: category.toUpperCase()
                        }));

                        if (!state.newsCache[category]) state.newsCache[category] = [];
                        state.newsCache[category] = [...state.newsCache[category], ...newItems].sort((a,b) => b.datetime - a.datetime);
                    }
                } catch (e) { console.error(`RSS fail for ${category}`, e); }
            },

            // --- GEMINI AI INTEGRATION ---
            
            async callGemini(prompt) {
                if (!state.apiKeys.gemini) {
                    notify("Gemini API Key Required", "error");
                    return null;
                }
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKeys.gemini}`;
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    console.error("Gemini Error:", e);
                    notify("AI Connection Failed", "error");
                    return null;
                }
            },

            async summarizeWithGemini(text, elementId) {
                const btn = document.getElementById(`btn-${elementId}`);
                const box = document.getElementById(`box-${elementId}`);
                
                btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> THINKING`;
                
                const prompt = `Summarize this financial news for an investor in 2 sentences. Focus on market impact. Text: ${text}`;
                const result = await this.callGemini(prompt);
                
                if (result) {
                    box.innerText = result;
                    box.classList.add('active');
                    btn.innerHTML = `<i data-lucide="check"></i> DONE`;
                    lucide.createIcons();
                } else {
                    btn.innerHTML = `ERROR`;
                }
            }
        };

        // ===== UI CONTROLLER =====
        const app = {
            init() {
                lucide.createIcons();
                this.initClock();
                
                if(localStorage.getItem('nexus_cyberpunk') === 'true') {
                    document.body.classList.add('cyberpunk-mode');
                    document.getElementById('cyberModeToggle').checked = true;
                }
                document.getElementById('geminiKey').value = state.apiKeys.gemini;

                // Initial Load
                this.loadSymbol(state.currentSymbol).then(() => {
                    this.refreshNews();
                    this.updateTicker();
                });

                setInterval(() => this.updateTicker(), 60000); 
            },

            initClock() {
                setInterval(() => {
                    const now = new Date();
                    document.getElementById('clock').innerText = now.toISOString().split('T')[1].split('.')[0] + " UTC";
                }, 1000);
            },

            // ===== AI FEATURES =====
            
            toggleOracle() {
                document.getElementById('oracleModal').classList.toggle('open');
                setTimeout(() => document.getElementById('oracleInput').focus(), 100);
            },

            handleOracleKey(e) {
                if (e.key === 'Enter') this.submitOracle();
            },

            async submitOracle() {
                const input = document.getElementById('oracleInput');
                const history = document.getElementById('oracleHistory');
                const q = input.value.trim();
                if(!q) return;

                // User Msg
                history.innerHTML += `<div class="chat-message user"><div class="chat-bubble">${q}</div></div>`;
                input.value = '';
                history.scrollTop = history.scrollHeight;

                // AI Response
                const prompt = `You are Nexus Oracle, a cynical cyberpunk market analyst. Answer this briefly: ${q}`;
                const response = await api.callGemini(prompt);
                
                if(response) {
                    history.innerHTML += `<div class="chat-message ai"><div class="chat-bubble">${response}</div></div>`;
                } else {
                    history.innerHTML += `<div class="chat-message ai"><div class="chat-bubble text-red">CONNECTION LOST.</div></div>`;
                }
                history.scrollTop = history.scrollHeight;
            },

            async generateAssetReport() {
                const modal = document.getElementById('reportModal');
                const content = document.getElementById('reportContent');
                modal.classList.add('open');
                content.innerText = `Analyzing ${state.currentSymbol} data streams...`;
                
                const q = state.quotes[state.currentSymbol];
                if (!q) { content.innerText = "No data available."; return; }
                
                const prompt = `Act as a senior financial analyst. Write a concise executive summary for ${state.currentSymbol}. 
                Data: Price $${q.c}, Change ${q.dp}%, High $${q.h}, Low $${q.l}.
                Provide: 1. Trend Analysis 2. Key Level Assessment 3. Short-term Outlook (Bullish/Bearish). Use bullet points.`;
                
                const report = await api.callGemini(prompt);
                if (report) content.innerText = report;
            },

            async synthesizeBriefing() {
                const container = document.getElementById('briefPanelContent');
                container.innerHTML = `<div style="padding:10px; color:var(--neon-amber);"><i class="fa fa-spinner fa-spin"></i> Synthesizing Intelligence Streams...</div>`;
                
                // Collect headlines
                let headlines = [];
                document.querySelectorAll('.tldr-text h4').forEach(h => headlines.push(h.innerText));
                
                if (headlines.length === 0) {
                    container.innerHTML = "No intelligence available to synthesize.";
                    return;
                }

                const prompt = `Synthesize these news headlines into a 3-bullet point 'Market Situation Report' for a trader. Be concise and professional. Headlines: ${headlines.join(' | ')}`;
                
                const report = await api.callGemini(prompt);
                if (report) {
                    // Convert bullets to HTML
                    const html = report.split('\n').map(line => line.trim()).filter(l => l.length > 0).map(l => `<div style="margin-bottom:8px; border-left:2px solid var(--neon-amber); padding-left:10px;">${l.replace(/^-|\*/g, '')}</div>`).join('');
                    container.innerHTML = `<div style="padding:10px; font-size:0.9rem;">${html}</div>`;
                } else {
                    // Fallback to list if AI fails
                    this.renderFeed(); 
                }
            },

            // ===== VIEW MODES =====
            toggleZenMode() {
                state.zenMode = !state.zenMode;
                const btn = document.getElementById('zenModeBtn');
                
                if (state.zenMode) {
                    document.body.classList.add('zen-mode');
                    btn.classList.add('active');
                    btn.querySelector('i').setAttribute('data-lucide', 'minimize');
                    notify("Zen Mode Active", "success");
                } else {
                    document.body.classList.remove('zen-mode');
                    btn.classList.remove('active');
                    btn.querySelector('i').setAttribute('data-lucide', 'maximize');
                }
                lucide.createIcons();
                if(state.chart) setTimeout(() => state.chart.resize(), 300);
                if(state.heatmap) setTimeout(() => state.heatmap.resize(), 300);
            },

            toggleView(mode) {
                state.viewMode = mode;
                const feed = document.getElementById('newsFeed');
                const rowBtn = document.getElementById('viewRowBtn');
                const gridBtn = document.getElementById('viewGridBtn');

                if (mode === 'grid') {
                    feed.classList.add('grid-view');
                    rowBtn.classList.remove('active');
                    gridBtn.classList.add('active');
                } else {
                    feed.classList.remove('grid-view');
                    gridBtn.classList.remove('active');
                    rowBtn.classList.add('active');
                }
            },

            // ===== TOP BRIEF =====
            toggleTopBrief() {
                state.briefCollapsed = !state.briefCollapsed;
                const panel = document.getElementById('topBriefPanel');
                const chevron = document.getElementById('briefPanelChevron');
                
                if (state.briefCollapsed) {
                    panel.classList.add('collapsed');
                    chevron.setAttribute('data-lucide', 'chevron-down');
                } else {
                    panel.classList.remove('collapsed');
                    chevron.setAttribute('data-lucide', 'chevron-up');
                }
                lucide.createIcons();
            },

            renderTopBrief(articles) {
                const container = document.getElementById('briefPanelContent');
                // Don't overwrite if we have a generated synthesis visible (hacky check: if content has tldr-item class)
                if (container.querySelector('.tldr-item') || container.innerHTML.includes('Initializing')) {
                     if (!articles || articles.length === 0) return;

                    // Pick top 3 impactful articles
                    const topPicks = articles
                        .filter(a => a.category !== 'Crypto') // Bias towards main news
                        .slice(0, 3);

                    container.innerHTML = topPicks.map((art, i) => `
                        <div class="tldr-item" onclick="window.open('${art.url}', '_blank')" style="cursor:pointer">
                            <div class="tldr-rank">0${i+1}</div>
                            <div class="tldr-text">
                                <h4>${art.headline}</h4>
                                <div class="tldr-meta">${art.source}  ${new Date(art.datetime*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                            </div>
                        </div>
                    `).join('');
                }
            },

            toggleSettings() {
                document.getElementById('settingsModal').classList.toggle('open');
            },

            clearCache() {
                localStorage.clear();
                location.reload();
            },

            saveSettings() {
                const fKey = document.getElementById('finnhubKey').value;
                const gKey = document.getElementById('geminiKey').value;
                
                state.apiKeys.finnhub = fKey;
                state.apiKeys.gemini = gKey;
                localStorage.setItem('nexus_gemini_key', gKey);
                
                this.toggleSettings();
                notify("Settings Saved", "success");
                this.refreshNews(); 
            },

            toggleCyberpunk(enabled) {
                if(enabled) document.body.classList.add('cyberpunk-mode');
                else document.body.classList.remove('cyberpunk-mode');
                localStorage.setItem('nexus_cyberpunk', enabled);
            },

            async handleSearch(e) {
                if (e.key === 'Enter') {
                    const symbol = e.target.value.toUpperCase();
                    this.loadSymbol(symbol).then(async () => {
                         const quote = await api.getQuote(symbol);
                         if (quote && quote.c) {
                             state.symbols.unshift(symbol);
                             state.symbols = [...new Set(state.symbols)];
                             await this.updateTicker();
                             e.target.value = '';
                             notify(`Tracking ${symbol}`, "success");
                         }
                    });
                }
            },

            async refreshNews() {
                const btn = document.querySelector('.refresh-btn i');
                if(btn) btn.classList.add('fa-spin'); 
                
                notify("Scanning Intel Feeds...", "info");
                
                await api.getAllNews();
                
                this.renderFeed();
                if(btn) btn.classList.remove('fa-spin');
                notify("Intel Updated", "success");
            },

            async updateTicker() {
                const track = document.getElementById('tickerTrack');
                const list = document.getElementById('watchlist');
                track.innerHTML = '';
                list.innerHTML = '';

                let heatmapData = [];

                for (const sym of state.symbols) {
                    const quote = await api.getQuote(sym);
                    if (!quote || !quote.c) continue;
                    
                    state.quotes[sym] = quote;
                    
                    const changeClass = quote.d >= 0 ? 'text-green' : 'text-red';
                    const icon = quote.d >= 0 ? '' : '';

                    heatmapData.push({
                        x: sym,
                        y: Math.abs(quote.dp).toFixed(2),
                        fillColor: quote.d >= 0 ? '#00ff9d' : '#ff2a6d'
                    });

                    const tItem = document.createElement('div');
                    tItem.className = 'ticker-item mono';
                    tItem.innerHTML = `<span class="text-muted">${sym}</span> <span class="${changeClass}">${quote.c.toFixed(2)} ${icon} ${Math.abs(quote.dp).toFixed(2)}%</span>`;
                    tItem.onclick = () => this.loadSymbol(sym);
                    track.appendChild(tItem);

                    const wItem = document.createElement('div');
                    wItem.className = 'watchlist-item';
                    wItem.style.cssText = `display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer; ${sym === state.currentSymbol ? 'background:rgba(255,255,255,0.05); border-left: 2px solid var(--neon-green);' : ''}`;
                    wItem.innerHTML = `
                        <div><div style="font-weight:700">${sym}</div></div>
                        <div style="text-align:right"><div class="mono">${quote.c.toFixed(2)}</div><div class="${changeClass}" style="font-size:0.75rem">${quote.dp.toFixed(2)}%</div></div>
                    `;
                    wItem.onclick = () => this.loadSymbol(sym);
                    list.appendChild(wItem);
                }
                
                if(track.children.length > 0) {
                    Array.from(track.children).forEach(c => track.appendChild(c.cloneNode(true)));
                }

                this.renderHeatmap(heatmapData);
            },

            renderHeatmap(data) {
                if(state.heatmap) state.heatmap.destroy();
                if(data.length === 0) return;

                const options = {
                    series: [{ data: data }],
                    chart: { type: 'treemap', height: 180, toolbar: {show:false}, background: 'transparent' },
                    colors: ['#00ff9d', '#ff2a6d'],
                    plotOptions: { treemap: { distributed: true, enableShades: false, useFillColorAsStroke: true } },
                    dataLabels: { enabled: true, style: { fontSize: '10px', fontFamily: 'JetBrains Mono' } },
                    stroke: { show: true, width: 1, colors: ['#0e0e12'] }
                };
                
                state.heatmap = new ApexCharts(document.querySelector("#heatmap"), options);
                state.heatmap.render();
            },

            setFeedFilter(filter) {
                state.activeFilter = filter;
                document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');
                this.renderFeed();
            },

            renderFeed() {
                const container = document.getElementById('newsFeed');
                container.innerHTML = '';
                
                let articles = [];

                if (state.activeFilter === 'all') {
                    articles = [...state.newsCache.general, ...state.newsCache.tech].sort((a,b) => b.datetime - a.datetime);
                } else if (state.activeFilter === 'crypto') {
                    articles = (state.newsCache.crypto || []).map(a => ({
                        headline: a.title, summary: a.body.substring(0, 150)+'...', url: a.url, source: a.source, datetime: a.published_on, category: 'Crypto'
                    }));
                } else {
                    articles = state.newsCache[state.activeFilter] || [];
                }

                // Update Brief with current context if not showing synthesis
                if (!document.querySelector('.synth-btn i.fa-spin')) {
                    this.renderTopBrief(articles);
                }

                if (!articles || articles.length === 0) {
                    container.innerHTML = `<div class="text-muted" style="padding:20px; text-align:center;">NO INTEL FOUND FOR CHANNEL: ${state.activeFilter.toUpperCase()}</div>`;
                    return;
                }

                articles.slice(0, 25).forEach((art, idx) => {
                    const text = (art.headline + ' ' + art.summary).toLowerCase();
                    let sentiment = 'neutral';
                    if (text.includes('surge') || text.includes('record') || text.includes('soar') || text.includes('grow')) sentiment = 'bullish';
                    else if (text.includes('drop') || text.includes('plunge') || text.includes('warn') || text.includes('crash')) sentiment = 'bearish';

                    const div = document.createElement('div');
                    div.className = `news-card ${sentiment}`;
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#666; margin-bottom:5px;">
                            <span>${art.source.toUpperCase()}</span>
                            <span>${new Date(art.datetime*1000).toLocaleTimeString()}</span>
                        </div>
                        <div class="news-headline" onclick="window.open('${art.url}', '_blank')">${art.headline}</div>
                        <div class="news-summary">${art.summary}</div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="tag" style="background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:3px; font-size:0.7rem;">${state.activeFilter.toUpperCase()}</span>
                            <button class="analyze-btn" id="btn-${idx}" onclick="api.summarizeWithGemini('${art.headline.replace(/'/g, "")}', '${idx}')">
                                <i data-lucide="sparkles" width="12"></i> ANALYZE
                            </button>
                        </div>
                        <div class="ai-summary-box" id="box-${idx}"></div>
                    `;
                    container.appendChild(div);
                });
                lucide.createIcons();
            },

            toggleChartType(type) {
                state.chartType = type;
                document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
                const btns = document.querySelectorAll('.chart-btn');
                if(type === 'candlestick' && btns[0]) btns[0].classList.add('active');
                if(type === 'line' && btns[1]) btns[1].classList.add('active');
                if(type === 'area' && btns[2]) btns[2].classList.add('active');
                
                if (state.currentCandles) {
                    this.renderChart(state.currentCandles);
                }
            },

            async loadSymbol(symbol) {
                state.currentSymbol = symbol;
                
                if (state.chart) {
                    state.chart.destroy();
                    state.chart = null;
                }
                const chartContainer = document.getElementById('mainChart');
                chartContainer.innerHTML = `
                    <div style="text-align:center;">
                        <i data-lucide="loader-2" class="fa-spin" style="margin-bottom:10px;"></i>
                        <div>ANALYZING ASSET...</div>
                    </div>
                `;
                lucide.createIcons();

                const quote = await api.getQuote(symbol);
                if (quote) {
                    document.getElementById('detailSymbol').innerText = symbol;
                    document.getElementById('detailPrice').innerText = quote.c.toFixed(2);
                    document.getElementById('detailChange').innerHTML = `<span class="${quote.d >= 0 ? 'text-green' : 'text-red'}">${quote.d.toFixed(2)} (${quote.dp.toFixed(2)}%)</span>`;
                    
                    document.getElementById('metricHigh').innerText = quote.h.toFixed(2);
                    document.getElementById('metricLow').innerText = quote.l.toFixed(2);
                }
                
                const profile = await api.getProfile(symbol);
                if(profile && profile.name) {
                    document.getElementById('detailName').innerText = profile.name;
                    const card = document.getElementById('assetProfile');
                    const logo = document.getElementById('pLogo');
                    
                    if(profile.logo) {
                        logo.src = profile.logo;
                        logo.style.display = 'block';
                    } else {
                        logo.style.display = 'none';
                    }
                    
                    document.getElementById('pName').innerText = profile.name;
                    document.getElementById('pIndustry').innerText = profile.finnhubIndustry;
                    document.getElementById('metricCap').innerText = (profile.marketCapitalization / 1000).toFixed(2) + 'B';
                    document.getElementById('metricVol').innerText = (profile.shareOutstanding).toFixed(1) + 'M';
                    card.style.display = 'flex';
                } else {
                    document.getElementById('assetProfile').style.display = 'none';
                }

                const candles = await api.getCandles(symbol);
                if (candles && candles.s === 'ok') {
                    state.currentCandles = candles; 
                    this.renderChart(candles);
                } else {
                    chartContainer.innerHTML = `
                        <div style="text-align:center; color: var(--neon-red);">
                            <i data-lucide="alert-octagon" style="margin-bottom:10px;"></i>
                            <div>DATA UNAVAILABLE</div>
                            <div style="font-size:0.7rem; color:var(--text-muted);">API LIMIT OR INVALID SYMBOL</div>
                        </div>
                    `;
                    lucide.createIcons();
                }
            },

            renderChart(candles) {
                if (!candles || candles.s !== 'ok' || !candles.t) return;

                const chartEl = document.querySelector("#mainChart");
                chartEl.innerHTML = ""; 

                let seriesData = [];
                let chartOptions = {
                    chart: { type: state.chartType, height: 250, background: 'transparent', toolbar: { show: false }, animations: { enabled: false } },
                    theme: { mode: 'dark' },
                    xaxis: { type: 'datetime', axisBorder: {show:false}, axisTicks: {show:false}, labels: { style: { colors: '#888899' } } },
                    yaxis: { labels: { style: { colors: '#888899' } } },
                    grid: { borderColor: '#2a2a35', strokeDashArray: 4 },
                    stroke: { width: 2, curve: 'smooth' },
                    tooltip: { theme: 'dark' }
                };

                if (state.chartType === 'candlestick') {
                    seriesData = candles.t.map((t, i) => ({
                        x: new Date(t * 1000),
                        y: [candles.o[i], candles.h[i], candles.l[i], candles.c[i]]
                    }));
                    chartOptions.plotOptions = { candlestick: { colors: { upward: '#00ff9d', downward: '#ff2a6d' } } };
                } else {
                    seriesData = candles.t.map((t, i) => ({
                        x: new Date(t * 1000),
                        y: candles.c[i] 
                    }));
                    chartOptions.colors = ['#00ff9d'];
                    if (state.chartType === 'area') {
                        chartOptions.fill = {
                             type: 'gradient',
                             gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.1, stops: [0, 90, 100] }
                        };
                    }
                }

                chartOptions.series = [{ name: 'Price', data: seriesData }];
                
                try {
                    state.chart = new ApexCharts(chartEl, chartOptions);
                    state.chart.render();
                } catch(e) {
                    console.error("Chart Render Fail:", e);
                    chartEl.innerHTML = "CHART RENDER ERROR";
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
